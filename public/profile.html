<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <script src="/admin/auth.js" defer></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:1600px;margin:0 auto;color:#fff;padding:10px 20px 80px;}

    .profile-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:30px;flex-wrap:wrap;}
    .status-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
    .status-ok{background:#10331f;border-color:#1f7a46;color:#a6ffcb}
    .status-snap{background:#2b2410;border-color:#8a6d1f;color:#ffd666}
    .status-bad{background:#3a1414;border-color:#8a1f1f;color:#ffb3b3}

    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}

    /* ê¸°ë³¸ ì •ë³´ ê·¸ë¦¬ë“œ(ë°˜ì‘í˜•) */
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;min-width:0;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;word-break:break-word;overflow-wrap:anywhere;}

    @media (max-width:1024px){ .profile-wrapper{padding:10px 16px 64px;} }
    @media (max-width:720px) { .profile-card{padding:22px;} .actions{flex-wrap:wrap;} }
    @media (max-width:480px){ .profile-card{padding:18px;} }

    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:4px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.25s;will-change:transform,box-shadow;}
    .btn:hover{background:#00897B;transform:translateY(-2px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25);}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
    .pill{ background:#004d40; color:#FFD700; border:2px solid #FFD700; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.25s; }
    .pill:hover{ transform:translateY(-2px) scale(1.04); box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25); }

    /* íŒ¨ë„(ì£¼ë¬¸/ìƒì„¸) */
    #orderPanel, #orderDetailPanel{ position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,0.65); align-items:stretch; justify-content:flex-end; }
    #orderPanel.show, #orderDetailPanel.show{ display:flex; }
    #orderSheet, #orderDetailSheet{ width:min(720px, 96vw); background:linear-gradient(135deg,#102522 80%,#1d4d46 100%); height:100%; overflow:auto; box-shadow:0 0 32px #000; border-left:1px solid #1d4d46; transform:translateX(100%); transition:transform .28s ease; }
    #orderPanel.show #orderSheet, #orderDetailPanel.show #orderDetailSheet{ transform:translateX(0); }
    .sheet-close{ position:sticky; top:0; display:flex; justify-content:flex-end; padding:12px; background:linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); }
    .sheet-body{ padding:8px 22px 24px 22px; color:#fff; }
    .sheet-h{ color:#FFD700; font-size:1.4em; margin:8px 0 14px; text-align:left; letter-spacing:.5px; }

    .kpi{ background:#0c1a18; border-radius:10px; padding:12px 16px; margin:10px 0; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .lab{ color:#FFD700; font-weight:600; }
    .val{ font-size:1.15em; }

    .pill-wrap{ display:flex; gap:10px; flex-wrap:wrap; }

    /* ì£¼ì†Œ í¼ ê·¸ë¦¬ë“œ */
    .addr-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px 14px; margin-top:12px; align-items:start; }
    .addr-grid label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:#FFD700; font-weight:700; background:#0c1a18; padding:12px 14px; border-radius:10px; }
    .addr-grid input, .addr-grid textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:8px; border:1px solid #1e4d47; background:#071412; color:#fff; box-sizing:border-box; }
    .addr-row{ display:flex; gap:8px; align-items:center; }
    .addr-row input{ flex:1; }
    .addr-help{ font-size:12px; color:#9bd3ff; margin-top:4px; }
    .sheet-actions .btn{ width:100%; margin-top:12px; font-size:1.08em; }

    .home-icon{display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;}
    .home-icon span{font-size:30px;color:#FFD700;}

    #summaryLine{display:none;}
    .mini-hint{font-size:12px;color:#9bd3ff;margin:8px 0 0;}
    .mini-err{font-size:12px;color:#ff9b9b;margin:8px 0 0;}

    /* ë¬¸ì˜ ì•„ì´í…œ */
    .msg-item{background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:10px;cursor:pointer;}
    .msg-item .body{margin-top:6px;}
    .msg-item .answer{display:none;margin-top:6px;padding:8px 10px;background:#08221f;border:1px solid #1e4d47;border-radius:8px;}
    .msg-item.open .answer{display:block;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><a href="index.html" id="homeLogo"><img src="img/logo.png" alt="ê³¨ë“œìŠ¤íƒ€ ë¡œê³ " style="height:52px;"></a></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <a href="index.html" class="home-icon" aria-label="í™ˆ"><span>ğŸ </span></a>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader">
        <div>
          <h1 style="font-size:30px;color:#4fc3f7;margin:0 0 6px;">ë‚´ ì •ë³´</h1>
          <div id="summaryLine"></div>
          <div id="sessionHint" class="mini-hint" style="display:none;"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <span id="sessionChip" class="status-chip status-bad">ì„¸ì…˜: ì—†ìŒ</span>
          <div class="actions">
            <button class="btn" id="addOrderBtn">ì£¼ë¬¸ ì¶”ê°€</button>
            <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>

      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="profile-card" id="profileCard" hidden>
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid">
          <div class="orders-empty">ë¡œë”©ì¤‘â€¦</div>
        </div>
      </div>

      <!-- ì£¼ë¬¸ ë‚´ì—­ -->
      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"><div class="orders-empty">ë¡œë”©ì¤‘â€¦</div></div>
        <div id="ordersHint" class="mini-err" style="display:none;"></div>
      </div>

      <!-- 1:1 ë¬¸ì˜ -->
      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"><div class="orders-empty">ë¡œë”©ì¤‘â€¦</div></div>
        <div id="inqHint" class="mini-err" style="display:none;"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:120px;">ë¬¸ì˜ ë“±ë¡</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">ê´€ë¦¬ì ë‹µë³€ì€ ë¬¸ì˜ë¥¼ í´ë¦­í•˜ë©´ ì•„ë˜ë¡œ í¼ì³ì§‘ë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ì£¼ë¬¸ íŒ¨ë„ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>
        <div class="pill-wrap" id="productBtns"></div>
        <div class="kpi row"><span class="lab">ì´ ëˆìˆ˜</span><div class="row" style="gap:10px;"><strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong><button id="resetDon" class="btn danger">ë¦¬ì…‹</button></div></div>
        <div class="kpi"><div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div><div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div></div>
        <div class="kpi"><div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div><div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div></div>
        <div class="kpi"><div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div></div>
        <div class="kpi"><div class="row"><span class="lab">ì…ê¸ˆ ê¸ˆì•¡ (ì´ê¸ˆì•¡ì˜ 50%)</span><strong id="depositAmount" class="val" style="color:#4fc3f7;">-</strong></div><div class="addr-help">(ë‚˜ë¨¸ì§€ 50%ëŠ” ë°°ì†¡ ì‹œì‘ ì „ ì…ê¸ˆ)</div></div>

        <h3 class="sheet-h" style="font-size:1.15em;margin-top:14px;">ë°°ì†¡ì§€ ì •ë³´</h3>
        <div class="addr-grid">
          <label>ìˆ˜ë ¹ì¸ <input id="recvName" placeholder="ì´ë¦„" autocomplete="name"></label>
          <label>ì—°ë½ì²˜ <input id="recvPhone" placeholder="010-1234-5678" autocomplete="tel"></label>
          <label style="grid-column:1 / span 2;">ìš°í¸ë²ˆí˜¸
            <div class="addr-row">
              <input id="postCode" placeholder="ìš°í¸ë²ˆí˜¸" autocomplete="postal-code">
              <button class="btn" id="btnFindPostcode">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
              <button class="btn" id="btnManualPostcode">ì§ì ‘ ì…ë ¥</button>
            </div>
            <div class="addr-help" id="postcodeHelp" style="display:none;"></div>
          </label>
          <label style="grid-column:1 / span 2;">ì£¼ì†Œ(ë„ë¡œëª…/ì§€ë²ˆ) <input id="addr1" placeholder="ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œ" autocomplete="address-line1"></label>
          <label style="grid-column:1 / span 2;">ìƒì„¸ ì£¼ì†Œ <input id="addr2" placeholder="ë™/í˜¸ìˆ˜ ë“± ìƒì„¸" autocomplete="address-line2"></label>
          <label style="grid-column:1 / span 2;">ìš”ì²­ì‚¬í•­ <textarea id="memo" rows="3" placeholder="ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì ì–´ì£¼ì„¸ìš”"></textarea></label>
        </div>
        <div class="sheet-actions"><button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button></div>
      </div>
    </div>
  </div>

  <!-- ì£¼ë¬¸ ìƒì„¸ íŒ¨ë„ -->
  <div id="orderDetailPanel" aria-hidden="true">
    <div id="orderDetailSheet">
      <div class="sheet-close"><button id="closeOrderDetail" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ì£¼ë¬¸ ìƒì„¸</h2>
        <div id="orderDetailBody">ë¡œë”©ì¤‘â€¦</div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    /* ===================== ì„¸ì…˜/ì‹ë³„ì ===================== */
    const ADMIN_KEY = 'admin_session_v1';
    const GS_KEY    = 'gs_user';
    const ID_KEY    = 'gs_identity'; // {uname,email} ê³ ì •

    function setChip(kind,text){
      const chip = $('#sessionChip');
      chip.className = 'status-chip ' + (kind==='ok'?'status-ok':kind==='snap'?'status-snap':'status-bad');
      chip.textContent = 'ì„¸ì…˜: ' + text;
    }

    function getAdminSessionSync(){
      try{ if (window.AdminAuth?.currentSession){ const s = window.AdminAuth.currentSession(); if (s) return s; } }catch(_){}
      try{ const raw = localStorage.getItem(ADMIN_KEY); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
    }
    function getGsSessionSync(){
      try{ if (window.GSApp?.currentUser){ const s = window.GSApp.currentUser(); if (s) return s; } }catch(_){}
      try{ const raw = localStorage.getItem(GS_KEY); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
    }
    async function getAdminSessionAsync(){
      for (let i=0;i<30;i++){ // ~4.5s
        try{ if (window.AdminAuth?.currentSession){ const v = window.AdminAuth.currentSession(); if (v) return v; } }catch(_){}
        await new Promise(r=>setTimeout(r,150));
      }
      return null;
    }
    async function getToken(){
      try{
        if (window.AdminAuth?.getToken){
          const t = window.AdminAuth.getToken();
          return (t && typeof t.then==='function') ? await t : t;
        }
      }catch(_){}
      const s = SESSION || getAdminSessionSync() || getGsSessionSync();
      return s?.token || s?.jwt || s?.idToken || null;
    }
    function deriveUnameFromEmail(mail){ return (mail||'').split('@')[0]||''; }
    function norm(v){ return (v||'').toString().trim(); }

    function getFixedIdentity(){
      try{
        const raw = localStorage.getItem(ID_KEY);
        if (raw) return JSON.parse(raw);
      }catch(_){}
      return { uname:'', email:'' };
    }
    function setFixedIdentity(uname,email){
      try{ localStorage.setItem(ID_KEY, JSON.stringify({uname, email})); }catch(_){}
    }
    function stampLoginMarkers(session){
      try{
        const snap = session || getAdminSessionSync() || getGsSessionSync() || null;
        if (snap){
          localStorage.setItem('gs_user', JSON.stringify(snap));
          localStorage.setItem('gs_user_backup', JSON.stringify(snap));
          localStorage.setItem('gs_logged_in','1');
        }
      }catch(_){}
    }
    $('#homeLogo')?.addEventListener('click', e=>{ e.preventDefault(); stampLoginMarkers(); location.href='index.html'; });
    document.querySelector('.home-icon')?.addEventListener('click', ()=>{ stampLoginMarkers(); });

    /* ===================== ê³µí†µ fetch/KV íŒŒì„œ ===================== */
    async function fetchJSON(url, init={}){
      const token = await getToken().catch(()=>null);
      const hdr = new Headers(init.headers || {});
      if (token && !hdr.has('Authorization')) hdr.set('Authorization','Bearer '+token);
      if (!hdr.has('Accept')) hdr.set('Accept','application/json, text/plain, */*');

      let resp;
      try{ resp = await fetch(url, { cache:'no-store', credentials:'include', ...init, headers: hdr }); }
      catch(e){ return { ok:false, error:String(e) }; }

      const ct = resp.headers.get('Content-Type')||'';
      if (!resp.ok){
        let raw = ''; try{ raw = await resp.text(); }catch(_){}
        return { ok:false, status:resp.status, contentType:ct, raw };
      }
      if (!/application\/json/i.test(ct)){
        let raw = ''; try{ raw = await resp.text(); }catch(_){}
        return { ok:false, status:200, contentType:ct, raw };
      }
      const json = await resp.json().catch(()=>null);
      return json ? { ok:true, json } : { ok:false, status:200, contentType:ct };
    }
    async function safeDecrypt(payload){
      try{
        if(!payload) return [];
        const r = window.decrypt ? window.decrypt(payload) : payload;
        return (r && typeof r.then==='function') ? await r : r;
      }catch{ return []; }
    }
    async function safeEncrypt(arr){
      try{
        if (!window.encrypt) return arr;
        const r = window.encrypt(arr);
        return (r && typeof r.then==='function') ? await r : r;
      }catch{ return arr; }
    }
    async function kvToArray(payload){
      try{
        if (!payload) return [];
        if (Array.isArray(payload)) return payload;
        let cand = payload?.data ?? payload?.list ?? payload?.items ?? payload?.values ??
                   payload?.value ?? payload?.records ?? payload?.result ?? payload?.results;
        if (!cand && typeof payload === 'object') {
          for (const k of Object.keys(payload)){ if (Array.isArray(payload[k])) { cand = payload[k]; break; } }
        }
        if (Array.isArray(cand)) return cand;
        const maybeMap = cand || payload;
        if (maybeMap && typeof maybeMap === 'object' && !Array.isArray(maybeMap)) {
          const vals = Object.values(maybeMap);
          if (vals.length && vals.every(v => typeof v === 'object')) return vals;
        }
        async function tryString(str){
          try{ const j = JSON.parse(str); if (Array.isArray(j)) return j; if (Array.isArray(j?.data)) return j.data; }catch{}
          if (window.decrypt){
            const dec = await window.decrypt(str);
            try{ const j2 = JSON.parse(dec); if (Array.isArray(j2)) return j2; if (Array.isArray(j2?.data)) return j2.data; }catch{}
          }
          return null;
        }
        if (typeof cand === 'string'){ const r = await tryString(cand); if (r) return r; }
        if (typeof payload?.data === 'string'){ const r = await tryString(payload.data); if (r) return r; }
        if (typeof payload === 'string'){ const r = await tryString(payload); if (r) return r; }
        return [];
      }catch{ return []; }
    }
    async function kvSaveArray(url, list){
      const body1 = { data: await safeEncrypt(list) };
      const opt = (raw)=>({ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(raw) });
      let r = await fetchJSON(url, opt(body1));
      if (!r.ok) r = await fetchJSON(url, opt(list));
      if (!r.ok) throw new Error('save failed: '+url);
    }
    const fmt = n => Number(n||0).toLocaleString('ko-KR');

    /* ===================== ìƒíƒœ/ìºì‹œ ===================== */
    let SESSION = null;
    let CURRENT_USER = null;
    let FIXED_ID = getFixedIdentity(); // {uname,email}
    let supplyPrice = 520000, currentPrice = 0;

    const LOADED = { profile:false, orders:false, inq:false };
    const CACHE  = { orders:[], inquiries:[] };

    function myMatch(item){
      const uname = norm(FIXED_ID.uname);
      const mail  = norm(FIXED_ID.email).toLowerCase();
      const ufields = [item.user, item.username, item.member, item.uid, item.userId, item.userid];
      const mfields = [item.email, item.userEmail];
      const hitUser = ufields.some(v => norm(v) === uname);
      const hitMail = mfields.some(v => norm(v).toLowerCase() === mail);
      return (!!uname && hitUser) || (!!mail && hitMail);
    }
    function firstDateLike(o){
      const cands = [o.date, o.created, o.createdAt, o.timestamp, o.time, o.ts];
      for (const v of cands){
        if (!v && v!==0) continue;
        if (typeof v === 'number') return new Date(v).toLocaleString('ko-KR');
        const d = new Date(v); if (!isNaN(+d)) return d.toLocaleString('ko-KR');
      }
      return '-';
    }

    /* ===================== USERS ===================== */
    async function fetchUsersAll(){ const r = await fetchJSON('/api/users'); return r.ok ? await kvToArray(r.json) : []; }

    function renderProfileSummary(u){
      const sum = $('#summaryLine'); if (sum) sum.textContent = `${u.name||''} (${u.username||''})`;
    }
    function renderProfileGrid(u){
      const grid = $('#profileGrid'), card = $('#profileCard');
      card.hidden = false; grid.innerHTML = '';
      const fields = [
        ['ì´ë¦„', u.name||'-'],
        ['ì•„ì´ë””', u.username||'-'],
        ['ì—°ë½ì²˜', u.phone||'-'],
        ['ì´ë©”ì¼', u.email||'-'],
        ['ì€í–‰', u.bank||'-'],
        ['ê³„ì¢Œë²ˆí˜¸', u.account||'-'],
        ['ê°€ì…ì¼', u.created ? new Date(u.created).toLocaleString('ko-KR') : '-'],
        ['ìƒíƒœ', u.status||'-']
      ];
      for(const [l,v] of fields){
        const div = document.createElement('div');
        div.className='field';
        div.innerHTML = `<label>${l}</label><span>${v}</span>`;
        grid.appendChild(div);
      }
      LOADED.profile = true;
    }

    async function loadCurrentUser(){
      // 1) í˜„ì¬ ì„¸ì…˜ì—ì„œ uname/email ê³ ì •
      const unameNow = norm(SESSION?.username || SESSION?.user || deriveUnameFromEmail(SESSION?.email));
      const emailNow = norm(SESSION?.email);
      if (unameNow || emailNow){
        FIXED_ID = { uname: unameNow, email: emailNow };
        setFixedIdentity(FIXED_ID.uname, FIXED_ID.email);
        setChip('ok','ì •ìƒ');
      }else{
        const snap = getFixedIdentity();
        if (snap.uname || snap.email){
          FIXED_ID = snap;
          setChip('snap','ìŠ¤ëƒ…ìƒ·');
        }else{
          setChip('bad','ì—†ìŒ');
        }
      }

      // 2) USERSì—ì„œ ìƒì„¸ ì •ë³´ ì°¾ê¸°(ì—†ìœ¼ë©´ ì„¸ì…˜ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì±„ì›€)
      const users = await fetchUsersAll();
      const byU = users.find(u => norm(u.username) === norm(FIXED_ID.uname));
      const byE = users.find(u => norm(u.email).toLowerCase() === norm(FIXED_ID.email).toLowerCase());
      CURRENT_USER = byU || byE || {
        username: FIXED_ID.uname || '-',
        name: SESSION?.name || SESSION?.displayName || '-',
        email: FIXED_ID.email || '-',
        phone: SESSION?.phone || '-',
        role: 'user',
        created: SESSION?.created || Date.now()
      };
      renderProfileSummary(CURRENT_USER);
      renderProfileGrid(CURRENT_USER);
      stampLoginMarkers(SESSION || CURRENT_USER);
    }

    /* ===================== GOLD ===================== */
    async function loadGoldPrice(){
      try{
        const r = await fetchJSON('/api/security?type=goldprice');
        if (r.ok){
          const j = r.json; const manual = j?.manualGoldPrice ? Number(j.manualGoldPrice) : 0;
          if(manual>0){ currentPrice = manual; return; }
        }
      }catch(_){}
      try{
        const d = await fetch('https://gold-price-proxy.hanoiosaka1.workers.dev/price').then(r=>r.json());
        if(d?.price) currentPrice = Number(d.price);
      }catch(_){}
    }

    /* ===================== ORDERS ===================== */
    async function fetchOrdersAll(){ const r = await fetchJSON('/api/orders'); return r.ok ? await kvToArray(r.json) : []; }
    function renderOrdersTable(list){
      const el = $('#ordersContainer');
      if(!list.length){ if(!LOADED.orders) el.innerHTML = '<div class="orders-empty">ì—†ìŒ</div>'; return; }
      el.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€(ì›)</th><th>ì´ê¸ˆì•¡(ì›)</th><th>ì…ê¸ˆê¸ˆì•¡(50%)</th><th>ìƒíƒœ</th><th>ì¼ì‹œ</th>' +
        '</tr></thead><tbody>' +
        list.map(o=>{
          const don = Number(o.don||o.qty||0);
          const sup = Number(o.supplyPrice||supplyPrice||0);
          const total = Number(o.totalPrice || (don*sup));
          const deposit = Math.round(total*0.5);
          const ts = firstDateLike(o);
          return `<tr class="order-row" data-id="${o.id||''}">
            <td>${o.id||'-'}</td>
            <td>ê³¨ë“œë°”</td>
            <td style="text-align:right;">${don}</td>
            <td style="text-align:right;">${fmt(sup)}</td>
            <td style="text-align:right;">${fmt(total)}</td>
            <td style="text-align:right;">${fmt(deposit)}</td>
            <td>${o.status||'-'}</td>
            <td>${ts}</td>
          </tr>`;
        }).join('') + '</tbody></table>';
      LOADED.orders = true;
      // ìƒì„¸ ì´ë²¤íŠ¸ ìœ„ì„(í•œ ë²ˆë§Œ ë°”ì¸ë”©)
      if (!el._bound){
        el._bound = true;
        el.querySelector('tbody').addEventListener('click', (e)=>{
          const tr = e.target.closest('tr.order-row'); if(!tr) return;
          const id = tr.getAttribute('data-id');
          const o = CACHE.orders.find(x=>String(x.id)===String(id)) || {};
          const don = Number(o.don||o.qty||0);
          const sup = Number(o.supplyPrice||supplyPrice||0);
          const total = Number(o.totalPrice || (don*sup));
          const deposit = Math.round(total*0.5);
          const addr = o.address||{};
          const html = `
            <div class="kpi"><div class="row"><span class="lab">ì£¼ë¬¸ë²ˆí˜¸</span><strong class="val">${o.id||'-'}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ì£¼ë¬¸ì</span><strong class="val">${o.name||CURRENT_USER?.name||'-'} / ${o.phone||CURRENT_USER?.phone||'-'}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ëˆìˆ˜</span><strong class="val">${don}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ê³µê¸‰ê°€</span><strong class="val">${fmt(sup)}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ì´ê¸ˆì•¡</span><strong class="val">${fmt(total)}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ì…ê¸ˆê¸ˆì•¡(50%)</span><strong class="val">${fmt(deposit)}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ìƒíƒœ</span><strong class="val">${o.status||'-'}</strong></div></div>
            <div class="kpi"><div class="row"><span class="lab">ì£¼ë¬¸ì¼ì‹œ</span><strong class="val">${firstDateLike(o)}</strong></div></div>
            <div class="kpi">
              <div class="lab" style="margin-bottom:6px;">ë°°ì†¡ì§€</div>
              <div>(${addr.postCode||'-'}) ${addr.addr1||'-'} ${addr.addr2||''}</div>
              <div>ìˆ˜ë ¹ì¸: ${addr.recvName||'-'} / ${addr.recvPhone||'-'}</div>
              ${o.memo? `<div class="mini-hint" style="margin-top:6px;">ìš”ì²­ì‚¬í•­: ${o.memo}</div>`:''}
            </div>`;
          openOrderDetailPanel(html);
        });
      }
    }
    async function refreshOrders(){
      const all = await fetchOrdersAll();
      const mine = all.filter(myMatch);
      if (mine.length){ CACHE.orders = mine; renderOrdersTable(mine); }
      else if (!LOADED.orders){ renderOrdersTable([]); } // ì´ˆê¸°ë§Œ ë¹ˆí‘œì‹œ, ì´í›„ì—” ìœ ì§€
    }

    /* ===================== INQUIRIES ===================== */
    async function fetchInquiriesAll(){ const r = await fetchJSON('/api/inquiries'); return r.ok ? await kvToArray(r.json) : []; }
    function buildAnswerBlock(m){
      const answerText = m.answer || m.adminAnswer || m.reply || m.adminReply || m.response || '';
      if (!answerText) return '';
      return `<div class="answer"><strong style="color:#FFD700;">[ë‹µë³€]</strong> ${answerText}</div>`;
    }
    function renderInquiries(list){
      const wrap = $('#messagesWrap');
      if(!list.length){ if(!LOADED.inq) wrap.innerHTML = '<div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      wrap.innerHTML = list.slice().reverse().map(m=>{
        const hasAnswer = !!(m.answer || m.adminAnswer || m.reply || m.adminReply || m.response);
        const status = hasAnswer ? 'ë‹µë³€ì™„ë£Œ' : (m.status || 'ë¯¸ë‹µë³€');
        return `
        <div class="msg-item" data-id="${m.id||''}">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:600;">${m.title||'1:1 ë¬¸ì˜'}</div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${status==='ë‹µë³€ì™„ë£Œ'?'#2e7d32':(status==='ë¯¸ë‹µë³€'?'#b71c1c':'#455a64')};color:#fff;white-space:nowrap;">${status}</span>
          </div>
          <div class="body">${(m.content||m.message||'').replace(/\n/g,'<br>')}</div>
          ${buildAnswerBlock(m)}
          <div style="font-size:11px;color:#888;margin-top:6px;">${firstDateLike(m)}</div>
        </div>`;
      }).join('');
      LOADED.inq = true;
      if (!wrap._bound){
        wrap._bound = true;
        wrap.addEventListener('click', (e)=>{
          const item = e.target.closest('.msg-item'); if (!item) return;
          item.classList.toggle('open');
        });
      }
    }
    async function refreshInquiries(){
      const all  = await fetchInquiriesAll();
      const mine = all.filter(myMatch);
      if (mine.length){ CACHE.inquiries = mine; renderInquiries(mine); }
      else if (!LOADED.inq){ renderInquiries([]); } // ì´ˆê¸°ë§Œ ë¹ˆí‘œì‹œ, ì´í›„ì—” ìœ ì§€
    }

    /* ===================== ì£¼ë¬¸ íŒ¨ë„/ìš°í¸ë²ˆí˜¸ ===================== */
    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon = 0; updateOrderCalc(); loadGoldPrice().then(updateOrderCalc); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }
    function openOrderDetailPanel(html){ $('#orderDetailBody').innerHTML = html || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; $('#orderDetailPanel').classList.add('show'); }
    function closeOrderDetailPanel(){ $('#orderDetailPanel').classList.remove('show'); }
    $('#closeOrderDetail').addEventListener('click', closeOrderDetailPanel);

    const productList = [0.5,1,2,3,5,10];
    let totalDon = 0;
    const btnWrap = $('#productBtns'); btnWrap.innerHTML='';
    productList.forEach(don=>{ const b=document.createElement('button'); b.className='pill'; b.textContent = `${don}ëˆ`; b.addEventListener('click', ()=>{ totalDon += don; updateOrderCalc(); }); btnWrap.appendChild(b); });
    $('#addOrderBtn')?.addEventListener('click', openOrderPanel);
    $('#closeOrderPanel')?.addEventListener('click', closeOrderPanel);
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    function updateOrderCalc(){
      $('#totalDon').textContent = totalDon;
      $('#supplyPrice').textContent = fmt(supplyPrice);
      $('#currentPrice').textContent = fmt(currentPrice||0);
      const totalPrice   = totalDon * supplyPrice;
      const currentTotal = totalDon * (currentPrice||0);
      $('#totalPrice').textContent   = fmt(totalPrice);
      $('#currentTotal').textContent = fmt(currentTotal);
      $('#priceDiff').textContent    = fmt(currentTotal - totalPrice);
      $('#depositAmount').textContent= fmt(Math.round(totalPrice*0.5));
      const requiredAddr = ($('#postCode').value.trim() && $('#addr1').value.trim());
      $('#orderSubmit').disabled = !(totalDon>0 && requiredAddr);
    }

    let postcodeManual = false;
    async function ensureDaumPostcodeScript(){
      if(window.daum && window.daum.Postcode) return true;
      return new Promise((resolve)=>{
        const s = document.createElement('script');
        s.src = "https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        s.onload = ()=>resolve(true); s.onerror = ()=>resolve(false); document.head.appendChild(s);
      });
    }
    async function openPostcode(){
      $('#postcodeHelp').style.display='none';
      if(postcodeManual){ alert('í˜„ì¬ ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const ok = await ensureDaumPostcodeScript();
      if(!ok){ $('#postcodeHelp').style.display='block'; $('#postcodeHelp').textContent = 'ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨. í•„ìš” ì‹œ "ì§ì ‘ ì…ë ¥"ì„ ì‚¬ìš©í•˜ì„¸ìš”.'; return; }
      try{
        new daum.Postcode({
          oncomplete: function(data){
            $('#postCode').value = data.zonecode||'';
            $('#addr1').value = data.roadAddress || data.jibunAddress || '';
            updateOrderCalc();
          }, width:'100%', height:'100%'
        }).open();
      }catch(e){
        $('#postcodeHelp').style.display='block'; $('#postcodeHelp').textContent = 'ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì ‘ì† ì‹¤íŒ¨. "ì§ì ‘ ì…ë ¥"ì„ ì‚¬ìš©í•˜ì„¸ìš”.';
      }
    }
    $('#btnFindPostcode').addEventListener('click', openPostcode);
    $('#btnManualPostcode').addEventListener('click', ()=>{
      postcodeManual = !postcodeManual;
      $('#btnManualPostcode').textContent = postcodeManual ? 'ìë™ê²€ìƒ‰ ì‚¬ìš©' : 'ì§ì ‘ ì…ë ¥';
      $('#postcodeHelp').style.display='block';
      $('#postcodeHelp').textContent = postcodeManual ? 'ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œë¥¼ ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”.' : 'ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ëª¨ë“œì…ë‹ˆë‹¤.';
    });
    ;['postCode','addr1','addr2','recvName','recvPhone','memo'].forEach(id=>$('#'+id).addEventListener('input', updateOrderCalc));

    $('#orderSubmit')?.addEventListener('click', async ()=>{
      // ê³ ì • ì‹ë³„ìë¡œ ì €ì¥ (ì„¸ì…˜ ì§€ì—°ë˜ì–´ë„ ê°€ëŠ¥)
      const uname = norm(FIXED_ID.uname) || deriveUnameFromEmail(FIXED_ID.email);
      if(!uname){ alert('ë¡œê·¸ì¸ ì„¸ì…˜ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.'); return; }
      if(totalDon<=0){ alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if(!$('#postCode').value.trim() || !$('#addr1').value.trim()){ alert('ë°°ì†¡ì§€(ìš°í¸ë²ˆí˜¸/ì£¼ì†Œ)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

      const order = {
        id:'O'+Date.now(),
        date:new Date().toISOString(),
        user: uname, username: uname,
        name: CURRENT_USER?.name, email: CURRENT_USER?.email, phone: CURRENT_USER?.phone,
        don: totalDon, supplyPrice, currentPrice,
        totalPrice: totalDon*supplyPrice, depositAmount: Math.round(totalDon*supplyPrice*0.5),
        address: {
          postCode: $('#postCode').value.trim(),
          addr1: $('#addr1').value.trim(),
          addr2: $('#addr2').value.trim(),
          recvName: $('#recvName').value.trim(),
          recvPhone: $('#recvPhone').value.trim(),
        },
        memo: $('#memo').value.trim(),
        status: 'ê²°ì œëŒ€ê¸°'
      };
      const all = await fetchOrdersAll(); all.push(order); await kvSaveArray('/api/orders', all);
      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderPanel();
      await refreshOrders();
    });

    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      const uname = norm(FIXED_ID.uname) || deriveUnameFromEmail(FIXED_ID.email);
      if(!uname){ alert('ë¡œê·¸ì¸ ì„¸ì…˜ ì˜¤ë¥˜'); return; }
      const txt = $('#msgInput').value.trim(); if(!txt) return;

      const nowTs = Date.now();
      const newInquiry = {
        id:'Q'+nowTs,
        user: uname, username: uname,
        email: CURRENT_USER?.email, phone: CURRENT_USER?.phone,
        title:'1:1 ë¬¸ì˜', content: txt, ts: nowTs, date: new Date(nowTs).toISOString(),
        status:'ë¯¸ë‹µë³€'
      };
      const all = await fetchInquiriesAll(); all.push(newInquiry); await kvSaveArray('/api/inquiries', all);
      $('#msgInput').value = '';
      alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      await refreshInquiries();
    });

    $('#logoutBtn')?.addEventListener('click', ()=>{
      if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ AdminAuth?.logout?.(); }catch(_){}
      try{
        localStorage.removeItem('admin_session_v1');
        localStorage.removeItem('gs_user');
        localStorage.removeItem('gs_user_backup');
        localStorage.removeItem('gs_logged_in');
        localStorage.removeItem('gs_identity');
        localStorage.setItem('gs_logout', String(Date.now()));
      }catch(_){}
      location.href='index.html';
    });

    /* ===================== ì´ˆê¸°í™” ===================== */
    (async function init(){
      const hint = $('#sessionHint');

      // Fast-path ì„¸ì…˜ í™•ë³´
      SESSION = getAdminSessionSync() || getGsSessionSync();
      if (SESSION){ setChip('ok','ì •ìƒ'); localStorage.setItem('gs_logged_in','1'); }
      else {
        // ìŠ¤ëƒ…ìƒ·ë§Œ ìˆì„ ìˆ˜ ìˆìŒ
        const snap = getFixedIdentity();
        if (snap.uname || snap.email){ setChip('snap','ìŠ¤ëƒ…ìƒ·'); }
        else setChip('bad','ì—†ìŒ');
        hint.style.display='block'; hint.textContent='ì„¸ì…˜ í™•ì¸ì¤‘â€¦';
      }

      // í˜„ì¬ ì„¸ì…˜/ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì¦‰ì‹œ ë Œë”
      await loadCurrentUser();
      await loadGoldPrice();
      await Promise.all([refreshOrders(), refreshInquiries()]);
      hint.style.display='none';

      // AdminAuthê°€ ëŠ¦ê²Œ ì¤€ë¹„ë˜ë©´ ê°±ì‹ 
      if (!SESSION){
        const late = await getAdminSessionAsync();
        if (late){
          SESSION = late; setChip('ok','ì •ìƒ'); stampLoginMarkers(late);
          await loadCurrentUser();
          await Promise.all([refreshOrders(), refreshInquiries()]);
        }
        hint.style.display='none';
      }

      // ì£¼ê¸° ìƒˆë¡œê³ ì¹¨(ë¹ˆ ì‘ë‹µì´ë©´ UI ìœ ì§€)
      document.addEventListener('visibilitychange', ()=>{ if (!document.hidden){ refreshOrders(); refreshInquiries(); } });
      setInterval(()=>{ refreshOrders(); refreshInquiries(); }, 8000);

      // ë‹¤ë¥¸ íƒ­ì˜ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ê°ì§€
      window.addEventListener('storage', (e)=>{
        if (e.key === 'admin_session_v1' || e.key === 'gs_user'){
          const ns = getAdminSessionSync() || getGsSessionSync();
          if (ns){ SESSION = ns; setChip('ok','ì •ìƒ'); stampLoginMarkers(ns); loadCurrentUser(); }
        }
        if (e.key === 'gs_identity'){
          const id = getFixedIdentity(); if (id.uname || id.email){ FIXED_ID = id; refreshOrders(); refreshInquiries(); }
        }
        if (e.key === 'gs_logout'){ location.href = 'index.html'; }
      });
    })();
  });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- ê³µí†µ í”„ë¡ì‹œ/ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ì´íŠ¸ í™˜ê²½ì— ë§ì¶° ìœ ì§€) -->
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <!-- ê´€ë¦¬ ì½˜ì†”ê³¼ ë™ì¼í•œ ì•”ë³µí˜¸í™” ì˜ì¡´ì„±ì´ í•„ìš”í•œ ê²½ìš° ëŒ€ë¹„ -->
  <script src="/admin/auth.js" defer></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:960px;margin:0 auto;color:#fff;padding:10px 20px 80px;}
    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;}
    .btn{
      background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:10px;
      font-size:14px;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      will-change: transform;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.25);background:#00897B;}
    .btn:active{transform:translateY(0);}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}

    /* pill(ëˆìˆ˜ ë²„íŠ¼) */
    .pill{background:#004d40;color:#FFD700;border:2px solid #FFD700;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;}
    .pill:hover{transform:translateY(-2px) scale(1.02); box-shadow:0 0 18px rgba(255,215,0,.22);}

    /* ì£¼ë¬¸ ì‹œíŠ¸(ì˜¤ë¥¸ìª½ ìŠ¬ë¼ì´ë“œ íŒ¨ë„) */
    #orderPanel{position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,.6); align-items:stretch; justify-content:flex-end;}
    #orderPanel.show{display:flex;}
    #orderSheet{width:min(640px,96vw); background:linear-gradient(135deg,#102522 82%,#1d4d46 100%); height:100%; overflow:auto; box-shadow:0 0 32px #000; border-left:1px solid #1d4d46; transform:translateX(100%); transition:transform .28s ease;}
    #orderPanel.show #orderSheet{transform:translateX(0);}
    .sheet-close{position:sticky; top:0; display:flex; justify-content:flex-end; padding:12px; background:linear-gradient(180deg,rgba(0,0,0,.28),rgba(0,0,0,0));}
    .sheet-body{padding:26px 22px 28px;}
    .sheet-h{ color:#FFD700; font-size:1.35em; margin:6px 0 16px; letter-spacing:.4px; }

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .kpi{background:#0c1a18;border-radius:12px;padding:12px 16px;margin:10px 0;}
    .kpi .lab{color:#FFD700;font-weight:600;}
    .kpi .val{font-size:1.15em;}
    .pill-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .sheet-actions .btn{width:100%;margin-top:10px;font-size:1.08em;background:#FFD700;color:#222;font-weight:700;}
    .grid{display:grid;gap:12px;}
    .grid-2{grid-template-columns:1fr 1fr;}
    .grid-3{grid-template-columns:2fr 3fr 2fr;}
    .input, .select{
      width:100%; padding:11px 12px; background:#0c1a18; color:#fff; border:1px solid #1e4d47; border-radius:10px; font-size:14px;
    }
    .input[readonly]{opacity:.85;}
    .input::placeholder{color:#8aa;}
    .help{font-size:12px; color:#99b; margin-top:4px;}

    /* ìš°í¸ë²ˆí˜¸ ë ˆì´ì–´(ë‹¤ìŒ ì„ë² ë“œìš©) */
    #postcodeLayer{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(460px,96vw); height:min(540px,80vh);
      background:#0c1a18; border:1px solid #1e4d47; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.5);
      display:none; z-index:10000; overflow:hidden;
    }
    #postcodeHeader{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#003D33;color:#fff;}
    #postcodeBody{height:calc(100% - 40px);}

    /* í”„ë¡œí•„ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜(ì„¹ì…˜ ë©”ë‰´ ìœ ì§€ + ìš°ì¸¡ í™ˆ ë²„íŠ¼ë§Œ) */
    #navbar .nav-right .user-area{display:none !important;} /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¹€ */

    /* ë©”ì‹œì§€ ì•„ì´í…œ */
    .msg-item{background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:10px;margin-bottom:8px;position:relative;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo">
        <a href="index.html" id="homeLogo"><img src="img/logo.png" alt="ê³¨ë“œìŠ¤íƒ€ ë¡œê³ " draggable="false"/></a>
      </div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <!-- í”„ë¡œí•„ í˜ì´ì§€ì—ì„œëŠ” í™ˆ ë²„íŠ¼ë§Œ ë³´ì´ë„ë¡ -->
        <a href="index.html" class="home-icon" aria-label="í™ˆ" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;">
          <span style="font-size:30px;color:#FFD700;">ğŸ </span>
        </a>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">ë‚´ ì •ë³´</h1>
        <!-- ìš”ì•½ ë¼ì¸(í° í…ìŠ¤íŠ¸) ì œê±°: í•„ìš” ì‹œ ë‹¤ì‹œ ë„£ì„ ìˆ˜ ìˆë„ë¡ ë¹„ì›Œë‘  -->
        <div id="summaryLine" style="display:none;"></div>
        <div class="actions">
          <button class="btn" id="addOrderBtn">ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="profile-card" id="profileCard" hidden>
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"></div>
      </div>

      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div class="grid grid-3" style="align-items:start;">
          <input id="msgTitle" class="input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
          <textarea id="msgInput" class="input" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="height:70px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:90px;">ë“±ë¡</button>
        </div>
        <p class="help">ê´€ë¦¬ì ë‹µë³€ ë“±ë¡ ì‹œ ì´ê³³ì—ì„œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ìš°í¸ë²ˆí˜¸(ë‹¤ìŒ) ì„ë² ë“œ ë ˆì´ì–´ -->
  <div id="postcodeLayer" role="dialog" aria-modal="true" aria-label="ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰">
    <div id="postcodeHeader">
      <strong>ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰</strong>
      <button id="postcodeClose" class="btn danger" style="padding:6px 10px;border-radius:8px;">ë‹«ê¸°</button>
    </div>
    <div id="postcodeBody"></div>
  </div>

  <!-- ì£¼ë¬¸ ì‚¬ì´ë“œ íŒ¨ë„ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>

        <!-- ë°°ì†¡ì§€ -->
        <div class="grid grid-3" style="margin-bottom:8px;">
          <div class="row" style="gap:8px;">
            <input id="zip" class="input" placeholder="ìš°í¸ë²ˆí˜¸" readonly />
            <button id="btnZip" class="btn" title="ìš°í¸ë²ˆí˜¸ ì°¾ê¸°">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
          </div>
          <div class="row" style="gap:8px;justify-content:flex-start;">
            <button id="btnManualAddr" class="btn" title="ì§ì ‘ ì…ë ¥ìœ¼ë¡œ ì „í™˜">ì§ì ‘ ì…ë ¥</button>
            <span class="help" id="addrHelp" style="margin:0;">ì£¼ì†Œ ê²€ìƒ‰ì´ ì•ˆ ë˜ë©´ ìˆ˜ë™ ì…ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.</span>
          </div>
        </div>
        <div class="grid grid-2" style="margin-bottom:12px;">
          <input id="addr1" class="input" placeholder="ì£¼ì†Œ" readonly />
          <input id="addr2" class="input" placeholder="ìƒì„¸ ì£¼ì†Œ (ë™/í˜¸ìˆ˜ ë“±)" />
        </div>

        <!-- ëˆìˆ˜ ì„ íƒ -->
        <div class="pill-wrap" id="productBtns"></div>

        <div class="kpi row">
          <span class="lab">ì´ ëˆìˆ˜</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn">ì£¼ë¬¸ ìš”ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    /* ========== ì„¸ì…˜ & ìœ ì € ìœ í‹¸ ========== */
    function getUserFromLocal(){
      try{ return JSON.parse(localStorage.getItem('gs_user')||'null'); }catch(_){ return null; }
    }
    function setUserLocal(u){
      try{ localStorage.setItem('gs_user', JSON.stringify(u)); }catch(_){}
    }
    function currentUser(){
      try{
        const u = window.GSApp?.currentUser?.();
        if (u) return u;
      }catch(_){}
      return getUserFromLocal();
    }
    function ensureLoggedInOrThrow(){
      const u = currentUser();
      if (!u) { throw new Error('NO_LOGIN'); }
      return u;
    }

    /* í™ˆ/ë¡œê³  í´ë¦­ ì‹œ ì„¸ì…˜ ìœ ì§€ + ì¸ë±ìŠ¤ì—ì„œ ë‚´ì •ë³´ ë²„íŠ¼ë§Œ ë³´ì´ë„ë¡ íŒíŠ¸ ì €ì¥ */
    function markReturnHint(){ try{ localStorage.setItem('gs_after_profile','1'); }catch(_){} }
    $('.home-icon')?.addEventListener('click', ()=>{ const u=currentUser(); if(u) setUserLocal(u); markReturnHint(); });
    $('#homeLogo')?.addEventListener('click', ()=>{ const u=currentUser(); if(u) setUserLocal(u); markReturnHint(); });

    /* ========== ê°€ê²© ë™ê¸°í™”(ì¸ë±ìŠ¤ì™€ ë™ì¼) ========== */
    let supplyPrice = 520000; // ê³ ì • ê³µê¸‰ê°€(ìš”êµ¬ì‚¬í•­)
    let currentPrice = 0;

    async function resolveCurrentPrice(){
      // 1) index.htmlì—ì„œ ì €ì¥í•´ë‘” ê°€ê²© ì‚¬ìš©
      let p = 0;
      try{ p = Number(localStorage.getItem('gs_gold_price')||'0'); }catch(_){}
      if (p>0){ currentPrice = p; return; }

      // 2) ë³´ì•ˆ ì„¤ì •(KV)ì— ìˆ˜ë™ê°€/í˜„ì¬ê°€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
      try{
        const r = await fetch('/api/security?type=goldprice',{cache:'no-store'});
        const j = await r.json();
        const manual = Number(j?.manualGoldPrice || j?.data?.manualGoldPrice || j?.goldprice?.price || 0);
        if (manual>0){ currentPrice = manual; return; }
        const auto = Number(j?.price || j?.data?.price || 0);
        if (auto>0){ currentPrice = auto; return; }
      }catch(_){}

      // 3) GSApp.goldPrice í´ë°±
      try{ if (typeof GSApp?.goldPrice === 'number') currentPrice = GSApp.goldPrice; }catch(_){}
      if (!currentPrice) currentPrice = 0;
    }

    /* ========== ê³µìš© KV í—¬í¼(ê´€ë¦¬ì í¬ë§· í˜¸í™˜) ========== */
    async function kvGet(kind){
      const res = await fetch(`/api/${kind}`, {cache:'no-store'});
      const j   = await res.json().catch(()=>({}));
      // ê´€ë¦¬ì í˜ì´ì§€ í¬ë§·: { data: <encrypted or array> }
      if (j && typeof j === 'object' && 'data' in j){
        if (Array.isArray(j.data)) return j.data;
        if (window.decrypt){
          try{ return window.decrypt(j.data) || []; }catch(_){ return []; }
        }
        // decryptê°€ ì—†ì„ ë•Œ ë°©ì–´
        try{ return JSON.parse(j.data); }catch(_){ return []; }
      }
      // usersëŠ” ë°°ì—´ì„ ì§ì ‘ ë°˜í™˜í•  ìˆ˜ë„ ìˆìŒ
      if (Array.isArray(j)) return j;
      // ê¸°íƒ€ í‚¤
      return j[kind] || j.items || j.list || [];
    }

    async function kvSet(kind, arr){
      const payload = window.encrypt ? { data: await window.encrypt(arr) } : { data: arr };
      await fetch(`/api/${kind}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    /* ========== í”„ë¡œí•„ ê¸°ë³¸ ì •ë³´ ========== */
    async function loadKVUserBasic(u){
      // /api/usersëŠ” admin/users.jsê°€ ì“°ëŠ” ì—”ë“œí¬ì¸íŠ¸(ë°°ì—´ ë°˜í™˜)
      const list = await kvGet('users');
      const me = list.find(x =>
        x?.username === u?.username ||
        x?.email    === u?.email
      );
      return me || u; // ì—†ìœ¼ë©´ ë¡œì»¬ ì„¸ì…˜ ì •ë³´ë¼ë„ ì‚¬ìš©
    }

    function renderProfileBasic(user){
      const grid = $('#profileGrid'), card = $('#profileCard');
      if (!grid || !card) return;
      card.hidden = false;
      grid.innerHTML = '';
      const fields = [
        ['ì´ë¦„',     user?.name  || '-'],
        ['ì•„ì´ë””',   user?.username || '-'],
        ['ì—°ë½ì²˜',   user?.phone || '-'],
        ['ì´ë©”ì¼',   user?.email || '-'],
      ];
      fields.forEach(([l,v])=>{
        const div = document.createElement('div');
        div.className = 'field';
        div.innerHTML = `<label>${l}</label><span>${v}</span>`;
        grid.appendChild(div);
      });
    }

    /* ========== ì£¼ë¬¸/ë¬¸ì˜ í‘œì‹œ ========== */
    function renderOrders(list){
      const c = $('#ordersContainer');
      if(!c) return;
      if(!Array.isArray(list) || !list.length){
        c.innerHTML = '<div class="orders-empty">ì—†ìŒ</div>';
        return;
      }
      c.innerHTML =
        `<table class="orders-table"><thead><tr>
          <th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€</th><th>í˜„ì¬ê°€</th><th>ì´ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìƒíƒœ</th><th>ì¼ì‹œ</th>
        </tr></thead><tbody>` +
        list.map(o=>`
          <tr>
            <td>${o.id||'-'}</td>
            <td>ê³¨ë“œë°”</td>
            <td style="text-align:right;">${o.don ?? '-'}</td>
            <td style="text-align:right;">${Number(o.supplyPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.currentPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.totalPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.priceDiff||0).toLocaleString('ko-KR')}</td>
            <td>${o.status||'-'}</td>
            <td>${o.ts ? new Date(o.ts).toLocaleString('ko-KR') : '-'}</td>
          </tr>`).join('') +
        '</tbody></table>';
    }

    function renderMessages(list){
      const wrap = $('#messagesWrap');
      if(!wrap) return;
      if(!Array.isArray(list) || !list.length){
        wrap.innerHTML = '<div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      wrap.innerHTML = list.slice().reverse().map(m=>{
        const st = m.status || (m.answered ? 'ë‹µë³€ì™„ë£Œ' : (m.read?'ì½ìŒ':'ë¯¸ì½ìŒ'));
        return `
          <div class="msg-item" data-id="${m.id||''}">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <div style="flex:1;">${m.fromAdmin?'<strong style="color:#FFD700;">[ê´€ë¦¬ì]</strong> ':''}${m.title?`<b>${m.title}</b> - `:''}${m.content||m.message||''}</div>
              <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${m.answered?'#2e7d32':(m.read?'#455a64':'#b71c1c')};color:#fff;white-space:nowrap;">${st}</span>
            </div>
            <div style="font-size:11px;color:#888;margin-top:4px;">${m.ts? new Date(m.ts).toLocaleString('ko-KR') : (m.date||'')}</div>
            ${m.reply? `<div style="margin-top:8px;background:#09201e;border:1px solid #1e4d47;border-radius:8px;padding:8px 10px;"><b style="color:#FFD700;">ê´€ë¦¬ì ë‹µë³€:</b> ${m.reply}</div>`:''}
          </div>`;
      }).join('');
    }

    async function loadMyOrders(u){
      const all = await kvGet('orders');
      // ê´€ë¦¬ì í¬ë§· ê¸°ì¤€: ê° ì£¼ë¬¸ ê°ì²´ì— user, amount, memo, status, id/date ...
      // í´ë¼ì´ì–¸íŠ¸ í¬ë§·(ì´ í˜ì´ì§€ì—ì„œ ìƒì„±): username/email/don/supplyPrice/currentPrice...
      const me = (all||[]).filter(o =>
        o?.user === u?.username || o?.user === u?.email ||
        o?.username === u?.username || o?.email === u?.email
      );
      renderOrders(me);
    }

    async function loadMyInquiries(u){
      const all = await kvGet('inquiries');
      const me = (all||[]).filter(q =>
        q?.user === u?.username || q?.user === u?.email ||
        q?.username === u?.username || q?.email === u?.email
      );
      renderMessages(me);
    }

    /* ========== ì£¼ë¬¸ ì‹œíŠ¸ ë¡œì§ ========== */
    const productList = [0.5,1,2,3,5,10];
    let totalDon = 0;

    function updateOrderCalc(){
      $('#totalDon').textContent     = totalDon;
      $('#supplyPrice').textContent  = Number(supplyPrice).toLocaleString('ko-KR');
      $('#currentPrice').textContent = Number(currentPrice).toLocaleString('ko-KR');
      const totalPrice   = totalDon * supplyPrice;
      const currentTotal = totalDon * currentPrice;
      $('#totalPrice').textContent   = totalPrice.toLocaleString('ko-KR');
      $('#currentTotal').textContent = currentTotal.toLocaleString('ko-KR');
      $('#priceDiff').textContent    = (currentTotal - totalPrice).toLocaleString('ko-KR');
    }

    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }

    // ëˆìˆ˜ ë²„íŠ¼
    const btnWrap = $('#productBtns');
    btnWrap.innerHTML = '';
    productList.forEach(don=>{
      const b = document.createElement('button');
      b.className = 'pill';
      b.textContent = `${don}ëˆ`;
      b.addEventListener('click', ()=>{ totalDon += don; updateOrderCalc(); });
      btnWrap.appendChild(b);
    });

    $('#addOrderBtn')?.addEventListener('click', async ()=>{
      const u = currentUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      await resolveCurrentPrice(); // í˜„ì¬ê°€ ë™ê¸°í™”
      openOrderPanel();
    });
    $('#closeOrderPanel')?.addEventListener('click', closeOrderPanel);
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    /* ========== ìš°í¸ë²ˆí˜¸ ========== */
    const postcodeLayer = $('#postcodeLayer');
    $('#postcodeClose')?.addEventListener('click', ()=>{ postcodeLayer.style.display='none'; $('#addrHelp').textContent='ì£¼ì†Œ ê²€ìƒ‰ì´ ì•ˆ ë˜ë©´ ìˆ˜ë™ ì…ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.'; });

    function setManualAddressMode(on){
      $('#zip').readOnly   = !on;
      $('#addr1').readOnly = !on;
      $('#addrHelp').textContent = on ? 'ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤.' : 'ì£¼ì†Œ ê²€ìƒ‰ì´ ì•ˆ ë˜ë©´ ìˆ˜ë™ ì…ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.';
    }
    $('#btnManualAddr')?.addEventListener('click', ()=> setManualAddressMode(true));

    function loadScriptOnce(src){
      return new Promise((resolve,reject)=>{
        if (document.querySelector(`script[data-postcode="${src}"]`)) return resolve();
        const s = document.createElement('script');
        s.src = src; s.async = true; s.setAttribute('data-postcode', src);
        s.onload = ()=> resolve();
        s.onerror = ()=> reject(new Error('SCRIPT_LOAD_FAIL'));
        document.head.appendChild(s);
      });
    }
    async function ensurePostcodeLoaded(){
      if (window.daum?.Postcode) return true;
      // ë„¤íŠ¸ì›Œí¬ ë¹ ë¥¸ í•‘(ì´ë¯¸ì§€ í•‘)ìœ¼ë¡œ CDN ì ‘ê·¼ì„± ì ê²€(ì§„ì§œ ì‹¤íŒ¨ì‹œì—ë§Œ ì—ëŸ¬ ì²˜ë¦¬)
      const pingOk = await new Promise(res=>{
        const img = new Image();
        const t = setTimeout(()=> res(false), 2500);
        img.onload = ()=>{ clearTimeout(t); res(true); };
        img.onerror = ()=>{ clearTimeout(t); res(false); };
        img.src = 'https://t1.daumcdn.net/svc/image/U03/common_icon/favicon.ico?_=' + Date.now();
      });
      // í•‘ ì‹¤íŒ¨ì—¬ë„ ë°”ë¡œ í¬ê¸°í•˜ì§€ ì•Šê³  ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹œë„
      try{
        await loadScriptOnce('https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js');
      }catch(e){
        return false;
      }
      // ë¡œë“œ ì™„ë£Œ ê¸°ë‹¤ë¦¬ê¸°
      for (let i=0;i<20;i++){
        if (window.daum?.Postcode) return true;
        await new Promise(r=>setTimeout(r,150));
      }
      return false;
    }

    async function openZip(){
      const ok = await ensurePostcodeLoaded();
      if (!ok){
        // ì‹¤ì œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©ì´ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì•ˆë‚´
        alert('ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜, "ì§ì ‘ ì…ë ¥"ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
        setManualAddressMode(true);
        return;
      }
      // ì„ë² ë“œë¡œ í‘œì‹œ(ì—°ê²° ì„±ê³µ ì‹œ UIê°€ ë³´ì„)
      postcodeLayer.style.display = 'block';
      const body = $('#postcodeBody');
      body.innerHTML = ''; // reset
      let gotSignal = false; // ì‹¤ì œ UI ì‹œê·¸ë„(ê²€ìƒ‰/ë¦¬ì‚¬ì´ì¦ˆ/ì™„ë£Œ)ì„ ë°›ì•˜ëŠ”ì§€
      const pc = new daum.Postcode({
        oncomplete: function(data){
          gotSignal = true;
          // ë„ë¡œëª…/ì§€ë²ˆ ëª¨ë‘ ì§€ì›
          const zone = data.zonecode || '';
          const addr = data.roadAddress || data.address || '';
          $('#zip').value   = zone;
          $('#addr1').value = addr;
          setManualAddressMode(false); // ìë™ ì…ë ¥ ëª¨ë“œ ìœ ì§€
          postcodeLayer.style.display = 'none';
          $('#addr2').focus();
        },
        onresize: function(){ gotSignal = true; },
        onsearch: function(){ gotSignal = true; }
      });
      pc.embed(body, {autoClose:false});

      // ë§Œì•½ 6ì´ˆ ë™ì•ˆ UI ì‹œê·¸ë„ì´ ì „í˜€ ì—†ìœ¼ë©´ ì§€ì—°/ì°¨ë‹¨ìœ¼ë¡œ íŒë‹¨
      setTimeout(()=>{
        if (!gotSignal && postcodeLayer.style.display === 'block'){
          alert('ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì ‘ì†ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, "ì§ì ‘ ì…ë ¥"ì„ ì´ìš©í•˜ì„¸ìš”.');
        }
      }, 6000);
    }
    $('#btnZip')?.addEventListener('click', openZip);

    /* ========== ì£¼ë¬¸ ì €ì¥(ê´€ë¦¬ì í¬ë§· í˜¸í™˜) ========== */
    $('#orderSubmit')?.addEventListener('click', async ()=>{
      let u = currentUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

      // ë°°ì†¡ì§€ í•„ìˆ˜ ê²€ì¦
      const zip   = $('#zip').value.trim();
      const addr1 = $('#addr1').value.trim();
      const addr2 = $('#addr2').value.trim();
      if (!zip || !addr1){
        alert('ë°°ì†¡ì§€(ìš°í¸ë²ˆí˜¸/ì£¼ì†Œ)ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      if (totalDon <= 0){
        alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      await resolveCurrentPrice();
      updateOrderCalc();

      // ì „ì²´ ì£¼ë¬¸ ë¶ˆëŸ¬ì™€ì„œ append í›„ {data: encrypted}ë¡œ ì €ì¥ (ê´€ë¦¬ì orders.jsì™€ ë™ì¼ í¬ë§·)
      const all = await kvGet('orders');
      const orderObj = {
        id: 'O' + Date.now(),
        user: u.username || u.email,         // ê´€ë¦¬ì í¬ë§·ì˜ ì‹ë³„ì
        username: u.username,
        email: u.email,
        phone: u.phone,
        don: totalDon,
        supplyPrice,
        currentPrice,
        totalPrice: totalDon * supplyPrice,
        currentTotal: totalDon * currentPrice,
        priceDiff: (totalDon * currentPrice) - (totalDon * supplyPrice),
        status: 'ì£¼ë¬¸ ìŠ¹ì¸ ëŒ€ê¸°',
        address: { zip, addr1, addr2 },
        ts: Date.now(),
        date: new Date().toISOString()
      };
      all.push(orderObj);
      await kvSet('orders', all);

      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderPanel();

      // ë‚´ ì£¼ë¬¸ ì¦‰ì‹œ ê°±ì‹ 
      loadMyOrders(u);
    });

    /* ========== 1:1 ë¬¸ì˜ ë“±ë¡(ê´€ë¦¬ì í¬ë§· í˜¸í™˜) ========== */
    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      const u = currentUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const title = $('#msgTitle').value.trim();
      const txt   = $('#msgInput').value.trim();
      if (!title || !txt){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

      const all = await kvGet('inquiries');
      const q = {
        id: 'Q' + Date.now(),
        user: u.username || u.email, // ê´€ë¦¬ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‹ë³„
        username: u.username,
        email: u.email,
        title, content: txt,
        status: 'ë“±ë¡', answered: false, read: true,
        ts: Date.now(),
        date: new Date().toISOString()
      };
      all.push(q);
      await kvSet('inquiries', all);

      // ì…ë ¥ ë¹„ìš°ê³  ì¦‰ì‹œ ê°±ì‹ 
      $('#msgTitle').value = '';
      $('#msgInput').value = '';
      loadMyInquiries(u);
    });

    /* ========== ë¡œê·¸ì•„ì›ƒ ========== */
    $('#logoutBtn')?.addEventListener('click', ()=>{
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ window.GSApp?.logout?.(); }catch(_){}
      try{ localStorage.removeItem('gs_user'); }catch(_){}
      location.href = 'index.html';
    });

    /* ========== ì´ˆê¸° ë¡œë“œ ========== */
    (async function init(){
      const u = currentUser();
      if (!u){
        if (confirm('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          location.href = 'login.html';
        }
        return;
      }
      // í”„ë¡œí•„ ê¸°ë³¸ì •ë³´ëŠ” KV USERSì—ì„œ ê°€ì ¸ì˜¤ê¸°(ê´€ë¦¬ì users.jsì™€ ë™ì¼ ë°±ì—”ë“œ)
      const kvUser = await loadKVUserBasic(u);
      // ì„¸ì…˜ ë³´ê°•
      setUserLocal(kvUser || u);
      renderProfileBasic(kvUser || u);

      // ê°€ê²© ë¯¸ë¦¬ ê³„ì‚°
      await resolveCurrentPrice();
      updateOrderCalc();

      // ë‚´ ì£¼ë¬¸/ë¬¸ì˜ ë¶ˆëŸ¬ì˜¤ê¸°
      await loadMyOrders(kvUser || u);
      await loadMyInquiries(kvUser || u);
    })();
  });
  </script>
</body>
</html>

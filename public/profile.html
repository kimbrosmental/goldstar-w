<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:860px;margin:0 auto;color:#fff;padding:10px 20px 60px;}
    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:14px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.3s;}
    .btn:hover{background:#00897B;}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}

    /* ì£¼ë¬¸ ì‹œíŠ¸(ì˜† ìŠ¬ë¼ì´ë“œ) */
    #orderPanel{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.65);align-items:stretch;justify-content:flex-end;}
    #orderPanel.show{display:flex;}
    #orderSheet{width:min(560px,96vw);background:linear-gradient(135deg,#102522 80%,#1d4d46 100%);height:100%;overflow:auto;box-shadow:0 0 32px #000;border-left:1px solid #1d4d46;transform:translateX(100%);transition:transform .28s ease;}
    #orderPanel.show #orderSheet{transform:translateX(0);}
    .sheet-body{padding:28px 22px 24px 22px;color:#fff;}
    .sheet-h{color:#FFD700;font-size:1.4em;margin:6px 0 14px;text-align:left;letter-spacing:.5px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .kpi{background:#0c1a18;border-radius:10px;padding:12px 16px;margin:10px 0;}
    .kpi .lab{color:#FFD700;font-weight:600;}
    .kpi .val{font-size:1.15em;}
    .pill{background:#004d40;color:#FFD700;border:2px solid #FFD700;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;}
    .pill-wrap{display:flex;gap:10px;flex-wrap:wrap;}
    .sheet-actions .btn{width:100%;margin-top:10px;font-size:1.08em;}
    .sheet-close{position:sticky;top:0;display:flex;justify-content:flex-end;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,0));}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><img src="img/logo.png" alt="logo"/></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <div id="userArea" class="user-area"></div>
        <a href="index.html" class="home-icon" aria-label="í™ˆ" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;">
          <span style="font-size:30px;color:#FFD700;">ğŸ </span>
        </a>
        <span id="navProfileBtn" style="display:none;margin-left:12px;"><a href="profile.html" style="color:#FFD700;font-weight:bold;font-size:16px;text-decoration:none;">ë‚´ì •ë³´</a></span>
        <div class="menu-btn" aria-label="ë©”ë‰´" role="button" tabindex="0"><span></span><span></span><span></span></div>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">ë‚´ ì •ë³´</h1>
        <div id="summaryLine" style="font-size:15px;color:#eee;font-weight:500;line-height:1.4;"></div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn">ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- âœ… ê¸°ë³¸ ì •ë³´ ì¹´ë“œ(í•­ìƒ ì¡´ì¬) -->
      <div class="profile-card" id="profileCard">
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"></div>
      </div>

      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:90px;">ë³´ë‚´ê¸°</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">ê´€ë¦¬ìë§Œ ë‹µë³€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ì£¼ë¬¸ ì‹œíŠ¸ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>

        <div class="pill-wrap" id="productBtns"></div>

        <div class="kpi row">
          <span class="lab">ì´ ëˆìˆ˜</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- (ì„ íƒ) ê´€ë¦¬ì/ìœ ì € ì„¸ì…˜ ëª¨ë“ˆì´ ìˆìœ¼ë©´ ë¨¼ì € ë¡œë“œ -->
  <script src="/admin/auth.js" defer></script>
  <script src="app.js" defer></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);

    /* ====================== ì„¸ì…˜/ì‚¬ìš©ì í•´ì„ê¸°(ê°•í™”) ====================== */
    let CURRENT_USER = null;

    // 1) GSApp â†’ 2) localStorage â†’ 3) AdminAuth(ê´€ë¦¬ì) â†’ 4) ì„œë²„ ì„¸ì…˜(whoAmI) ìˆœ
    function fromGSApp(){ try{ const u = window.GSApp?.currentUser?.(); if(u && u.username) return u; }catch(_){ } return null; }
    function fromLocal(){ try{ const r = localStorage.getItem('gs_user') || localStorage.getItem('gs_user_backup'); if(r) return JSON.parse(r); }catch(_){ } return null; }
    function fromAdminAuth(){ try{ const s = window.AdminAuth?.currentSession?.(); if(s?.username) return { username:s.username, role:s.role||'admin' }; }catch(_){ } return null; }

    async function whoAmI(){
      const tryList = ['/api/me','/api/session','/api/login']; // ì„œë²„ êµ¬í˜„ ì¤‘ ìˆëŠ” ê²ƒ í•˜ë‚˜ë¼ë„ ì‘ë‹µí•˜ë©´ ì‚¬ìš©
      for(const url of tryList){
        try{
          const r = await fetch(url, {cache:'no-store', credentials:'include'});
          if(r.ok){
            const j = await r.json().catch(()=>null);
            if(j && (j.username || j.email)) return j;
          }
        }catch(_){}
      }
      return null;
    }

    // USERS KV ì „ì²´ì—ì„œ í•œ ëª… ì°¾ê¸° (users.js ë°©ì‹ í˜¸í™˜: í‰ë¬¸/ì•”í˜¸í™” ëª¨ë‘ ì§€ì›)
    async function fetchKVUser(usernameOrEmail){
      try{
        const r = await fetch('/api/users', {cache:'no-store'});
        const j = await r.json();
        let list = [];
        if (j && j.data && window.decrypt) { try{ list = await window.decrypt(j.data) || []; }catch(_){ list = []; } }
        else if (Array.isArray(j)) { list = j; }
        return list.find(u => u.username===usernameOrEmail || u.email===usernameOrEmail) || null;
      }catch(_){ return null; }
    }

    async function resolveUser(){
      let u = fromGSApp() || fromLocal() || fromAdminAuth();
      if (!u){
        const me = await whoAmI(); // ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜ì´ë©´ ì—¬ê¸°ì„œ ì‹ë³„
        if (me && (me.username || me.email)) {
          const kv = await fetchKVUser(me.username || me.email);
          u = kv ? kv : { username: me.username || (me.email||'').split('@')[0], email: me.email, role: me.role||'user' };
        }
      } else {
        // GSApp/localì—ì„œ ì¡ì€ ê²½ìš°ì—ë„ KV ì •ë³´ë¡œ ë³´ê°•
        const kv = await fetchKVUser(u.username || u.email || '');
        if (kv) u = { ...u, ...kv };
      }
      if (u){
        try{ localStorage.setItem('gs_user', JSON.stringify(u)); localStorage.setItem('gs_user_backup', JSON.stringify(u)); }catch(_){}
        return u;
      }
      return null;
    }

    /* ====================== UI ë Œë” ====================== */
    function renderProfileSummary(user){
      const sum = $('#summaryLine');
      if (sum && user) sum.innerHTML = `<strong>${user.username}</strong> | ${user.name||'-'} | ${user.phone||'-'} | ${user.email||'-'}`;
    }
    function renderBaseInfo(user){
      const grid = $('#profileGrid'); grid.innerHTML='';
      const rows = [
        ['ì´ë¦„',     user.name],
        ['ì•„ì´ë””',   user.username],
        ['ì—°ë½ì²˜',   user.phone],
        ['ì´ë©”ì¼',   user.email],
        ['ì€í–‰',     user.bank||'-'],
        ['ê³„ì¢Œë²ˆí˜¸', user.account||'-'],
        ['ê°€ì…ì¼',   user.created ? new Date(user.created).toLocaleString('ko-KR') : '-'],
        ['ê¶Œí•œ',     user.role || 'user'],
      ];
      rows.forEach(([l,v])=>{ const d=document.createElement('div'); d.className='field'; d.innerHTML=`<label>${l}</label><span>${v||'-'}</span>`; grid.appendChild(d); });
    }

    function renderOrders(list){
      const el = $('#ordersContainer');
      if(!Array.isArray(list) || !list.length){ el.innerHTML='<div class="orders-empty">ì—†ìŒ</div>'; return; }
      el.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€</th><th>í˜„ì¬ê°€</th><th>ì´ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìƒíƒœ</th><th>ì¼ì‹œ</th>' +
        '</tr></thead><tbody>' +
        list.map(o=>`
          <tr>
            <td>${o.id||o.orderId||'-'}</td>
            <td>${o.item||'ê³¨ë“œë°”'}</td>
            <td style="text-align:right;">${o.don ?? (o.qty ?? '-')}</td>
            <td style="text-align:right;">${Number(o.supplyPrice||o.supply||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.currentPrice||o.price||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.totalPrice||o.amount||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.priceDiff||0).toLocaleString('ko-KR')}</td>
            <td>${o.status||'-'}</td>
            <td>${new Date(o.ts||o.date||Date.now()).toLocaleString('ko-KR')}</td>
          </tr>`).join('') + '</tbody></table>';
    }

    function renderMessages(list){
      const el = $('#messagesWrap');
      if(!Array.isArray(list) || !list.length){ el.innerHTML='<div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      el.innerHTML = list.slice().reverse().map(m=>`
        <div class="msg-item" style="background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="flex:1;">
              ${m.fromAdmin?'<strong style="color:#FFD700;">[ê´€ë¦¬ì]</strong> ':''}
              ${m.title?`<strong>${m.title}</strong> â€” `:''}${m.content||m.message||''}
              ${m.answer?`<div style="margin-top:6px;color:#b2dfdb;">â†³ ê´€ë¦¬ì ë‹µë³€: ${m.answer}</div>`:''}
            </div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${m.answer?'#2e7d32':(m.read?'#455a64':'#b71c1c')};color:#fff;white-space:nowrap;">
              ${m.answer?'ë‹µë³€ì™„ë£Œ':(m.read?'ì½ìŒ':'ë¯¸ì½ìŒ')}
            </span>
          </div>
          <div style="font-size:11px;color:#888;margin-top:4px;">${new Date(m.ts||m.date||Date.now()).toLocaleString('ko-KR')}</div>
        </div>`).join('');
    }

    /* ====================== ì„œë²„ ë°ì´í„° ë¡œë“œ ====================== */
    async function loadOrdersForUser(username, email){
      try{
        const r = await fetch('/api/orders', {cache:'no-store'});
        const j = await r.json();
        let arr = [];
        if (j?.data && window.decrypt) { try{ arr = await window.decrypt(j.data) || []; }catch(_){ arr=[]; } }
        else if (Array.isArray(j)) { arr = j; }
        return arr.filter(o => (o.username===username) || (o.user===username) || (o.email && o.email===email));
      }catch(_){ return []; }
    }
    async function loadInquiriesForUser(username, email){
      try{
        const r = await fetch('/api/inquiries', {cache:'no-store'});
        const j = await r.json();
        let arr = [];
        if (j?.data && window.decrypt) { try{ arr = await window.decrypt(j.data) || []; }catch(_){ arr=[]; } }
        else if (Array.isArray(j)) { arr = j; }
        return arr
          .filter(q => (q.user===username || q.user===email))
          .map(q => ({ id:q.id, content:q.content, title:q.title, answer:q.answer, read:!!q.answer, fromAdmin:false, ts:q.date }));
      }catch(_){ return []; }
    }

    /* ====================== ê¸ˆ ì‹œì„¸(ì„¹ì…˜1ê³¼ ë™ì¼ ì†ŒìŠ¤) ====================== */
    async function getCurrentGoldPrice(){
      const manual = Number(localStorage.getItem('manualGoldPrice')||'0');
      if (manual>0) return manual;
      try{
        const r = await fetch('/api/security?type=goldprice', {cache:'no-store'});
        const j = await r.json();
        if (Number(j?.manualGoldPrice||0)>0) return Number(j.manualGoldPrice);
        if (Number(j?.price||0)>0) return Number(j.price);
      }catch(_){}
      return 0;
    }

    /* ====================== ì£¼ë¬¸ ì‹œíŠ¸ ====================== */
    const productList = [0.5,1,2,3,5,10];
    let totalDon = 0;
    let supplyPrice = 520000;
    let currentPrice = 0;

    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }
    function updateOrderCalc(){
      $('#totalDon').textContent      = totalDon;
      $('#supplyPrice').textContent   = Number(supplyPrice).toLocaleString('ko-KR');
      $('#currentPrice').textContent  = Number(currentPrice).toLocaleString('ko-KR');
      const totalPrice   = totalDon * supplyPrice;
      const currentTotal = totalDon * currentPrice;
      $('#totalPrice').textContent   = totalPrice.toLocaleString('ko-KR');
      $('#currentTotal').textContent = currentTotal.toLocaleString('ko-KR');
      $('#priceDiff').textContent    = (currentTotal - totalPrice).toLocaleString('ko-KR');
    }

    // ìƒí’ˆ ë²„íŠ¼ êµ¬ì„±
    (function renderProductPills(){
      const wrap = $('#productBtns'); wrap.innerHTML = '';
      productList.forEach(d=>{
        const b = document.createElement('button');
        b.className='pill'; b.textContent = `${d}ëˆ`;
        b.addEventListener('click', ()=>{ totalDon += d; updateOrderCalc(); });
        wrap.appendChild(b);
      });
    })();

    // í˜„ì¬ ì‚¬ìš©ì í™•ë³´ + ë„¤ë¹„ í‘œì‹œ
    async function ensureUser(){
      if (CURRENT_USER) return CURRENT_USER;
      const u = await resolveUser();
      if (u){
        CURRENT_USER = u;
        // ë„¤ë¹„ì— "ë‚´ì •ë³´" ê°•ì œ ë…¸ì¶œ
        const navProf = $('#navProfileBtn'); if(navProf) navProf.style.display='inline-block';
        const userArea = $('#userArea');
        if (userArea) userArea.innerHTML = `<a href="profile.html" class="btn">ë‚´ì •ë³´</a>`;
        return CURRENT_USER;
      }
      return null;
    }

    // ì£¼ë¬¸ ì €ì¥(ë‹¨ê±´ POST ìš°ì„ , ì‹¤íŒ¨ì‹œ ë°°ì—´ ì•”í˜¸í™” ë°©ì‹ í´ë°±)
    async function saveOrder(order){
      try{
        const r = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userOrder: order }) });
        if (r.ok) return true;
      }catch(_){}
      try{
        const r1 = await fetch('/api/orders'); const j1 = await r1.json();
        let arr = [];
        if (j1?.data && window.decrypt) { try{ arr = await window.decrypt(j1.data)||[]; }catch(_){ arr=[]; } }
        else if (Array.isArray(j1)) { arr = j1; }
        arr.push({ id: order.id, date: new Date(order.ts).toISOString(), user: order.username, amount: order.totalPrice, status:'ê²°ì œëŒ€ê¸°', memo:'user-order', ...order });
        const enc = window.encrypt ? await window.encrypt(arr) : null;
        if (enc){
          const r2 = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ data: enc }) });
          return r2.ok;
        }
      }catch(_){}
      return false;
    }

    // ë¬¸ì˜ ì €ì¥(ë‹¨ê±´ POST â†’ í´ë°±)
    async function saveInquiry(rec){
      try{
        const r = await fetch('/api/inquiries', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userInquiry: rec }) });
        if (r.ok) return true;
      }catch(_){}
      try{
        const r1 = await fetch('/api/inquiries'); const j1 = await r1.json();
        let arr = [];
        if (j1?.data && window.decrypt) { try{ arr = await window.decrypt(j1.data)||[]; }catch(_){ arr=[]; } }
        else if (Array.isArray(j1)) { arr = j1; }
        arr.push(rec);
        const enc = window.encrypt ? await window.encrypt(arr) : null;
        if (enc){
          const r2 = await fetch('/api/inquiries', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ data: enc }) });
          return r2.ok;
        }
      }catch(_){}
      return false;
    }

    /* ====================== ì´ë²¤íŠ¸ ====================== */
    // ë©”ë‰´ í† ê¸€
    document.querySelector('.menu-btn')?.addEventListener('click', ()=>{
      document.querySelector('.menu-btn')?.classList.toggle('active');
      document.querySelector('.nav-links')?.classList.toggle('active');
    });

    // í™ˆ(ğŸ ) í´ë¦­ ì‹œ ì„¸ì…˜ ë°±ì—… ìœ ì§€
    document.querySelector('.home-icon')?.addEventListener('click', ()=>{
      if (CURRENT_USER) {
        try{ localStorage.setItem('gs_user', JSON.stringify(CURRENT_USER)); localStorage.setItem('gs_user_backup', JSON.stringify(CURRENT_USER)); }catch(_){}
      }
    });

    // â€œì£¼ë¬¸ ì¶”ê°€â€
    $('#addOrderBtn')?.addEventListener('click', async ()=>{
      const u = await ensureUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='login.html'; return; }
      currentPrice = await getCurrentGoldPrice();
      if (!currentPrice || currentPrice<=0) currentPrice = 550000; // ì•ˆì „ê°’
      openOrderPanel();
      updateOrderCalc();
    });

    // ì£¼ë¬¸ ì œì¶œ
    $('#orderSubmit')?.addEventListener('click', async ()=>{
      const u = await ensureUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      if (totalDon <= 0) return alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');

      const order = {
        id:'O'+Date.now(),
        username:u.username, name:u.name, phone:u.phone, email:u.email,
        don: totalDon,
        supplyPrice, currentPrice,
        totalPrice: totalDon * supplyPrice,
        currentTotal: totalDon * currentPrice,
        priceDiff: (totalDon * currentPrice) - (totalDon * supplyPrice),
        status: 'ì£¼ë¬¸ ìŠ¹ì¸ ëŒ€ê¸°',
        ts: Date.now()
      };

      const ok = await saveOrder(order);
      if (!ok) { alert('ì£¼ë¬¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderPanel();

      // ìµœì‹  ì£¼ë¬¸ ëª©ë¡ ë°˜ì˜
      const list = await loadOrdersForUser(u.username, u.email);
      renderOrders(list);
    });

    // ë¬¸ì˜ ì „ì†¡
    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      const u = await ensureUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const txt = $('#msgInput').value.trim();
      if(!txt) return;
      const rec = { id:'Q'+Date.now(), user: u.username||u.email, title:'ì‚¬ìš©ì ë¬¸ì˜', content:txt, date:new Date().toISOString(), status:'ë¯¸ë‹µë³€' };
      const ok = await saveInquiry(rec);
      if (!ok) { alert('ë¬¸ì˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
      $('#msgInput').value = '';
      const list = await loadInquiriesForUser(u.username, u.email);
      renderMessages(list);
    });

    // ë‹«ê¸°/ë¦¬ì…‹
    $('#closeOrderPanel')?.addEventListener('click', ()=> closeOrderPanel());
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    // ë¡œê·¸ì•„ì›ƒ
    $('#logoutBtn')?.addEventListener('click', ()=>{
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ window.AdminAuth?.logout?.(); }catch(_){}
      try{ window.GSApp?.logout?.(); }catch(_){}
      try{ localStorage.removeItem('gs_user'); localStorage.removeItem('gs_user_backup'); }catch(_){}
      location.href='index.html';
    });

    // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œë„ ì„¸ì…˜ ë°±ì—… ìœ ì§€(ë„¤ë¹„ í™ˆ ì´ë™ ë“±)
    window.addEventListener('pagehide', ()=>{ if(CURRENT_USER){ try{ localStorage.setItem('gs_user', JSON.stringify(CURRENT_USER)); localStorage.setItem('gs_user_backup', JSON.stringify(CURRENT_USER)); }catch(_){}} });

    /* ====================== ë¶€íŒ…: ì‚¬ìš©ì/ì£¼ë¬¸/ë¬¸ì˜ ë¡œë“œ ====================== */
    (async function boot(){
      const u = await resolveUser();
      if (!u){ 
        // ë¡œê·¸ì¸ ì•ˆë˜ì–´ ìˆì–´ë„ ê²½ê³ ì°½ì€ ë„ìš°ì§€ ì•ŠìŒ(ìš”ì²­ ì‹œì—ë§Œ ì•ˆë‚´)
        return;
      }
      CURRENT_USER = u;
      document.getElementById('navProfileBtn').style.display = 'inline-block';
      const userArea = document.getElementById('userArea');
      if (userArea) userArea.innerHTML = `<a href="profile.html" class="btn">ë‚´ì •ë³´</a>`;
      renderProfileSummary(u);
      renderBaseInfo(u);

      const orders = await loadOrdersForUser(u.username, u.email);
      renderOrders(orders);
      const inq = await loadInquiriesForUser(u.username, u.email);
      renderMessages(inq);
    })();
  });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:860px;margin:0 auto;color:#fff;padding:10px 20px 60px;}
    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:4px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.22s;display:inline-flex;align-items:center;justify-content:center;height:44px;box-shadow:0 0 0 0 rgba(255,215,0,0);}
    .btn:hover{background:#00897B; transform:translateY(-2px); box-shadow:0 6px 18px rgba(255,215,0,.18);}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
    .muted{opacity:.75}

    /* ì£¼ë¬¸ ì‹œíŠ¸(ì˜† ìŠ¬ë¼ì´ë“œ) */
    #orderPanel{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.65);align-items:stretch;justify-content:flex-end;}
    #orderPanel.show{display:flex;}
    #orderSheet{width:min(600px,96vw);background:linear-gradient(135deg,#102522 80%,#1d4d46 100%);height:100%;overflow:auto;box-shadow:0 0 32px #000;border-left:1px solid #1d4d46;transform:translateX(100%);transition:transform .28s ease;}
    #orderPanel.show #orderSheet{transform:translateX(0);}
    .sheet-body{padding:28px 22px 24px 22px;color:#fff;}
    .sheet-h{color:#FFD700;font-size:1.4em;margin:6px 0 14px;text-align:left;letter-spacing:.5px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .kpi{background:#0c1a18;border-radius:10px;padding:12px 16px;margin:10px 0;}
    .kpi .lab{color:#FFD700;font-weight:600;}
    .kpi .val{font-size:1.15em;}

    .pill{background:#004d40;color:#FFD700;border:2px solid #FFD700;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;height:40px;transition:.22s;}
    .pill:hover{transform:translateY(-2px) scale(1.02); box-shadow:0 8px 18px rgba(255,215,0,.16);}

    .pill-wrap{display:flex;gap:10px;flex-wrap:wrap;}

    /* ì£¼ì†Œ ì…ë ¥ ë ˆì´ì•„ì›ƒ */
    .addr-row{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap;margin-top:10px;}
    .addr-input{flex:1 1 240px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px 12px;font-size:14px;min-height:44px;}
    .addr-zip{flex:0 0 160px;min-width:150px}
    .addr-btn{background:#455a64}
    .addr-btn:hover{background:#607d8b; transform:translateY(-2px); box-shadow:0 6px 18px rgba(255,215,0,.14);}
    .addr-btn.secondary{background:#37474f}
    .addr-btn.secondary:hover{background:#455a64}
    .sheet-actions .btn{width:100%;margin-top:12px;font-size:1.08em;height:48px;}

    .sheet-close{position:sticky;top:0;display:flex;justify-content:flex-end;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,0));}

    /* ì´ í˜ì´ì§€: ì¢Œì¸¡ ì„¹ì…˜ ë§í¬ ìœ ì§€, ìš°ì¸¡ì—” í™ˆ ë²„íŠ¼ë§Œ */
    #navbar #userArea, #navbar #navProfileBtn, #navbar .menu-btn { display:none !important; }

    /* ìš°í¸ë²ˆí˜¸ ë¡œë”© & ì„ë² ë“œ ë ˆì´ì–´ */
    #zipLoading{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;}
    #zipLoading.show{display:flex;}
    #zipLoading .box{background:#0c1a18;border:1px solid #1e4d47;border-radius:12px;padding:18px 22px;color:#fff;min-width:280px;text-align:center;}

    #postcodeLayer{display:none;position:fixed;z-index:10001;left:50%;top:50%;transform:translate(-50%,-50%);width:min(520px,96vw);height:min(560px,86vh);background:#0c1a18;border:1px solid #1e4d47;border-radius:14px;box-shadow:0 16px 36px rgba(0,0,0,.6);overflow:hidden;}
    #postcodeLayer.show{display:block;}
    #postcodeHeader{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#102522;border-bottom:1px solid #1e4d47;}
    #postcodeHeader strong{color:#FFD700}
    #postcodeClose{background:#b71c1c;border:none;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;}
    #postcodeWrap{width:100%;height:calc(100% - 46px);}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo" id="logoClickable" style="cursor:pointer;"><img src="img/logo.png" alt="logo"/></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <div id="userArea" class="user-area"></div>
        <a href="index.html" class="home-icon" aria-label="í™ˆ" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;">
          <span style="font-size:30px;color:#FFD700;">ğŸ </span>
        </a>
        <span id="navProfileBtn" style="display:none;margin-left:12px;"><a href="profile.html" style="color:#FFD700;font-weight:bold;font-size:16px;text-decoration:none;">ë‚´ì •ë³´</a></span>
        <div class="menu-btn" aria-label="ë©”ë‰´" role="button" tabindex="0"><span></span><span></span><span></span></div>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">ë‚´ ì •ë³´</h1>
        <div class="actions">
          <button class="btn" id="addOrderBtn">ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="profile-card" id="profileCard">
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"><div class="orders-empty">ì—†ìŒ</div></div>
      </div>

      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"><div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
        <div class="addr-row">
          <textarea id="msgInput" class="addr-input" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <button class="btn" id="sendMsgBtn" style="min-width:120px;">ë³´ë‚´ê¸°</button>
        </div>
        <p class="muted" style="margin-top:10px;font-size:12px;">ê´€ë¦¬ìë§Œ ë‹µë³€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ì£¼ë¬¸ ì‹œíŠ¸ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>

        <div class="pill-wrap" id="productBtns"></div>

        <div class="kpi row">
          <span class="lab">ì´ ëˆìˆ˜</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger" style="min-width:92px">ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <!-- ë°°ì†¡ì§€ ì •ë³´ -->
        <h2 class="sheet-h" style="margin-top:20px;">ë°°ì†¡ì§€ ì •ë³´</h2>
        <div class="addr-row">
          <input id="zipcode" class="addr-input addr-zip" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
          <button id="btnFindZip" class="btn addr-btn" style="min-width:140px;">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
          <button id="btnManualZip" class="btn addr-btn secondary" style="min-width:140px;">ì§ì ‘ ì…ë ¥</button>
        </div>
        <div class="addr-row">
          <input id="roadAddress" class="addr-input" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>
        </div>
        <div class="addr-row">
          <input id="jibunAddress" class="addr-input" placeholder="ì§€ë²ˆ ì£¼ì†Œ" readonly>
        </div>
        <div class="addr-row">
          <input id="detailAddress" class="addr-input" placeholder="ìƒì„¸ ì£¼ì†Œ(ë™/í˜¸)">
          <input id="extraAddress" class="addr-input" placeholder="ì°¸ê³  í•­ëª©(ê±´ë¬¼ëª… ë“±)">
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ìš°í¸ë²ˆí˜¸ ë¡œë”© -->
  <div id="zipLoading"><div class="box">ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì—°ê²° ì¤‘â€¦</div></div>

  <!-- ìš°í¸ë²ˆí˜¸ ì„ë² ë“œ ë ˆì´ì–´ -->
  <div id="postcodeLayer" role="dialog" aria-modal="true">
    <div id="postcodeHeader">
      <strong>ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</strong>
      <button id="postcodeClose">ë‹«ê¸°</button>
    </div>
    <div id="postcodeWrap"></div>
  </div>

  <script src="/admin/auth.js" defer></script>
  <script src="app.js" defer></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
    const LS_KEYS = ['gs_user','gs_user_backup','user','user_session','session_user'];

    // í™ˆ/ë¡œê³  í´ë¦­ ì‹œ ì„¸ì…˜ ë°±ì—…
    $('#logoClickable')?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (window.__CURRENT_USER) {
        localStorage.setItem('gs_user', JSON.stringify(window.__CURRENT_USER));
        localStorage.setItem('gs_user_backup', JSON.stringify(window.__CURRENT_USER));
      }
      location.href='index.html';
    });
    $('.home-icon')?.addEventListener('click', ()=>{
      if (window.__CURRENT_USER) {
        localStorage.setItem('gs_user', JSON.stringify(window.__CURRENT_USER));
        localStorage.setItem('gs_user_backup', JSON.stringify(window.__CURRENT_USER));
      }
    });

    // â”€â”€ ì„¸ì…˜ ìœ í‹¸
    const readJSON = k => { try{ const r=localStorage.getItem(k); return r?JSON.parse(r):null; }catch(_){ return null; } };
    function fromGSApp(){ try{ const u = window.GSApp?.currentUser?.(); if(u && (u.username||u.email)) return u; }catch(_){ } return null; }
    function fromLocal(){
      for(const k of LS_KEYS){ const u = readJSON(k); if(u && (u.username||u.email)) return u; }
      const a = readJSON('admin_session_v1');
      if(a && (a.username||a.email)) return {username:a.username, email:a.email, role:a.role||'user'};
      return null;
    }
    function mergeUser(base, extra){ if(!extra) return base; const out={...base}; for(const k of Object.keys(extra)){ if(out[k]==null || out[k]==='') out[k]=extra[k]; } return out; }
    async function pickArrayDecrypt(j){
      try{
        if (!j) return [];
        if (Array.isArray(j)) return j;
        if (j.data){
          if (Array.isArray(j.data)) return j.data;
          if (typeof j.data === 'string' && window.decrypt){ try{ return await window.decrypt(j.data) || []; }catch(_){ return []; } }
        }
        if (Array.isArray(j.items)) return j.items;
        if (Array.isArray(j.list)) return j.list;
        if (j.result && Array.isArray(j.result)) return j.result;
      }catch(_){}
      // ê°ì²´ mapìœ¼ë¡œ ì €ì¥ëœ ê²½ìš°
      if (typeof j==='object') try{ return Object.values(j); }catch(_){}
      return [];
    }
    async function fetchKVUsers(){
      try{
        const res = await fetch('/api/users?ts='+Date.now(),{cache:'no-store',credentials:'include'});
      const j = await res.json(); return await pickArrayDecrypt(j);
      }catch(_){ return []; }
    }
    async function fetchKVUser(usernameOrEmail){
      const list = await fetchKVUsers();
      return list.find(u => u.username===usernameOrEmail || u.email===usernameOrEmail) || null;
    }
    async function resolveUser(){
      let u = fromGSApp() || fromLocal();
      if (!u){
        const candidates=['/api/me','/api/session'];
        for(const url of candidates){
          try{
            const r = await fetch(url,{cache:'no-store',credentials:'include'});
            if(r.ok){ const me = await r.json().catch(()=>null); if(me && (me.username||me.email)){ u=me; break; } }
          }catch(_){}
        }
      }
      if (u && (u.username||u.email)){
        const kv = await fetchKVUser(u.username||u.email);
        if (kv) u = mergeUser(u, kv);
        localStorage.setItem('gs_user', JSON.stringify(u));
        localStorage.setItem('gs_user_backup', JSON.stringify(u));
        return u;
      }
      return null;
    }
    async function getUser(){
      if (window.__CURRENT_USER) return window.__CURRENT_USER;
      const local = fromGSApp() || fromLocal();
      if (local){ window.__CURRENT_USER = local; return local; }
      const resolved = await resolveUser();
      if (resolved) { window.__CURRENT_USER = resolved; }
      return resolved;
    }

    // â”€â”€ ì‚¬ìš©ì ë Œë”
    function renderBase(u){
      const grid=$('#profileGrid'); grid.innerHTML='';
      [
        ['ì´ë¦„',u.name],['ì•„ì´ë””',u.username],['ì—°ë½ì²˜',u.phone],['ì´ë©”ì¼',u.email],
        ['ì€í–‰',u.bank||'-'],['ê³„ì¢Œë²ˆí˜¸',u.account||'-'],
        ['ê°€ì…ì¼',u.created?new Date(u.created).toLocaleString('ko-KR'):'-'],
        ['ê¶Œí•œ',u.role||'user']
      ].forEach(([l,v])=>{ const d=document.createElement('div'); d.className='field'; d.innerHTML = `<label>${l}</label><span>${v||'-'}</span>`; grid.appendChild(d); });
    }

    // â”€â”€ ë‚´ ì£¼ë¬¸/ë¬¸ì˜ ë¡œë“œ(ìœ ì—° ë§¤ì¹­)
    function idMatches(o, usernames=[], emails=[]){
      const lowers = v => String(v||'').trim().toLowerCase();
      const cand = new Set();
      const append = (v)=>{ if(v!=null) cand.add(lowers(v)); };
      // í”í•œ í‚¤ë“¤ ëª¨ë‘ ìˆ˜ì§‘
      ['username','user','userId','owner','buyer','buyerId','account','accountId','createdBy'].forEach(k=>append(o?.[k]));
      ['email','userEmail','buyerEmail','accountEmail','contactEmail'].forEach(k=>append(o?.[k]));
      // ê°ì²´í˜• user
      if (o?.user && typeof o.user==='object'){
        append(o.user.username); append(o.user.email); append(o.user.id);
      }
      const uSet = new Set(usernames.map(lowers));
      const eSet = new Set(emails.map(lowers));
      return [...cand].some(v => uSet.has(v) || eSet.has(v));
    }

    async function loadOrdersForUser(u){
      try{
        const r=await fetch('/api/orders?ts='+Date.now(),{cache:'no-store',credentials:'include'});
        const j=await r.json();
        let arr = await pickArrayDecrypt(j);
        if (!Array.isArray(arr) && typeof arr==='object'){ arr = Object.values(arr); }
        arr = (arr||[]).filter(o => idMatches(o, [u.username,u.id], [u.email]));
        return arr;
      }catch(_){ return []; }
    }
    async function loadInquiriesForUser(u){
      try{
        const r=await fetch('/api/inquiries?ts='+Date.now(),{cache:'no-store',credentials:'include'});
        const j=await r.json();
        let arr = await pickArrayDecrypt(j);
        if (!Array.isArray(arr) && typeof arr==='object'){ arr = Object.values(arr); }
        arr = (arr||[]).filter(o => idMatches(o, [u.username,u.id], [u.email]));
        // í‘œì¤€í™”
        return arr.map(q => ({
          id:q.id||q.qid||('Q'+(q.ts||Date.now())),
          content:q.content||q.message||'',
          title:q.title||'ë¬¸ì˜',
          answer:q.answer||q.reply||'',
          read: !!(q.answer||q.reply),
          fromAdmin: !!q.fromAdmin,
          ts:q.ts||q.date||Date.now()
        }));
      }catch(_){ return []; }
    }

    // â”€â”€ í…Œì´ë¸” ë Œë”
    function orderRow(o){
      const bank = (o.bankName&&o.bankAccount) ? `${o.bankName} ${o.bankAccount} (${o.bankHolder||''})` : (o.depositAccount||'');
      const depAmt = (o.depositAmount!=null) ? Number(o.depositAmount).toLocaleString('ko-KR') : (o.totalPrice!=null?Number(o.totalPrice).toLocaleString('ko-KR'):'-');
      return `
        <tr>
          <td>${o.id||o.orderId||'-'}</td>
          <td>${o.item||'ê³¨ë“œë°”'}</td>
          <td style="text-align:right;">${o.don ?? (o.qty ?? '-')}</td>
          <td style="text-align:right;">${Number(o.supplyPrice||o.supply||0).toLocaleString('ko-KR')}</td>
          <td style="text-align:right;">${Number(o.currentPrice||o.price||0).toLocaleString('ko-KR')}</td>
          <td style="text-align:right;">${Number(o.totalPrice||o.amount||0).toLocaleString('ko-KR')}</td>
          <td style="text-align:right;">${Number(o.priceDiff||0).toLocaleString('ko-KR')}</td>
          <td>${o.status||'-'}</td>
          <td>${bank||'-'}</td>
          <td style="text-align:right;">${depAmt||'-'}</td>
          <td>${new Date(o.ts||o.date||Date.now()).toLocaleString('ko-KR')}</td>
        </tr>`;
    }
    function renderOrders(list){
      const el=$('#ordersContainer');
      if(!Array.isArray(list)||!list.length){ el.innerHTML='<div class="orders-empty">ì—†ìŒ</div>'; return; }
      el.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€</th><th>í˜„ì¬ê°€</th><th>ì´ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìƒíƒœ</th><th>ì…ê¸ˆ ê³„ì¢Œ</th><th>ì…ê¸ˆ ê¸ˆì•¡</th><th>ì¼ì‹œ</th>' +
        '</tr></thead><tbody>' +
        list.map(orderRow).join('') + '</tbody></table>';
    }
    function renderMessages(list){
      const el=$('#messagesWrap');
      if(!Array.isArray(list)||!list.length){ el.innerHTML='<div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      el.innerHTML = list.slice().reverse().map(m=>`
        <div class="msg-item" style="background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="flex:1;">
              ${m.fromAdmin?'<strong style="color:#FFD700;">[ê´€ë¦¬ì]</strong> ':''}
              ${m.title?`<strong>${m.title}</strong> â€” `:''}${m.content||''}
              ${m.answer?`<div style="margin-top:6px;color:#b2dfdb;">â†³ ê´€ë¦¬ì ë‹µë³€: ${m.answer}</div>`:''}
            </div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${m.answer?'#2e7d32':(m.read?'#455a64':'#b71c1c')};color:#fff;white-space:nowrap;">
              ${m.answer?'ë‹µë³€ì™„ë£Œ':(m.read?'ì½ìŒ':'ë¯¸ì½ìŒ')}
            </span>
          </div>
          <div style="font-size:11px;color:#888;margin-top:4px;">${new Date(m.ts||Date.now()).toLocaleString('ko-KR')}</div>
        </div>`).join('');
    }

    // â”€â”€ ê¸ˆì‹œì„¸(ì„¹ì…˜1ê³¼ ë™ì¼ ì†ŒìŠ¤ ìš°ì„ )
    async function getCurrentGoldPrice(){
      try{
        const r = await fetch('/api/security?type=goldprice&ts='+Date.now(),{cache:'no-store'});
        const j = await r.json();
        const manual = Number(j?.manualGoldPrice||0);
        if (manual>0) return manual;
        const price = Number(j?.price||0);
        if (price>0) return price;
      }catch(_){}
      try{ if (typeof GSApp?.goldPrice === 'number') return GSApp.goldPrice; }catch(_){}
      return 0;
    }

    // â”€â”€ ì£¼ë¬¸ ì‹œíŠ¸
    const productList=[0.5,1,2,3,5,10];
    let totalDon=0, supplyPrice=520000, currentPrice=0;

    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }
    function updateOrderCalc(){
      $('#totalDon').textContent= totalDon;
      $('#supplyPrice').textContent= Number(supplyPrice).toLocaleString('ko-KR');
      $('#currentPrice').textContent= Number(currentPrice).toLocaleString('ko-KR');
      const total= totalDon*supplyPrice, curr= totalDon*currentPrice;
      $('#totalPrice').textContent = total.toLocaleString('ko-KR');
      $('#currentTotal').textContent = curr.toLocaleString('ko-KR');
      $('#priceDiff').textContent = (curr-total).toLocaleString('ko-KR');
    }
    (function renderPills(){
      const wrap=$('#productBtns'); wrap.innerHTML='';
      productList.forEach(d=>{
        const b=document.createElement('button');
        b.className='pill'; b.textContent=`${d}ëˆ`;
        b.addEventListener('click',()=>{ totalDon+=d; updateOrderCalc(); });
        wrap.appendChild(b);
      });
    })();

    // â”€â”€ ìš°í¸ë²ˆí˜¸: ì‹¤ì œ ë¡œë”©ì„ ë¨¼ì € ì‹œë„í•˜ê³ , ì„±ê³µ ì‹œ ì„ë² ë“œ ë ˆì´ì–´ ì‚¬ìš©
    function showPostcodeLayer(){
      const layer = $('#postcodeLayer');
      layer.classList.add('show');
      const wrap = $('#postcodeWrap'); wrap.innerHTML='';
      const pc = new daum.Postcode({
        oncomplete: function(data){
          const roadAddr = data.roadAddress; // ë„ë¡œëª…
          const jibunAddr = data.jibunAddress; // ì§€ë²ˆ
          let extra = '';
          if(data.bname && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) extra += data.bname;
          if(data.buildingName && data.apartment === 'Y') extra += (extra ? ', ' + data.buildingName : data.buildingName);
          $('#zipcode').value = data.zonecode;
          $('#roadAddress').value = roadAddr || '';
          $('#jibunAddress').value = jibunAddr || '';
          $('#extraAddress').value = extra || '';
          ['zipcode','roadAddress','jibunAddress'].forEach(id=>$('#'+id).readOnly=true);
          $('#detailAddress').focus();
          layer.classList.remove('show');
        },
        width:'100%',
        height:'100%'
      });
      pc.embed(wrap);
    }
    $('#postcodeClose')?.addEventListener('click', ()=> $('#postcodeLayer').classList.remove('show'));

    async function loadScript(url, timeout=8000){
      return new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true; s.crossOrigin='anonymous';
        let done=false;
        const to=setTimeout(()=>{ if(done) return; done=true; s.remove(); rej(new Error('timeout')); }, timeout);
        s.onload=()=>{ if(done) return; done=true; clearTimeout(to); res(true); };
        s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); rej(new Error('load error')); };
        document.head.appendChild(s);
      });
    }
    async function ensurePostcodeLib(){
      if (window.daum?.Postcode) return true;
      const candidates = [
        'https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js',
        'https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js'
      ];
      for (const u of candidates){
        try{ await loadScript(u, 8000); if (window.daum?.Postcode) return true; }catch(_){}
      }
      return false;
    }
    function enableManualAddress(){
      ['zipcode','roadAddress','jibunAddress','detailAddress','extraAddress'].forEach(id=>{
        const el = $('#'+id); if (el){ el.readOnly = false; el.classList.remove('muted'); }
      });
    }
    async function openZipSearch(){
      const loader = $('#zipLoading'); loader.classList.add('show');
      let ok=false;
      try{ ok = await ensurePostcodeLib(); }finally{ loader.classList.remove('show'); }
      if (!ok){
        const retry = confirm('ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ì— ì ‘ì†ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬/ë¸Œë¼ìš°ì € ì„¤ì • ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\n\në‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (retry) return openZipSearch();
        alert('ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸/ì£¼ì†Œë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        enableManualAddress();
        return;
      }
      // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì„±ê³µ â†’ ì„ë² ë“œ ë ˆì´ì–´ë¡œ í‘œì‹œ(íŒì—… ì°¨ë‹¨ ì˜í–¥ ì—†ìŒ)
      showPostcodeLayer();
    }
    $('#btnFindZip')?.addEventListener('click', openZipSearch);
    $('#btnManualZip')?.addEventListener('click', ()=>{
      enableManualAddress();
      alert('ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸/ì£¼ì†Œë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    });

    function validateAddress(){
      const zip = $('#zipcode').value.trim();
      const road= $('#roadAddress').value.trim();
      const jibun=$('#jibunAddress').value.trim();
      const detail=$('#detailAddress').value.trim();
      if (!zip){ alert('ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì¡°íšŒí•´ ì£¼ì„¸ìš”.'); $('#zipcode').focus(); return false; }
      if (!road && !jibun){ alert('ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œ ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.'); (!road?$('#roadAddress'):$('#jibunAddress')).focus(); return false; }
      if (!detail){ alert('ìƒì„¸ ì£¼ì†Œ(ë™/í˜¸)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); $('#detailAddress').focus(); return false; }
      return true;
    }

    // â”€â”€ ì €ì¥ ë„ìš°ë¯¸ (USERSì™€ ë™ì¼í•œ ì•”í˜¸í™” êµ¬ì¡° í˜¸í™˜)
    async function pickArrayForSave(getUrl){
      try{
        const r=await fetch(getUrl,{cache:'no-store',credentials:'include'});
        const j=await r.json();
        let arr = await pickArrayDecrypt(j);
        if (!Array.isArray(arr) && typeof arr==='object'){ arr = Object.values(arr); }
        return Array.isArray(arr) ? arr : [];
      }catch(_){ return []; }
    }
    async function saveOrderToKV(order){
      try{
        const arr = await pickArrayForSave('/api/orders');
        arr.push({
          ...order,
          user: order.username,           // admin orders.js í˜¸í™˜
          amount: order.totalPrice,
          date: new Date(order.ts).toISOString()
        });
        if (!window.encrypt) throw new Error('encrypt ì—†ìŒ');
        const enc = await window.encrypt(arr);
        const r2=await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:enc})});
        return r2.ok;
      }catch(e){
        console.warn('ORDERS ì €ì¥ ì‹¤íŒ¨:', e);
        try{
          const r=await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userOrder:order})});
          return r.ok;
        }catch(_){ return false; }
      }
    }
    async function saveInquiryToKV(rec){
      try{
        const arr = await pickArrayForSave('/api/inquiries');
        arr.push(rec);
        if (!window.encrypt) throw new Error('encrypt ì—†ìŒ');
        const enc = await window.encrypt(arr);
        const r2=await fetch('/api/inquiries',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:enc})});
        return r2.ok;
      }catch(e){
        console.warn('INQUIRIES ì €ì¥ ì‹¤íŒ¨:', e);
        try{
          const r=await fetch('/api/inquiries',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userInquiry:rec})});
          return r.ok;
        }catch(_){ return false; }
      }
    }

    // â”€â”€ ë²„íŠ¼ ì´ë²¤íŠ¸
    $('#addOrderBtn')?.addEventListener('click', async ()=>{
      const u = await getUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='login.html'; return; }
      window.__CURRENT_USER = u;
      currentPrice = await getCurrentGoldPrice();
      if (!currentPrice) currentPrice = 550000; // ì•ˆì „ê°’
      openOrderPanel(); updateOrderCalc();
    });

    $('#orderSubmit')?.addEventListener('click', async ()=>{
      const u = await getUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      if (totalDon <= 0) return alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
      if (!validateAddress()) return;

      const addr = {
        zipcode: $('#zipcode').value.trim(),
        road: $('#roadAddress').value.trim(),
        jibun: $('#jibunAddress').value.trim(),
        detail: $('#detailAddress').value.trim(),
        extra: $('#extraAddress').value.trim()
      };

      const order = {
        id:'O'+Date.now(),
        username:u.username, name:u.name, phone:u.phone, email:u.email,
        item:'ê³¨ë“œë°”',
        don: totalDon, supplyPrice, currentPrice,
        totalPrice: totalDon*supplyPrice, currentTotal: totalDon*currentPrice,
        priceDiff: (totalDon*currentPrice)-(totalDon*supplyPrice),
        status:'ì£¼ë¬¸ ìŠ¹ì¸ ëŒ€ê¸°',
        address: addr,
        ts:Date.now()
      };

      const ok = await saveOrderToKV(order);
      if (!ok){ alert('ì£¼ë¬¸ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderPanel();

      // ì¦‰ì‹œ ê°±ì‹ 
      renderOrders(await loadOrdersForUser(u));
    });

    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      const u = await getUser();
      if (!u){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const txt = $('#msgInput').value.trim(); if(!txt) return;
      const rec = {
        id:'Q'+Date.now(),
        user: u.username||u.email,
        title:'ì‚¬ìš©ì ë¬¸ì˜',
        content:txt,
        date:new Date().toISOString(),
        status:'ë¯¸ë‹µë³€'
      };
      const ok = await saveInquiryToKV(rec);
      if (!ok){ alert('ë¬¸ì˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
      $('#msgInput').value='';
      renderMessages(await loadInquiriesForUser(u));
    });

    $('#closeOrderPanel')?.addEventListener('click', ()=> closeOrderPanel());
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    $('#logoutBtn')?.addEventListener('click', ()=>{
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ window.AdminAuth?.logout?.(); }catch(_){}
      try{ window.GSApp?.logout?.(); }catch(_){}
      try{ [...LS_KEYS,'admin_session_v1'].forEach(k=>localStorage.removeItem(k)); }catch(_){}
      location.href='index.html';
    });

    // â”€â”€ ë¶€íŒ…: ì‚¬ìš©ì/ì£¼ë¬¸/ë¬¸ì˜ ë¡œë“œ + í´ë§/ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
    (async function boot(){
      window.__CURRENT_USER = fromGSApp() || fromLocal();
      if (window.__CURRENT_USER) { renderBase(window.__CURRENT_USER); }

      const u = await resolveUser();
      if (u){
        window.__CURRENT_USER = u;
        renderBase(u);
        renderOrders(await loadOrdersForUser(u));
        renderMessages(await loadInquiriesForUser(u));

        // ê´€ë¦¬ì ìŠ¹ì¸/ë‹µë³€/ìˆ˜ì •/ì‚­ì œ ë°˜ì˜
        setInterval(async ()=>{
          renderOrders(await loadOrdersForUser(u));
          renderMessages(await loadInquiriesForUser(u));
        }, 10000);

        // ë‹¤ë¥¸ íƒ­ ë³€ê²½ ë°˜ì˜
        window.addEventListener('storage', async (e)=>{
          if (['ORDERS','INQUIRIES','gs_user','gs_user_backup'].includes(e.key)){
            renderOrders(await loadOrdersForUser(u));
            renderMessages(await loadInquiriesForUser(u));
          }
        });
      }
    })();
  });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:860px;margin:0 auto;color:#fff;padding:10px 20px 60px;}
    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:14px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.3s;}
    .btn:hover{background:#00897B;}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><img src="img/logo.png" data-i18n-alt="alt_logo" alt="logo"/></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1" data-i18n="nav_intro">ì†Œê°œ</a></li>
          <li><a href="index.html#section2" data-i18n="nav_progress">ì§„í–‰</a></li>
          <li><a href="index.html#section3" data-i18n="nav_video">ì˜ìƒ</a></li>
          <li><a href="index.html#section4" data-i18n="nav_history">ì´ë ¥</a></li>
          <li><a href="index.html#section5" data-i18n="nav_contact">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <div id="userArea" class="user-area"></div>
        <a href="index.html" class="home-icon" aria-label="í™ˆ" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;">
          <span style="font-size:30px;color:#FFD700;">ğŸ </span>
        </a>
        <span id="navProfileBtn" style="display:none;margin-left:12px;"><a href="profile.html" style="color:#FFD700;font-weight:bold;font-size:16px;text-decoration:none;">ë‚´ì •ë³´</a></span>
        <div class="menu-btn" data-i18n-aria="aria_menu_open" aria-label="ë©”ë‰´" role="button" tabindex="0"><span></span><span></span><span></span></div>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;" data-i18n="page_profile_title">ë‚´ ì •ë³´</h1>
        <div id="summaryLine" style="font-size:15px;color:#eee;font-weight:500;line-height:1.4;"></div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn" data-i18n="btn_order_add">ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn" id="mockOrderBtn" data-i18n="btn_mock_order_add" style="display:none;">ëª¨ì˜ ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="profile-card" id="profileCard" hidden>
        <h2 data-i18n="section_member_info">íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <div class="profile-card">
        <h2 data-i18n="section_orders">ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"></div>
      </div>

      <div class="profile-card">
        <h2 data-i18n="section_messages">1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" data-i18n-ph="placeholder_message" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:90px;" data-i18n="btn_send">ë³´ë‚´ê¸°</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;" data-i18n="note_admin_only_reply">ê´€ë¦¬ìë§Œ ë‹µë³€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ìƒí’ˆ ì„ íƒ ëª¨ë‹¬ -->
  <div id="orderModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:linear-gradient(135deg,#102522 80%,#1d4d46 100%);padding:40px 36px 32px 36px;border-radius:22px;max-width:440px;width:92vw;margin:0 auto;box-shadow:0 0 32px #000;">
      <h2 style="color:#FFD700;font-size:1.6em;margin-bottom:18px;text-align:center;letter-spacing:1px;">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>
      <div id="productBtns" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:22px;justify-content:center;"></div>

      <div style="margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;background:#0c1a18;border-radius:10px;padding:12px 18px;">
        <span style="font-size:1.1em;color:#FFD700;font-weight:600;">ì´ ëˆìˆ˜</span>
        <strong id="totalDon" style="font-size:1.3em;color:#4fc3f7;">0</strong>
        <button id="resetDon" class="btn" style="margin-left:18px;background:#b71c1c;color:#fff;">ë¦¬ì…‹</button>
      </div>

      <div style="margin-bottom:14px;background:#102522;border-radius:10px;padding:12px 18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="color:#FFD700;font-weight:600;">ê³µê¸‰ê°€(ì›)</span>
          <strong id="supplyPrice" style="font-size:1.15em;color:#FFD700;">-</strong>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <span style="color:#FFD700;font-weight:600;">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span>
          <strong id="totalPrice" style="font-size:1.15em;color:#FFD700;">-</strong>
        </div>
      </div>

      <div style="margin-bottom:14px;background:#0c1a18;border-radius:10px;padding:12px 18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="color:#4fc3f7;font-weight:600;">í˜„ì¬ê°€(ì›)</span>
          <strong id="currentPrice" style="font-size:1.15em;color:#4fc3f7;">-</strong>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <span style="color:#4fc3f7;font-weight:600;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span>
          <strong id="currentTotal" style="font-size:1.15em;color:#4fc3f7;">-</strong>
        </div>
      </div>

      <div style="margin-bottom:18px;background:#181818;border-radius:10px;padding:12px 18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="color:#FFD700;font-weight:600;">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span>
          <strong id="priceDiff" style="font-size:1.15em;color:#FFD700;">-</strong>
        </div>
      </div>

      <button id="orderSubmit" class="btn" style="width:100%;margin-top:18px;font-size:1.15em;background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button>
      <button id="closeOrderModal" class="btn danger" style="width:100%;margin-top:8px;">ë‹«ê¸°</button>
    </div>
  </div>

  <script src="app.js" defer></script>

  <script>
  // ëª¨ë“  ì½”ë“œëŠ” DOMì´ ì¤€ë¹„ëœ ë’¤ì— í•œ ë²ˆë§Œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (sel, p=document)=>p.querySelector(sel);

    // ë©”ë‰´ ë²„íŠ¼
    const menuBtn = $('.menu-btn');
    if (menuBtn) {
      menuBtn.addEventListener('click', () => {
        menuBtn.classList.toggle('active');
        document.querySelector('.nav-links')?.classList.toggle('active');
      });
    }

    // ì„¸ì…˜ ë³´ì¡´: í™ˆ ì•„ì´ì½˜ í´ë¦­ ì‹œ í˜„ì¬ ìœ ì €ë¥¼ localStorageì— í™•ì‹¤íˆ ë‚¨ê¹€
    const homeIcon = document.querySelector('.home-icon');
    if (homeIcon) {
      homeIcon.addEventListener('click', () => {
        try {
          if (window.GSApp && typeof GSApp.currentUser === 'function') {
            const u = GSApp.currentUser();
            if (u) {
              localStorage.setItem('gs_user', JSON.stringify(u)); // index.htmlì—ì„œ ë³µì› ê°€ëŠ¥
              // ë°±ì—… í‚¤ë„ ìƒì„±(ë§Œì•½ indexì—ì„œ gs_userë¥¼ ì§€ì›Œë„ ë³µêµ¬ ì—¬ì§€ í™•ë³´)
              localStorage.setItem('gs_user_backup', JSON.stringify(u));
            }
          }
        } catch (_) {}
        // ê¸°ë³¸ ì´ë™(ì„¸ì…˜ì€ localStorageë¡œ ìœ ì§€)
      });
    }

    // ë¡œê·¸ì¸ ìƒíƒœë©´ "ë‚´ì •ë³´" ë²„íŠ¼ ë…¸ì¶œ
    try {
      const u = window.GSApp && GSApp.currentUser ? GSApp.currentUser() : null;
      if (u && u.role !== 'admin') {
        $('#navProfileBtn').style.display = 'inline-block';
      }
    } catch(_) {}

    // --------- ìœ í‹¸: UI ë Œë” ----------
    function renderOrders(list){
      const container = $('#ordersContainer');
      if(!container) return;
      if(!Array.isArray(list) || !list.length){
        container.innerHTML = '<div class="orders-empty" data-i18n="orders_empty">ì—†ìŒ</div>';
        window.GSApp?.applyLang?.();
        return;
      }
      container.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€</th><th>í˜„ì¬ê°€</th><th>ì´ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìƒíƒœ</th><th>ì¼ì‹œ</th>' +
        '</tr></thead><tbody>' +
        list.map(o => `
          <tr>
            <td>${o.id}</td>
            <td>ê³¨ë“œë°”</td>
            <td style="text-align:right;">${o.don}</td>
            <td style="text-align:right;">${Number(o.supplyPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.currentPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.totalPrice||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.priceDiff||0).toLocaleString('ko-KR')}</td>
            <td>${o.status||'-'}</td>
            <td>${new Date(o.ts||Date.now()).toLocaleString('ko-KR')}</td>
          </tr>`).join('') +
        '</tbody></table>';
    }

    function renderMessages(list){
      const wrap = $('#messagesWrap');
      if(!wrap) return;
      if(!Array.isArray(list) || !list.length){
        wrap.innerHTML = '<div class="orders-empty" data-i18n="messages_empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        window.GSApp?.applyLang?.();
        return;
      }
      wrap.innerHTML = list.slice().reverse().map(m=>{
        const status = m.answered ? GSApp.t?.('status_answered') || 'ë‹µë³€ì™„ë£Œ'
                      : (m.read ? GSApp.t?.('status_read') || 'ì½ìŒ'
                                : GSApp.t?.('status_unread') || 'ë¯¸ì½ìŒ');
        return `
          <div class="msg-item" data-id="${m.id}" style="background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:8px;position:relative;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <div style="flex:1;">${m.fromAdmin ? '<strong style="color:#FFD700;">[ê´€ë¦¬ì]</strong> ' : ''}${m.content}</div>
              <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${m.answered?'#2e7d32':(m.read?'#455a64':'#b71c1c')};color:#fff;white-space:nowrap;">${status}</span>
            </div>
            <div style="font-size:11px;color:#888;margin-top:4px;">${new Date(m.ts).toLocaleString('ko-KR')}</div>
          </div>`;
      }).join('');

      // ì½ìŒ ì²˜ë¦¬
      try {
        const user = GSApp.currentUser?.();
        if (user && Array.isArray(user.messages)) {
          let changed = false;
          user.messages.forEach(m => {
            if (!m.read && !m.fromAdmin) { m.read = true; changed = true; }
          });
          if (changed) GSApp.saveDB?.();
        }
      } catch(_) {}
      window.GSApp?.applyLang?.();
    }

    function renderProfileSummary(user){
      const sum = $('#summaryLine');
      if (sum && user) {
        sum.innerHTML = `<strong>${user.username}</strong> | ${user.name} | ${user.phone} | ${user.email}`;
      }
    }

    // --------- ë°ì´í„°/ë™ì‘ ----------
    function loadProfile(){
      const user = window.GSApp?.currentUser?.();
      if(!user){
        if(confirm('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì… í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          window.location.href = 'signup.html';
        }
        return;
      }
      // ê°„ë‹¨ ìš”ì•½
      renderProfileSummary(user);

      // í”„ë¡œí•„ ì¹´ë“œ
      const grid = $('#profileGrid');
      const profileCard = $('#profileCard');
      if (profileCard) profileCard.hidden = false;
      if (grid) {
        grid.innerHTML = '';
        const fields = [
          ['ì•„ì´ë””', user.username],
          ['ì´ë¦„', user.name],
          ['ìƒë…„ì›”ì¼', user.birth],
          ['ì—°ë½ì²˜', user.phone],
          ['ì´ë©”ì¼', user.email],
          ['ì€í–‰', user.bank || '-'],
          ['ê³„ì¢Œë²ˆí˜¸', user.account || '-'],
          ['ê°€ì…ì¼', user.created ? new Date(user.created).toLocaleString('ko-KR') : '-'],
          ['ê¶Œí•œ', user.role]
        ];
        fields.forEach(([l,v])=>{
          const div = document.createElement('div');
          div.className = 'field';
          div.innerHTML = `<label>${l}</label><span>${v || '-'}</span>`;
          grid.appendChild(div);
        });
      }

      renderOrders(user.orders || []);
      renderMessages(user.messages || []);
    }

    // --------- ì£¼ë¬¸ ëª¨ë‹¬/ê³„ì‚° ----------
    const productList = [0.5, 1, 2, 3, 5, 10];
    let totalDon = 0;
    let supplyPrice = 520000;  // TODO: ì‹¤ì œ ê³µê¸‰ê°€ API ì—°ë™
    let currentPrice = 550000; // TODO: ì‹¤ì œ ê¸ˆì‹œì„¸ API ì—°ë™
    const orderStatusList = [
      'ì£¼ë¬¸ ìŠ¹ì¸ ëŒ€ê¸°',
      'ì£¼ë¬¸ ìŠ¹ì¸(ì…ê¸ˆëŒ€ê¸°)',
      'ì…ê¸ˆí™•ì¸',
      'ìƒí’ˆì¤€ë¹„ì¤‘',
      'ë°°ì†¡ëŒ€ê¸°',
      'ì£¼ë¬¸ì˜¤ë¥˜'
    ];

    function openOrderModal(){
      $('#orderModal').style.display = 'flex';
      totalDon = 0;

      // ê¸ˆì‹œì„¸ ë™ê¸°í™”(ìˆìœ¼ë©´ ì‚¬ìš©)
      try {
        if (window.GSApp && typeof GSApp.goldPrice === 'number') {
          currentPrice = GSApp.goldPrice;
        }
      } catch(_) {}

      updateOrderCalc();
    }
    function closeOrderModal(){ $('#orderModal').style.display = 'none'; }
    function updateOrderCalc(){
      $('#totalDon').textContent = totalDon;
      $('#supplyPrice').textContent = Number(supplyPrice).toLocaleString('ko-KR');
      $('#currentPrice').textContent = Number(currentPrice).toLocaleString('ko-KR');
      const totalPrice = totalDon * supplyPrice;
      $('#totalPrice').textContent = totalPrice.toLocaleString('ko-KR');
      const currentTotal = totalDon * currentPrice;
      $('#currentTotal').textContent = currentTotal.toLocaleString('ko-KR');
      $('#priceDiff').textContent = (currentTotal - totalPrice).toLocaleString('ko-KR');
    }

    // ë²„íŠ¼/ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $('#addOrderBtn')?.addEventListener('click', openOrderModal);
    $('#closeOrderModal')?.addEventListener('click', closeOrderModal);
    $('#resetDon')?.addEventListener('click', () => { totalDon = 0; updateOrderCalc(); });
    $('#orderSubmit')?.addEventListener('click', async () => {
      if (totalDon <= 0) return alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.');
      const user = window.GSApp?.currentUser?.();
      if (!user) return alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');

      const order = {
        id: 'order_' + Date.now(),
        username: user.username,
        name: user.name,
        phone: user.phone,
        email: user.email,
        don: totalDon,
        supplyPrice,
        currentPrice,
        totalPrice: totalDon * supplyPrice,
        currentTotal: totalDon * currentPrice,
        priceDiff: (totalDon * currentPrice) - (totalDon * supplyPrice),
        status: orderStatusList[0],
        ts: Date.now()
      };

      // ORDERS APIì— ì—…ë¡œë“œ(ë°±ì—”ë“œ ìˆìŒ)
      try {
        await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
      } catch (e) {
        console.warn('ì£¼ë¬¸ API ì‹¤íŒ¨, ë¡œì»¬ë§Œ ë°˜ì˜:', e);
      }

      // ë¡œì»¬ DBì—ë„ ë°˜ì˜
      try { await window.GSApp?.addOrder?.(user.email, { item:'ê³¨ë“œë°”', qty: order.don, price: order.totalPrice }); } catch(_){}

      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderModal();
      loadProfile();
    });

    // ìƒí’ˆ ë²„íŠ¼ êµ¬ì„±
    const btnWrap = $('#productBtns');
    if (btnWrap) {
      btnWrap.innerHTML = '';
      productList.forEach(don => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = `${don}ëˆ`;
        b.style.background = '#004d40';
        b.style.color = '#FFD700';
        b.style.fontWeight = '700';
        b.style.fontSize = '1.08em';
        b.style.border = '2px solid #FFD700';
        b.style.borderRadius = '8px';
        b.style.marginBottom = '6px';
        b.addEventListener('click', () => { totalDon += don; updateOrderCalc(); });
        btnWrap.appendChild(b);
      });
    }

    // --------- ë©”ì‹œì§€ ì „ì†¡ ----------
    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      const user = window.GSApp?.currentUser?.();
      if(!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      const txt = $('#msgInput').value.trim();
      if(!txt) return;
      try {
        await window.GSApp?.addMessage?.(user.email, txt, false);
      } catch(e) {
        console.warn('ë©”ì‹œì§€ ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', e);
      }
      $('#msgInput').value = '';
      loadProfile();
    });

    // --------- ë¡œê·¸ì•„ì›ƒ ----------
    $('#logoutBtn')?.addEventListener('click', ()=>{
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try { window.GSApp?.logout?.(); } catch(_) {}
      try { localStorage.removeItem('gs_user'); } catch(_) {}
      window.location.href = 'index.html';
    });

    // ì´ˆê¸° ë¡œë“œ
    loadProfile();
    try { window.GSApp?.applyLang?.(); } catch(_) {}
  });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <!-- AdminAuth ì„¸ì…˜(ìˆìœ¼ë©´ ì‚¬ìš©) -->
  <script src="/admin/auth.js" defer></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:1600px;margin:0 auto;color:#fff;padding:10px 20px 80px;}

    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}

    /* ê¸°ë³¸ì •ë³´ ì˜ì—­ - ë°˜ì‘í˜• ìœ ì§€ */
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;min-width:0;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;word-break:break-word;overflow-wrap:anywhere;}

    @media (max-width:1024px){ .profile-wrapper{padding:10px 16px 64px;} }
    @media (max-width:720px) { .profile-card{padding:22px;} .actions{flex-wrap:wrap;} }
    @media (max-width:480px){ .profile-card{padding:18px;} }

    /* ì£¼ë¬¸í‘œ ë°˜ì‘í˜• ìœ ì§€ */
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:auto;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;vertical-align:top;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}

    .actions{display:flex;gap:10px;margin-top:10px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.25s;will-change:transform,box-shadow;}
    .btn:hover{background:#00897B;transform:translateY(-2px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25);}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
    .pill{ background:#004d40; color:#FFD700; border:2px solid #FFD700; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.25s; }
    .pill:hover{ transform:translateY(-2px) scale(1.04); box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25); }

    /* ì£¼ë¬¸ íŒ¨ë„ */
    #orderPanel{ position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,0.65); align-items:stretch; justify-content:flex-end; }
    #orderPanel.show{ display:flex; }
    #orderSheet{ width:min(720px, 96vw); background:linear-gradient(135deg,#102522 80%,#1d4d46 100%); height:100%; overflow:auto; box-shadow:0 0 32px #000; border-left:1px solid #1d4d46; transform:translateX(100%); transition:transform .28s ease; }
    #orderPanel.show #orderSheet{ transform:translateX(0); }
    .sheet-close{ position:sticky; top:0; display:flex; justify-content:flex-end; padding:12px; background:linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); }
    .sheet-body{ padding:8px 22px 24px 22px; color:#fff; }
    .sheet-h{ color:#FFD700; font-size:1.4em; margin:8px 0 14px; text-align:left; letter-spacing:.5px; }

    .kpi{ background:#0c1a18; border-radius:10px; padding:12px 16px; margin:10px 0; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .lab{ color:#FFD700; font-weight:600; }
    .val{ font-size:1.15em; }
    .pill-wrap{ display:flex; gap:10px; flex-wrap:wrap; }

    .addr-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px 14px; margin-top:12px; align-items:start; }
    .addr-grid label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:#FFD700; font-weight:700; background:#0c1a18; padding:12px 14px; border-radius:10px; }
    .addr-grid input, .addr-grid textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:8px; border:1px solid #1e4d47; background:#071412; color:#fff; box-sizing:border-box; }
    .addr-row{ display:flex; gap:8px; align-items:center; }
    .addr-row input{ flex:1; }
    .addr-help{ font-size:12px; color:#9bd3ff; margin-top:4px; }

    .sheet-actions .btn{ width:100%; margin-top:12px; font-size:1.08em; }

    .home-icon{display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;}
    .home-icon span{font-size:30px;color:#FFD700;}
    #summaryLine{display:none;}

    /* ì„¸ì…˜ ì§„ë‹¨ ë°•ìŠ¤ */
    .diag {background:#0c1a18;border:1px dashed #1e4d47;border-radius:10px;padding:10px 12px;margin:6px 0 14px;}
    .diag small{color:#9bd3ff;}
    .diag .kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px;}
    .diag .kv div{word-break:break-word;}
    .diag .row{display:flex;gap:10px;align-items:center;margin-top:8px;}
    .linklike{cursor:pointer;color:#9bd3ff;text-decoration:underline;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><a href="index.html" id="homeLogo"><img src="img/logo.png" alt="ê³¨ë“œìŠ¤íƒ€ ë¡œê³ " style="height:52px;"></a></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <a href="index.html" class="home-icon" aria-label="í™ˆ"><span>ğŸ </span></a>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">ë‚´ ì •ë³´</h1>
        <div id="summaryLine"></div>

        <!-- â–½ ì„¸ì…˜/ë°ì´í„° ì§„ë‹¨(í† ê¸€ ê°€ëŠ¥) - ìˆ¨ê¹€ ì²˜ë¦¬ -->
        <div id="diagBox" class="diag" style="display:none;">
          <div><small>ì„¸ì…˜/ë°ì´í„° ìƒíƒœ</small></div>
          <div class="kv" style="margin-top:6px;">
            <div>ì„¸ì…˜ìƒíƒœ</div><div id="sessState">-</div>
            <div>ì„¸ì…˜ì†ŒìŠ¤</div><div id="sessSource">-</div>
            <div>ì•„ì´ë””</div><div id="sessUser">-</div>
            <div>ì´ë©”ì¼</div><div id="sessEmail">-</div>
            <div>USERS</div><div id="cntUsers">-</div>
            <div>ORDERS</div><div id="cntOrders">-</div>
            <div>INQUIRIES</div><div id="cntInq">-</div>
          </div>
          <div class="row">
            <button id="btnReload" class="btn">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
        </div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn" disabled>ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
          <span style="margin-left:8px;">ì„¸ì…˜ ìƒíƒœ: <span id="diagMsg" style="color:#FFD700;font-weight:bold;">í™•ì¸ì¤‘...</span></span>
        </div>
      </div>

      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="profile-card" id="profileCard">
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid">
          <div style="color:#aaa;">ë¡œë”© ì¤‘â€¦</div>
        </div>
      </div>

      <!-- ì£¼ë¬¸ ë‚´ì—­ -->
      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div id="ordersContainer"><div class="orders-empty">ë¡œë”© ì¤‘â€¦</div></div>
      </div>

      <!-- 1:1 ë¬¸ì˜ -->
      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"><div class="orders-empty">ë¡œë”© ì¤‘â€¦</div></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:120px;" disabled>ë¬¸ì˜ ë“±ë¡</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">ê´€ë¦¬ì ë‹µë³€ì€ ë¬¸ì˜ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ í¼ì³ì§‘ë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ì£¼ë¬¸ íŒ¨ë„ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>

        <!-- ëˆìˆ˜ ë²„íŠ¼ -->
        <div class="pill-wrap" id="productBtns"></div>

        <!-- ì œì‘ ìœ í˜• ì„ íƒ -->
        <h3 class="sheet-h" style="font-size:1.15em;margin-top:14px;">ì œì‘ ìœ í˜• ì„ íƒ</h3>
        <div class="kpi">
          <select id="productType" style="width:100%;padding:12px;border-radius:8px;border:1px solid #1e4d47;background:#071412;color:#fff;font-size:14px;">
            <option value="basic">ê³¨ë“œë°” (ê¸°ë³¸, ì¶”ê°€ë¹„ ì—†ìŒ)</option>
            <option value="key">í™©ê¸ˆ ì—´ì‡  (ì¶”ê°€ë¹„ 5ë§Œì›)</option>
            <option value="pig">í™©ê¸ˆ ë¼ì§€ (ì¶”ê°€ë¹„ 5ë§Œì›)</option>
            <option value="clover">ë„¤ì í´ë¡œë²„ (ì¶”ê°€ë¹„ 5ë§Œì›)</option>
            <option value="custom">ì»¤ìŠ¤í…€ (ì§ì ‘ì…ë ¥, ê´€ë¦¬ì ë¬¸ì˜)</option>
          </select>
          <div id="typeNotice" style="margin-top:8px;font-size:12px;color:#888;">3ëˆ ì´í•˜ëŠ” ê³¨ë“œë°” í˜•íƒœë¡œ í†µì¼ ì œì‘ë©ë‹ˆë‹¤.</div>
          <div id="customMessage" style="margin-top:8px;font-size:12px;color:#4fc3f7;display:none;">ê´€ë¦¬ìì—ê²Œ ë©”ì‹œì§€ë¡œ ì›í•˜ì‹œëŠ” ìœ í˜•ì„ ë³´ë‚´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- ì´ ëˆìˆ˜ -->
        <div class="kpi row">
          <span class="lab">ì´ ëˆìˆ˜</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">ë¦¬ì…‹</button>
          </div>
        </div>

        <!-- ê³µê¸‰ê°€/ì´ê¸ˆì•¡ -->
        <div class="kpi">
          <div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <!-- í˜„ì¬ê°€/ì°¨ì•¡/ì…ê¸ˆê¸ˆì•¡(50%) -->
        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì…ê¸ˆ ê¸ˆì•¡ (ì´ê¸ˆì•¡ì˜ 50%)</span><strong id="depositAmount" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="addr-help">(ë‚˜ë¨¸ì§€ 50%ëŠ” ë°°ì†¡ ì‹œì‘ ì „ ì…ê¸ˆ)</div>
        </div>

        <!-- ë°°ì†¡ì§€ ì…ë ¥ -->
        <h3 class="sheet-h" style="font-size:1.15em;margin-top:14px;">ë°°ì†¡ì§€ ì •ë³´</h3>
        <div class="addr-grid">
          <label>ìˆ˜ë ¹ì¸
            <input id="recvName" placeholder="ì´ë¦„" autocomplete="name">
          </label>
          <label>ì—°ë½ì²˜
            <input id="recvPhone" placeholder="010-1234-5678" autocomplete="tel">
          </label>

          <label style="grid-column:1 / span 2;">ìš°í¸ë²ˆí˜¸
            <div class="addr-row">
              <input id="postCode" placeholder="ìš°í¸ë²ˆí˜¸" autocomplete="postal-code">
              <button class="btn" id="btnFindPostcode">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
              <button class="btn" id="btnManualPostcode">ì§ì ‘ ì…ë ¥</button>
            </div>
            <div class="addr-help" id="postcodeHelp" style="display:none;"></div>
          </label>

          <label style="grid-column:1 / span 2;">ì£¼ì†Œ(ë„ë¡œëª…/ì§€ë²ˆ)
            <input id="addr1" placeholder="ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œ" autocomplete="address-line1">
          </label>
          <label style="grid-column:1 / span 2;">ìƒì„¸ ì£¼ì†Œ
            <input id="addr2" placeholder="ë™/í˜¸ìˆ˜ ë“± ìƒì„¸" autocomplete="address-line2">
          </label>

          <label style="grid-column:1 / span 2;">ìš”ì²­ì‚¬í•­
            <textarea id="memo" rows="3" placeholder="ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì ì–´ì£¼ì„¸ìš”"></textarea>
          </label>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì£¼ë¬¸ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
  <div id="orderDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;padding:20px;overflow:auto;">
    <div style="max-width:800px;margin:0 auto;background:linear-gradient(135deg,#102522 80%,#1d4d46 100%);border-radius:12px;padding:30px;color:#fff;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="color:#FFD700;margin:0;">ì£¼ë¬¸ ìƒì„¸ ì •ë³´</h2>
        <button onclick="closeOrderDetail()" style="background:#b71c1c;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">ë‹«ê¸°</button>
      </div>
      <div id="orderDetailContent">
        <!-- ì£¼ë¬¸ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê° -->
      </div>
      <div style="margin-top:20px;padding-top:20px;border-top:1px solid #1e4d47;">
        <h3 style="color:#FFD700;margin-bottom:10px;">ê±°ë˜ì¦ëª…ì„œ ì²¨ë¶€</h3>
        <input type="file" id="receiptUpload" accept="image/*" style="margin-bottom:10px;">
        <div id="receiptPreview" style="margin-top:10px;"></div>
        <button onclick="uploadReceipt()" class="btn" style="margin-top:10px;">ì¦ëª…ì„œ ì—…ë¡œë“œ</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /*** ì§§ì€ ë³„ì¹­ ***/
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    /*** ====== [ì„¸ì…˜] - ë™ê¸°/ë¹„ë™ê¸° ëª¨ë‘ ëŒ€ì‘ + ì‚¬ìš©ì í™•ì¸ìš© ë©”ì‹œì§€ ====== ***/
    const ADMIN_KEY='admin_session_v1', GS_KEY='gs_user';
    function ls(key){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):null; }catch{ return null; } }
    async function maybe(fn){ try{ const v=fn?.(); return (v&&typeof v.then==='function')?await v:v; }catch{ return null; } }

    async function getAdminSession(){ return (await maybe(()=>window.AdminAuth?.currentSession?.())) || ls(ADMIN_KEY); }
    async function getGsSession(){ return (await maybe(()=>window.GSApp?.currentUser?.())) || ls(GS_KEY); }

    function normalizeSession(s, source){
      if(!s) return null;
      const email=(s.email||'').trim();
      // username, userId, id ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš©
      const username=(s.username||s.userId||s.id||s.user||(email?email.split('@')[0]: '')||'').trim();
      return {
        source,
        username,
        email,
        name:s.name||s.displayName||s.realName||'',
        phone:s.phone||s.phoneNumber||'',
        role:s.role||'user',
        status:s.status||'active',
        token:s.token||s.jwt||s.idToken||null,
        raw:s
      };
    }

    let SESSION=null;
    function setSession(s){
      SESSION=s;
      try{
        if(s){ localStorage.setItem('gs_user', JSON.stringify(s.raw||s)); localStorage.setItem('gs_logged_in','1'); }
      }catch{}
      updateSessionUI();
    }

    /** ì„¸ì…˜ ìƒíƒœ/ì§„ë‹¨ ë©”ì‹œì§€ UI **/
    const diagBox = $('#diagBox'), sessState=$('#sessState'), sessSource=$('#sessSource'), sessUser=$('#sessUser'), sessEmail=$('#sessEmail');
    const cntUsers=$('#cntUsers'), cntOrders=$('#cntOrders'), cntInq=$('#cntInq'), diagMsg=$('#diagMsg');
    // ì§„ë‹¨ ë°•ìŠ¤ í´ë¦­ ë¹„í™œì„±í™” (ìƒì„¸ ì •ë³´ ìˆ¨ê¹€)
    // $('#toggleDiag').addEventListener('click', ()=>{ diagBox.hidden=!diagBox.hidden; });

    function updateSessionUI(){
      const ready=!!(SESSION&&SESSION.username);
      $('#addOrderBtn').disabled=!ready;
      $('#sendMsgBtn').disabled=!ready;
      sessState.textContent = ready? 'ì—°ê²°ë¨' : 'ëŒ€ê¸°/ì—†ìŒ';
      sessSource.textContent= SESSION?.source || '-';
      sessUser.textContent  = SESSION?.username || '-';
      sessEmail.textContent = SESSION?.email || '-';
    }

    async function resolveSession(){
      diagMsg.textContent='ì„¸ì…˜ í™•ì¸ì¤‘...';
      
      // localStorageì—ì„œ ì§ì ‘ ì„¸ì…˜ í™•ì¸ (ë¡œê·¸ì¸ ì™„ë£Œ ìƒíƒœë¼ë©´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìŒ)
      try {
        // ë¨¼ì € ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì €ì¥í•˜ëŠ” "user" í‚¤ í™•ì¸
        const loginUserData = JSON.parse(localStorage.getItem('user') || 'null');
        const adminSession = JSON.parse(localStorage.getItem('admin_session_v1') || 'null');
        const gsSession = JSON.parse(localStorage.getItem('gs_user') || 'null');
        
        console.log('ì„¸ì…˜ í™•ì¸:', { loginUserData, adminSession, gsSession });
        
        // "user" í‚¤ì—ì„œ ë¡œê·¸ì¸ ë°ì´í„° í™•ì¸ (ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì €ì¥)
        if (loginUserData && (loginUserData.username || loginUserData.userId || loginUserData.id)) {
          const normalized = normalizeSession(loginUserData, 'Login');
          console.log('Login ì„¸ì…˜ ì‚¬ìš©:', normalized);
          setSession(normalized);
          diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì„±ê³µ';
          return;
        }
        
        // admin_session_v1 í™•ì¸
        if (adminSession && (adminSession.username || adminSession.user)) {
          const normalized = normalizeSession(adminSession, 'LocalStorage');
          console.log('Admin ì„¸ì…˜ ì‚¬ìš©:', normalized);
          setSession(normalized);
          diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì„±ê³µ';
          return;
        }
        
        // gs_user í™•ì¸
        if (gsSession && (gsSession.username || gsSession.user)) {
          const normalized = normalizeSession(gsSession, 'LocalStorage');
          console.log('GS ì„¸ì…˜ ì‚¬ìš©:', normalized);
          setSession(normalized);
          diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì„±ê³µ';
          return;
        }
        
        // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const loggedIn = localStorage.getItem('gs_logged_in');
        if (loggedIn) {
          // ë¡œê·¸ì¸ ìƒíƒœ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ ì„¸ì…˜ ìƒì„±
          console.log('ë¡œê·¸ì¸ ë§ˆì»¤ ë°œê²¬, ê¸°ë³¸ ì„¸ì…˜ ìƒì„±');
          const defaultSession = {
            username: 'user_' + Date.now(),
            name: 'ì‚¬ìš©ì',
            role: 'user',
            status: 'active'
          };
          setSession(normalizeSession(defaultSession, 'Default'));
          diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì„±ê³µ';
          return;
        }
        
        console.log('ì„¸ì…˜ ì—†ìŒ');
        diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨';
        
      } catch(e) {
        console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', e);
        diagMsg.textContent='ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨';
      }
    }

    /*** ====== [ê³µí†µ í†µì‹ /íŒŒì„œ] ====== ***/
    const fmt=n=>Number(n||0).toLocaleString('ko-KR');

    async function fetchAsJSON(url, init={}){
      const headers=new Headers(init.headers||{});
      headers.set('Accept','application/json, text/plain, */*');
      const token=SESSION?.token;
      if(token && !headers.has('Authorization')) headers.set('Authorization','Bearer '+token);
      const resp=await fetch(url,{cache:'no-store',credentials:'include',...init,headers});
      if(!resp.ok) throw new Error(url+' '+resp.status);
      const ct=resp.headers.get('content-type')||'';
      if(/application\/json/i.test(ct)) return await resp.json();
      // jsonì´ ì•„ë‹ˆë©´ textâ†’json ì‹œë„
      const t=await resp.text();
      try{ return JSON.parse(t); }catch{ return {data:t}; }
    }
    async function safeDecrypt(payload){
      try{
        if(!payload) return [];
        const r = window.decrypt ? window.decrypt(payload) : payload;
        return (r && typeof r.then==='function') ? await r : r;
      }catch{ return []; }
    }
    async function kvToArray(payload){
      try{
        if(!payload) return [];
        if(Array.isArray(payload)) return payload;
        let cand = payload?.data ?? payload?.list ?? payload?.items ?? payload?.values ??
                   payload?.value ?? payload?.records ?? payload?.result ?? payload?.results;
        if(!cand && typeof payload==='object'){
          for(const k of Object.keys(payload)){ if(Array.isArray(payload[k])){ cand=payload[k]; break; } }
        }
        if(Array.isArray(cand)) return cand;
        const maybeMap = cand || payload;
        if(maybeMap && typeof maybeMap==='object' && !Array.isArray(maybeMap)){
          const vals=Object.values(maybeMap);
          if(vals.length && vals.every(v=>typeof v==='object')) return vals;
        }
        async function tryStr(str){
          try{ const j=JSON.parse(str); if(Array.isArray(j))return j; if(Array.isArray(j?.data))return j.data; }catch{}
          if(window.decrypt){
            const dec=await window.decrypt(str);
            try{ const j2=JSON.parse(dec); if(Array.isArray(j2))return j2; if(Array.isArray(j2?.data))return j2.data; }catch{}
          }
          return null;
        }
        if(typeof cand==='string'){ const r=await tryStr(cand); if(r) return r; }
        if(typeof payload?.data==='string'){ const r=await tryStr(payload.data); if(r) return r; }
        if(typeof payload==='string'){ const r=await tryStr(payload); if(r) return r; }
        return [];
      }catch{ return []; }
    }
    async function kvLoad(url){
      const j = await fetchAsJSON(url);
      // ì•”í˜¸í™” ëŒ€ì‘
      if (j && typeof j==='object' && 'data' in j && typeof j.data !== 'object'){
        const dec = await safeDecrypt(j.data);
        return await kvToArray(dec);
      }
      return await kvToArray(j);
    }
    async function kvSave(url, list){
      const payload = { data: await (window.encrypt? window.encrypt(list): list) };
      // ì²« ì‹œë„: data ë˜í•‘
      try{
        await fetchAsJSON(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        return true;
      }catch(_){}
      // í›„ë°© í˜¸í™˜: ë°°ì—´ ê·¸ëŒ€ë¡œ
      try{
        await fetchAsJSON(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(list)});
        return true;
      }catch(e){ console.error('KV save fail',e); return false; }
    }

    /*** ====== [ìœ ì €/ì£¼ë¬¸/ë¬¸ì˜ ë¡œë”©] ====== ***/
    let CURRENT_USER=null;
    let cacheUsers=[], cacheOrders=[], cacheInq=[];

    function matchToMe(item){
      // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì—ì„œëŠ” ì¤‘ì²©ì´ ì—†ì´ ì§ì ‘ ì ‘ê·¼
      let checkItem = item;
      if (item && item.userInquiry) {
        checkItem = item.userInquiry;
      }
      
      const uname=(SESSION?.username|| (SESSION?.email?SESSION.email.split('@')[0]:'') || '').trim();
      const mail =(CURRENT_USER?.email||SESSION?.email||'').trim().toLowerCase();
      const ufields=[checkItem.user,checkItem.username,checkItem.member,checkItem.uid,checkItem.userId,checkItem.userid];
      const mfields=[checkItem.email,checkItem.userEmail];
      
      console.log('matchToMe ì²´í¬:', {
        sessionUsername: uname,
        sessionEmail: mail,
        itemFields: { user: checkItem.user, username: checkItem.username, email: checkItem.email },
        originalItem: item,
        checkItem: checkItem
      });
      
      const hitUser=ufields.some(v=>(v||'').toString().trim()===uname);
      const hitMail=mfields.some(v=>(v||'').toString().trim().toLowerCase()===mail);
      const result = hitUser || (mail && hitMail);
      
      console.log('ë§¤ì¹­ ê²°ê³¼:', { hitUser, hitMail, result });
      return result;
    }

    async function loadUsers(){
      try{ cacheUsers = await kvLoad('/api/users'); cntUsers.textContent = cacheUsers.length; }
      catch{ cacheUsers=[]; cntUsers.textContent='err'; }
    }
    async function resolveCurrentUser(){
      const uname=(SESSION?.username|| (SESSION?.email?SESSION.email.split('@')[0]:'') || '').trim();
      const mail =(SESSION?.email||'').trim().toLowerCase();
      console.log('resolveCurrentUser:', {uname, mail, cacheUsers: cacheUsers.length});
      let u = cacheUsers.find(x=>(x.username||'').trim()===uname) ||
              cacheUsers.find(x=> mail && (x.email||'').trim().toLowerCase()===mail);
      if(!u && uname){
        // KVì—ì„œ ëª»ì°¾ìœ¼ë©´ ì„¸ì…˜ ì •ë³´ë¡œ ê¸°ë³¸ ì‚¬ìš©ì ìƒì„±
        u = { 
          username: uname, 
          name: SESSION?.name || uname, 
          email: mail || '', 
          phone: SESSION?.phone || '', 
          role: 'user', 
          status: 'active',
          created: Date.now() 
        };
        console.log('Created fallback user:', u);
      }
      CURRENT_USER=u;
      console.log('CURRENT_USER set to:', CURRENT_USER);
    }
    function renderProfileGrid(u){
      const grid=$('#profileGrid'), card=$('#profileCard');
      grid.innerHTML='';
      if(!u || !u.username){
        grid.innerHTML='<div class="field" style="grid-column:1/-1;text-align:center;color:#888;">íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      const fields=[
        ['ì´ë¦„', u.name||'-'],
        ['ì•„ì´ë””', u.username||'-'],
        ['ì—°ë½ì²˜', u.phone||'-'],
        ['ì´ë©”ì¼', u.email||'-'],
        ['ì€í–‰', u.bank||'-'],
        ['ê³„ì¢Œë²ˆí˜¸', u.account||'-'],
        ['ê°€ì…ì¼', u.created ? new Date(u.created).toLocaleString('ko-KR') : '-'],
        ['ìƒíƒœ', u.status||'-']
      ];
      for(const [l,v] of fields){
        const d=document.createElement('div');
        d.className='field';
        d.innerHTML=`<label>${l}</label><span>${v}</span>`;
        grid.appendChild(d);
      }
    }
    function renderProfileSummary(u){
      const sum=$('#summaryLine');
      if(sum) sum.textContent=`${u.name||''} (${u.username||''})`;
    }

    async function loadOrders(){
      try{ cacheOrders = await kvLoad('/api/orders'); cntOrders.textContent = cacheOrders.length; }
      catch{ cacheOrders=[]; cntOrders.textContent='err'; }
    }
    async function renderOrders(){
      const el=$('#ordersContainer');
      const mine=cacheOrders.filter(matchToMe);
      if(!mine.length){ el.innerHTML='<div class="orders-empty">ì—†ìŒ</div>'; return; }
      el.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆ</th><th>ëˆìˆ˜</th><th>ê³µê¸‰ê°€(ì›)</th><th>ì´ê¸ˆì•¡(ì›)</th><th>ì…ê¸ˆê¸ˆì•¡(50%)</th><th>ìƒíƒœ</th><th>ì¼ì‹œ</th><th>ìƒì„¸</th>' +
        '</tr></thead><tbody>' +
        mine.map((o,i)=>{
          const don=Number(o.don||o.qty||0);
          const sup=Number(o.supplyPrice||520000);
          const total=Number(o.totalPrice || (don*sup));
          const deposit=Math.round(total*0.5);
          const dt=o.date||o.created||o.createdAt|| (o.ts? new Date(o.ts).toISOString() : '');
          return `<tr>
            <td>${o.id||'-'}</td>
            <td>ê³¨ë“œë°”</td>
            <td style="text-align:right;">${don}</td>
            <td style="text-align:right;">${fmt(sup)}</td>
            <td style="text-align:right;">${fmt(total)}</td>
            <td style="text-align:right;">${fmt(deposit)}</td>
            <td>${o.status||'-'}</td>
            <td>${dt? new Date(dt).toLocaleString('ko-KR'):'-'}</td>
            <td><button class="btn" onclick="showOrderDetail(${i})" style="padding:4px 8px;font-size:12px;">ìƒì„¸ë³´ê¸°</button></td>
          </tr>`;
        }).join('') + '</tbody></table>';
    }

    async function loadInquiries(){
      try{ 
        const rawData = await kvLoad('/api/inquiries'); 
        console.log('ì›ë³¸ ë¬¸ì˜ ë°ì´í„°:', rawData);
        
        // ìƒˆë¡œìš´ êµ¬ì¡°: {data: [...]} ë˜ëŠ” ê¸°ì¡´ ë°°ì—´ êµ¬ì¡° ëª¨ë‘ ì§€ì›
        if (rawData && rawData.data && Array.isArray(rawData.data)) {
          // ìƒˆë¡œìš´ êµ¬ì¡°: {data: [...]} - ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•íƒœì˜ ë¬¸ì˜ ë°ì´í„°
          cacheInq = rawData.data;
        } else if (Array.isArray(rawData)) {
          // ê¸°ì¡´ ë°°ì—´ êµ¬ì¡°
          cacheInq = rawData.map(item => {
            if (item && item.userInquiry) {
              return item.userInquiry;
            }
            return item;
          }).filter(item => item && typeof item === 'object');
        } else {
          cacheInq = [];
        }
        
        console.log('ì²˜ë¦¬ëœ ë¬¸ì˜ ë°ì´í„°:', cacheInq);
        cntInq.textContent = cacheInq.length; 
      }
      catch(e){ 
        console.error('ë¬¸ì˜ ë¡œë”© ì˜¤ë¥˜:', e);
        cacheInq=[]; 
        cntInq.textContent='err'; 
      }
    }
    function pickText(m){ 
      console.log('pickText for message:', m);
      
      // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì—ì„œëŠ” ì§ì ‘ ì ‘ê·¼
      let checkItem = m;
      if (m && m.userInquiry) {
        console.log('userInquiry ë˜í•‘ëœ ë°ì´í„°:', m.userInquiry);
        checkItem = m.userInquiry;
      }
      
      const content = checkItem.content||checkItem.message||checkItem.body||checkItem.text||checkItem.desc||checkItem.question||checkItem.inquiry||'ë‚´ìš© ì—†ìŒ';
      console.log('ì¶”ì¶œëœ content:', content);
      return content;
    }
    function pickTime(m){ 
      // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì—ì„œëŠ” ì§ì ‘ ì ‘ê·¼
      let checkItem = m;
      if (m && m.userInquiry) {
        checkItem = m.userInquiry;
      }
      
      const dt=checkItem.date||checkItem.created||checkItem.createdAt||(checkItem.ts? new Date(checkItem.ts).toISOString(): ''); 
      return dt? new Date(dt).toLocaleString('ko-KR') : ''; 
    }
    function pickAns(m){ 
      // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì—ì„œëŠ” ì§ì ‘ ì ‘ê·¼
      let checkItem = m;
      if (m && m.userInquiry) {
        checkItem = m.userInquiry;
      }
      return checkItem.answer||checkItem.adminAnswer||checkItem.reply||checkItem.adminReply||checkItem.response||''; 
    }

    async function renderInquiries(){
      const wrap=$('#messagesWrap');
      const mine=cacheInq.filter(matchToMe);
      
      console.log('ì „ì²´ ë¬¸ì˜ ë°ì´í„°:', cacheInq);
      console.log('ë‚´ ë¬¸ì˜ í•„í„°ë§ ê²°ê³¼:', mine);
      console.log('í˜„ì¬ SESSION:', SESSION);
      console.log('í˜„ì¬ CURRENT_USER:', CURRENT_USER);
      
      // í•„í„°ë§ëœ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì„ì‹œë¡œ ëª¨ë“  ë¬¸ì˜ë¥¼ ë³´ì—¬ì¤Œ (ë””ë²„ê¹…ìš©)
      let displayInquiries = mine;
      if(!mine.length && cacheInq.length > 0) {
        console.log('í•„í„°ë§ëœ ë¬¸ì˜ê°€ ì—†ì–´ì„œ ëª¨ë“  ë¬¸ì˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ (ë””ë²„ê¹…ìš©)');
        displayInquiries = cacheInq;
      }
      
      if(!displayInquiries.length){ 
        wrap.innerHTML='<div class="orders-empty">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
        return; 
      }
      
      wrap.innerHTML = displayInquiries.slice().reverse().map(m=>{
        console.log('ë Œë”ë§í•  ë¬¸ì˜:', m);
        
        // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì—ì„œëŠ” ì§ì ‘ ì ‘ê·¼ (ì¤‘ì²© ì—†ìŒ)
        let displayItem = m;
        if (m && m.userInquiry) {
          displayItem = m.userInquiry;
        }
        
        const ans = pickAns(m);
        const status = ans ? 'ë‹µë³€ì™„ë£Œ' : (displayItem.status || 'ë¯¸ë‹µë³€');
        const textContent = pickText(m);
        const timeContent = pickTime(m);
        const titleContent = displayItem.title || '1:1 ë¬¸ì˜';
        const authorInfo = displayItem.user || displayItem.username || displayItem.email || 'ì•Œ ìˆ˜ ì—†ìŒ';
        
        console.log('ë¬¸ì˜ ë Œë”ë§ ì •ë³´:', {
          title: titleContent,
          content: textContent,
          time: timeContent,
          author: authorInfo,
          status: status,
          rawItem: displayItem
        });
        
        // ì„ì‹œë¡œ í‘œì‹œë˜ëŠ” ë¬¸ì˜ëŠ” ë°°ê²½ìƒ‰ì„ ë‹¤ë¥´ê²Œ í‘œì‹œ
        const isFiltered = mine.includes(m);
        const bgColor = isFiltered ? '#0c1a18' : '#1a0c18'; // ë‚´ ë¬¸ì˜ê°€ ì•„ë‹ˆë©´ ë¶‰ì€ ë°°ê²½
        
        // ê¸°ë³¸: ë‚´ ë¬¸ì˜ ë‚´ìš©ì€ í•­ìƒ ë³´ì„, ë‹µë³€ì€ í´ë¦­í•´ì„œ í¼ì¹¨
        return `
        <details class="msg-item" ${ans ? '' : ''} style="background:${bgColor};padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:10px;">
          <summary style="display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer;">
            <div style="font-weight:600;">${titleContent} ${!isFiltered ? '(ì „ì²´)' : ''}</div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${status==='ë‹µë³€ì™„ë£Œ'?'#2e7d32':(status==='ë¯¸ë‹µë³€'?'#b71c1c':'#455a64')};color:#fff;white-space:nowrap;">${status}</span>
          </summary>
          <div style="margin-top:8px;white-space:pre-wrap;">${textContent}</div>
          ${ans ? `<div style="margin-top:8px;padding:8px 10px;background:#08221f;border:1px solid #1e4d47;border-radius:8px;"><strong style="color:#FFD700;">[ë‹µë³€]</strong> ${ans}</div>` : ''}
          <div style="font-size:11px;color:#888;margin-top:6px;">${timeContent} | ì‘ì„±ì: ${authorInfo}</div>
        </details>`;
      }).join('');
    }

    /*** ====== ì£¼ë¬¸ íŒ¨ë„/ì´ë²¤íŠ¸ (ë™ì‘ì€ ê¸°ì¡´ ìœ ì§€) ====== ***/
    let supplyPrice=520000, currentPrice=0, totalDon=0;
    function updateOrderCalc(){
      $('#totalDon').textContent=totalDon;
      $('#supplyPrice').textContent=fmt(supplyPrice);
      $('#currentPrice').textContent=fmt(currentPrice||0);
      
      // ì œì‘ ìœ í˜•ë³„ ì¶”ê°€ë¹„ ê³„ì‚°
      const productType = $('#productType').value;
      let additionalFee = 0;
      if (totalDon > 3) { // 3ëˆ ì´ˆê³¼ì¼ ë•Œë§Œ ì¶”ê°€ë¹„ ì ìš©
        switch(productType) {
          case 'key':
          case 'pig':
          case 'clover':
            additionalFee = 50000;
            break;
          case 'custom':
            additionalFee = 0; // ê´€ë¦¬ì ë¬¸ì˜
            break;
        }
      }
      
      const totalPrice=totalDon*supplyPrice + additionalFee;
      const currentTotal=totalDon*(currentPrice||0) + additionalFee;
      $('#totalPrice').textContent=fmt(totalPrice);
      $('#currentTotal').textContent=fmt(currentTotal);
      $('#priceDiff').textContent=fmt(currentTotal-totalPrice);
      $('#depositAmount').textContent=fmt(Math.round(totalPrice*0.5));
      
      // ì œì‘ ìœ í˜•ë³„ ë©”ì‹œì§€ í‘œì‹œ
      const typeNotice = $('#typeNotice');
      const customMessage = $('#customMessage');
      
      if (totalDon <= 3) {
        typeNotice.textContent = '3ëˆ ì´í•˜ëŠ” ê³¨ë“œë°” í˜•íƒœë¡œ í†µì¼ ì œì‘ë©ë‹ˆë‹¤.';
        typeNotice.style.display = 'block';
        $('#productType').disabled = true;
        $('#productType').value = 'basic';
      } else {
        typeNotice.textContent = '3ëˆ ì´ìƒë¶€í„° ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        typeNotice.style.display = 'block';
        $('#productType').disabled = false;
      }
      
      if (productType === 'custom' && totalDon > 3) {
        customMessage.style.display = 'block';
      } else {
        customMessage.style.display = 'none';
      }
      
      const requiredAddr = ($('#postCode').value.trim() && $('#addr1').value.trim());
      $('#orderSubmit').disabled = !(totalDon>0 && requiredAddr && SESSION && SESSION.username);
    }
    const productList=[0.5,1,2,3,5,10];
    const btnWrap=$('#productBtns'); btnWrap.innerHTML='';
    productList.forEach(d=>{
      const b=document.createElement('button');
      b.className='pill'; b.textContent=`${d}ëˆ`;
      b.addEventListener('click',()=>{totalDon+=d;updateOrderCalc();});
      btnWrap.appendChild(b);
    });
    function openOrderPanel(){ if(!SESSION||!SESSION.username) return; $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }
    $('#addOrderBtn').addEventListener('click', openOrderPanel);
    $('#closeOrderPanel').addEventListener('click', closeOrderPanel);
    $('#resetDon').addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });
    
    // ì œì‘ ìœ í˜• ë³€ê²½ ì´ë²¤íŠ¸
    document.addEventListener('change', (e) => {
      if (e.target.id === 'productType') {
        updateOrderCalc();
      }
    });

    // ê°„ë‹¨í•œ í˜„ì¬ê°€ ë¡œë”©(ì‹¤íŒ¨í•´ë„ ì£¼ë¬¸ ê°€ëŠ¥)
    (async()=>{ try{ const j=await fetchAsJSON('/api/security?type=goldprice'); const manual=j?.manualGoldPrice?Number(j.manualGoldPrice):0; if(manual>0) currentPrice=manual; }catch{} })();

    // ìš°í¸ë²ˆí˜¸
    let postcodeManual=false;
    async function ensureDaum(){ if(window.daum&&window.daum.Postcode) return true; return new Promise(r=>{ const s=document.createElement('script'); s.src='https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js'; s.onload=()=>r(true); s.onerror=()=>r(false); document.head.appendChild(s); }); }
    async function openPostcode(){
      $('#postcodeHelp').style.display='none';
      if(postcodeManual){ alert('ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤.'); return; }
      const ok=await ensureDaum(); if(!ok){ $('#postcodeHelp').style.display='block'; $('#postcodeHelp').textContent='ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; return; }
      new daum.Postcode({ oncomplete: d=>{ $('#postCode').value=d.zonecode||''; $('#addr1').value=d.roadAddress||d.jibunAddress||''; updateOrderCalc(); } }).open();
    }
    $('#btnFindPostcode').addEventListener('click', openPostcode);
    $('#btnManualPostcode').addEventListener('click', ()=>{ postcodeManual=!postcodeManual; $('#btnManualPostcode').textContent=postcodeManual?'ìë™ê²€ìƒ‰ ì‚¬ìš©':'ì§ì ‘ ì…ë ¥'; $('#postcodeHelp').style.display='block'; $('#postcodeHelp').textContent=postcodeManual?'ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤.':'ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ëª¨ë“œì…ë‹ˆë‹¤.'; });
    ['postCode','addr1','addr2','recvName','recvPhone','memo'].forEach(id=> $('#'+id).addEventListener('input', updateOrderCalc));

    // ì£¼ë¬¸ ìš”ì²­
    $('#orderSubmit').addEventListener('click', async ()=>{
      if(!SESSION||!SESSION.username) return;
      if(!CURRENT_USER) return;
      if(totalDon<=0){ alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if(!$('#postCode').value.trim() || !$('#addr1').value.trim()){ alert('ë°°ì†¡ì§€(ìš°í¸ë²ˆí˜¸/ì£¼ì†Œ)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
      
      // ì œì‘ ìœ í˜•ë³„ ì¶”ê°€ë¹„ ê³„ì‚°
      const productType = $('#productType').value;
      let additionalFee = 0;
      let productTypeName = 'ê³¨ë“œë°”';
      
      if (totalDon > 3) {
        switch(productType) {
          case 'key':
            additionalFee = 50000;
            productTypeName = 'í™©ê¸ˆ ì—´ì‡ ';
            break;
          case 'pig':
            additionalFee = 50000;
            productTypeName = 'í™©ê¸ˆ ë¼ì§€';
            break;
          case 'clover':
            additionalFee = 50000;
            productTypeName = 'ë„¤ì í´ë¡œë²„';
            break;
          case 'custom':
            additionalFee = 0;
            productTypeName = 'ì»¤ìŠ¤í…€';
            break;
          default:
            productTypeName = 'ê³¨ë“œë°”';
        }
      }
      
      const finalTotalPrice = totalDon*supplyPrice + additionalFee;
      const addressInfo = {
        postCode: $('#postCode').value.trim(),
        addr1: $('#addr1').value.trim(),
        addr2: $('#addr2').value.trim(),
        recvName: $('#recvName').value.trim(),
        recvPhone: $('#recvPhone').value.trim()
      };
      
      const order={
        id:'O'+Date.now(),
        date:new Date().toISOString(),
        user:SESSION.username, username:SESSION.username,
        name:CURRENT_USER.name, email:CURRENT_USER.email, phone:CURRENT_USER.phone,
        don:totalDon, supplyPrice, currentPrice,
        productType: productType,
        productTypeName: productTypeName,
        additionalFee: additionalFee,
        totalPrice: finalTotalPrice,
        depositAmount: Math.round(finalTotalPrice*0.5),
        address: addressInfo,
        memo:$('#memo').value.trim(), 
        status:'ì£¼ë¬¸ ìŠ¹ì¸ ëŒ€ê¸°'
      };
      
      // ì£¼ë¬¸ ì €ì¥
      const orderList=[...cacheOrders, order];
      const orderOk=await kvSave('/api/orders', orderList);
      if(!orderOk){ alert('ì£¼ë¬¸ ì €ì¥ ì‹¤íŒ¨'); return; }
      
      // ì‚¬ìš©ì ì£¼ì†Œ ì •ë³´ë„ USERSì— ì—…ë°ì´íŠ¸
      try {
        const userIndex = cacheUsers.findIndex(u => u.username === SESSION.username);
        if (userIndex !== -1) {
          cacheUsers[userIndex] = {
            ...cacheUsers[userIndex],
            address: addressInfo,
            updated: new Date().toISOString()
          };
          const userOk = await kvSave('/api/users', cacheUsers);
          if (!userOk) {
            console.warn('ì‚¬ìš©ì ì£¼ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
          }
        }
      } catch (e) {
        console.warn('ì‚¬ìš©ì ì£¼ì†Œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
      }
      
      cacheOrders=orderList;
      closeOrderPanel();
      await fullReload();
      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // 1:1 ë¬¸ì˜ ë“±ë¡
    $('#sendMsgBtn').addEventListener('click', async ()=>{
      if(!SESSION||!SESSION.username) return;
      if(!CURRENT_USER) return;
      const txt=$('#msgInput').value.trim(); if(!txt) return;
      const inq={ id:'Q'+Date.now(), user:SESSION.username, username:SESSION.username, email:CURRENT_USER.email, phone:CURRENT_USER.phone, title:'1:1 ë¬¸ì˜', content:txt, ts:Date.now(), date:new Date().toISOString(), status:'ë¯¸ë‹µë³€' };
      
      // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì €ì¥: {data: [...]}
      const updatedList = [inq, ...cacheInq];
      const payload = { data: updatedList };
      const ok=await kvSave('/api/inquiries', payload);
      if(!ok){ alert('ë¬¸ì˜ ì €ì¥ ì‹¤íŒ¨'); return; }
      
      cacheInq=updatedList;
      $('#msgInput').value='';
      await fullReload();
      alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // ì£¼ë¬¸ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ í•¨ìˆ˜ë“¤
    window.showOrderDetail = async function(index) {
      const mine = cacheOrders.filter(matchToMe);
      const order = mine[index];
      if (!order) return;
      
      const don = Number(order.don||order.qty||0);
      const sup = Number(order.supplyPrice||520000);
      const additionalFee = Number(order.additionalFee||0);
      const total = Number(order.totalPrice || (don*sup + additionalFee));
      const deposit = Math.round(total*0.5);
      const dt = order.date||order.created||order.createdAt|| (order.ts? new Date(order.ts).toISOString() : '');
      
      const addr = order.address || {};
      
      // ì€í–‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì…ê¸ˆëŒ€ê¸° ìƒíƒœì¼ ë•Œë§Œ)
      let bankInfo = '';
      if (order.status === 'ì…ê¸ˆëŒ€ê¸°') {
        try {
          const securityRes = await fetchAsJSON('/api/security');
          if (securityRes.bankInfo) {
            const bank = securityRes.bankInfo;
            bankInfo = `
              <div style="margin-top:20px;">
                <h4 style="color:#FFD700;margin-bottom:10px;">ì…ê¸ˆ ì •ë³´</h4>
                <div style="background:#0c1a18;padding:15px;border-radius:8px;border:2px solid #FFD700;">
                  <div style="margin-bottom:8px;"><strong>ì€í–‰:</strong> ${bank.bankName||'-'}</div>
                  <div style="margin-bottom:8px;"><strong>ê³„ì¢Œë²ˆí˜¸:</strong> ${bank.accountNumber||'-'}</div>
                  <div style="margin-bottom:8px;"><strong>ì˜ˆê¸ˆì£¼:</strong> ${bank.accountHolder||'-'}</div>
                  <div style="color:#FFD700;font-weight:bold;">ì…ê¸ˆê¸ˆì•¡: ${fmt(deposit)}ì›</div>
                </div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('ì€í–‰ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', e);
        }
      }
      
      document.getElementById('orderDetailContent').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div>
            <h4 style="color:#4fc3f7;margin-bottom:10px;">ì£¼ë¬¸ ì •ë³´</h4>
            <div style="background:#0c1a18;padding:15px;border-radius:8px;">
              <div style="margin-bottom:8px;"><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.id||'-'}</div>
              <div style="margin-bottom:8px;"><strong>ìƒí’ˆ:</strong> ${order.productTypeName||'ê³¨ë“œë°”'}</div>
              <div style="margin-bottom:8px;"><strong>ëˆìˆ˜:</strong> ${don}ëˆ</div>
              <div style="margin-bottom:8px;"><strong>ê³µê¸‰ê°€:</strong> ${fmt(sup)}ì›</div>
              ${additionalFee > 0 ? `<div style="margin-bottom:8px;"><strong>ì¶”ê°€ë¹„:</strong> ${fmt(additionalFee)}ì›</div>` : ''}
              <div style="margin-bottom:8px;"><strong>ì´ê¸ˆì•¡:</strong> ${fmt(total)}ì›</div>
              <div style="margin-bottom:8px;"><strong>ì…ê¸ˆê¸ˆì•¡(50%):</strong> ${fmt(deposit)}ì›</div>
              <div style="margin-bottom:8px;"><strong>ìƒíƒœ:</strong> ${order.status||'-'}</div>
              <div><strong>ì£¼ë¬¸ì¼ì‹œ:</strong> ${dt? new Date(dt).toLocaleString('ko-KR'):'-'}</div>
            </div>
          </div>
          <div>
            <h4 style="color:#4fc3f7;margin-bottom:10px;">ë°°ì†¡ ì •ë³´</h4>
            <div style="background:#0c1a18;padding:15px;border-radius:8px;">
              <div style="margin-bottom:8px;"><strong>ìˆ˜ë ¹ì¸:</strong> ${addr.recvName||'-'}</div>
              <div style="margin-bottom:8px;"><strong>ì—°ë½ì²˜:</strong> ${addr.recvPhone||'-'}</div>
              <div style="margin-bottom:8px;"><strong>ìš°í¸ë²ˆí˜¸:</strong> ${addr.postCode||'-'}</div>
              <div style="margin-bottom:8px;"><strong>ì£¼ì†Œ:</strong> ${addr.addr1||'-'}</div>
              <div style="margin-bottom:8px;"><strong>ìƒì„¸ì£¼ì†Œ:</strong> ${addr.addr2||'-'}</div>
              <div><strong>ìš”ì²­ì‚¬í•­:</strong> ${order.memo||'-'}</div>
            </div>
          </div>
        </div>
        ${bankInfo}
        ${order.receipt ? `
          <div style="margin-top:20px;">
            <h4 style="color:#4fc3f7;margin-bottom:10px;">ì—…ë¡œë“œëœ ì¦ëª…ì„œ</h4>
            <img src="${order.receipt}" style="max-width:100%;height:auto;border-radius:8px;" alt="ê±°ë˜ì¦ëª…ì„œ">
          </div>
        ` : ''}
      `;
      
      document.getElementById('orderDetailModal').style.display = 'block';
    };

    window.closeOrderDetail = function() {
      document.getElementById('orderDetailModal').style.display = 'none';
    };

    window.uploadReceipt = function() {
      const fileInput = document.getElementById('receiptUpload');
      const file = fileInput.files[0];
      if (!file) {
        alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('receiptPreview').innerHTML = `
          <img src="${e.target.result}" style="max-width:200px;height:auto;border-radius:8px;" alt="ë¯¸ë¦¬ë³´ê¸°">
        `;
        alert('ì¦ëª…ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      };
      reader.readAsDataURL(file);
    };    // ë¡œê·¸ì•„ì›ƒ (ê¸°ì¡´ ë™ì‘ ìœ ì§€)
    $('#logoutBtn').addEventListener('click', ()=>{
      if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ AdminAuth?.logout?.(); }catch{}
      try{
        localStorage.removeItem('admin_session_v1');
        localStorage.removeItem('gs_user');
        localStorage.removeItem('gs_user_backup');
        localStorage.removeItem('gs_logged_in');
        localStorage.removeItem('user'); // ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì €ì¥í•˜ëŠ” í‚¤
        localStorage.setItem('gs_logout', String(Date.now()));
      }catch{}
      location.href='index.html';
    });

    /*** ====== ì´ˆê¸° íë¦„ ====== ***/
    async function fullReload(){
      await loadUsers();         // USERS
      await resolveCurrentUser();
      renderProfileSummary(CURRENT_USER);
      renderProfileGrid(CURRENT_USER);
      await loadOrders();        // ORDERS
      await renderOrders();
      await loadInquiries();     // INQUIRIES
      await renderInquiries();
    }
    $('#btnReload').addEventListener('click', fullReload);

    (async function init(){
      console.log('Profile í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
      
      // ì„¸ì…˜ í™•ì¸ (localStorageì—ì„œ ì§ì ‘ ì½ê¸°)
      await resolveSession();
      
      // ì„¸ì…˜ì´ ìˆëŠ”ì§€ ì—„ê²©í•˜ê²Œ í™•ì¸
      console.log('ì„¸ì…˜ í™•ì¸ í›„ SESSION ìƒíƒœ:', SESSION);
      
      if (!SESSION || !SESSION.username) {
        console.log('ì„¸ì…˜ ì—†ìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href='login.html';
        return;
      }
      
      console.log('ìœ íš¨í•œ ì„¸ì…˜ í™•ì¸ë¨:', SESSION.username);
      
      // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ë°ì´í„° ë¡œë”©
      await fullReload();

      // ë‹¤ë¥¸ íƒ­ ì„¸ì…˜ ë³€í™” ê°ì§€
      window.addEventListener('storage', async (e)=>{
        if(['admin_session_v1','gs_user','user'].includes(e.key||'')){
          console.log('ë‹¤ë¥¸ íƒ­ì—ì„œ ì„¸ì…˜ ë³€í™” ê°ì§€:', e.key);
          await resolveSession();
          if (SESSION && SESSION.username) {
            await fullReload();
          } else {
            console.log('ì„¸ì…˜ ì‚­ì œë¨ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.href='login.html';
          }
        }
      });
    })();

    // í™ˆ ë¡œê³  ëˆŒë €ì„ ë•Œ ì„¸ì…˜ ìŠ¤ëƒ…ìƒ·ë§Œ ì‹¬ì–´ í™ˆì—ì„œ ë¡œê·¸ì¸ ìƒíƒœë¡œ ë³´ì´ë„ë¡(ë™ì‘ ë³€ê²½ ì—†ìŒ)
    $('#homeLogo')?.addEventListener('click', e=>{ e.preventDefault(); if(SESSION) try{ localStorage.setItem('gs_logged_in','1'); localStorage.setItem('gs_user', JSON.stringify(SESSION.raw||SESSION)); }catch{}; location.href='index.html'; });
  });
  </script>
</body>
</html>

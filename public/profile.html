<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <!-- AdminAuth 세션 사용을 위해 관리자 모듈 auth.js 로드 -->
  <script src="/admin/auth.js" defer></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>내 정보</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:1600px;margin:0 auto;color:#fff;padding:10px 20px 80px;}

    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}

    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:14px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.25s;will-change:transform,box-shadow;}
    .btn:hover{background:#00897B;transform:translateY(-2px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25);}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
    .pill{ background:#004d40; color:#FFD700; border:2px solid #FFD700; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.25s; }
    .pill:hover{ transform:translateY(-2px) scale(1.04); box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25); }

    /* 주문 패널 (우측 슬라이드) */
    #orderPanel{ position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,0.65); align-items:stretch; justify-content:flex-end; }
    #orderPanel.show{ display:flex; }
    #orderSheet{ width:min(720px, 96vw); background:linear-gradient(135deg,#102522 80%,#1d4d46 100%); height:100%; overflow:auto; box-shadow:0 0 32px #000; border-left:1px solid #1d4d46; transform:translateX(100%); transition:transform .28s ease; }
    #orderPanel.show #orderSheet{ transform:translateX(0); }
    .sheet-close{ position:sticky; top:0; display:flex; justify-content:flex-end; padding:12px; background:linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); }
    .sheet-body{ padding:8px 22px 24px 22px; color:#fff; }
    .sheet-h{ color:#FFD700; font-size:1.4em; margin:8px 0 14px; text-align:left; letter-spacing:.5px; }

    .kpi{ background:#0c1a18; border-radius:10px; padding:12px 16px; margin:10px 0; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .lab{ color:#FFD700; font-weight:600; }
    .val{ font-size:1.15em; }

    .pill-wrap{ display:flex; gap:10px; flex-wrap:wrap; }

    /* 주소 폼 그리드 */
    .addr-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 14px;
      margin-top:12px;
      align-items:start;
    }
    .addr-grid label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:#FFD700; font-weight:700; background:#0c1a18; padding:12px 14px; border-radius:10px; }
    .addr-grid input, .addr-grid textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:8px; border:1px solid #1e4d47; background:#071412; color:#fff; box-sizing:border-box; }
    .addr-row{ display:flex; gap:8px; align-items:center; }
    .addr-row input{ flex:1; }
    .addr-help{ font-size:12px; color:#9bd3ff; margin-top:4px; }

    .sheet-actions .btn{ width:100%; margin-top:12px; font-size:1.08em; }

    /* navbar 우측 홈 버튼만 */
    .home-icon{display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;}
    .home-icon span{font-size:30px;color:#FFD700;}
    /* 요약 라인(흰 텍스트) 숨김 요청 */
    #summaryLine{display:none;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><a href="index.html" id="homeLogo"><img src="img/logo.png" alt="골드스타 로고" style="height:52px;"></a></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">소개</a></li>
          <li><a href="index.html#section2">진행</a></li>
          <li><a href="index.html#section3">영상</a></li>
          <li><a href="index.html#section4">이력</a></li>
          <li><a href="index.html#section5">문의</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <!-- 회원/로그인 버튼은 숨김, 우측엔 홈만 -->
        <a href="index.html" class="home-icon" aria-label="홈"><span>🏠</span></a>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">내 정보</h1>
        <div id="summaryLine" style="font-size:15px;color:#eee;font-weight:500;line-height:1.4;"></div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn">주문 추가</button>
          <button class="btn danger" id="logoutBtn">로그아웃</button>
        </div>
      </div>

      <!-- 기본 정보 -->
      <div class="profile-card" id="profileCard" hidden>
        <h2>회원 기본 정보</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <!-- 주문 내역 -->
      <div class="profile-card">
        <h2>주문 내역</h2>
        <div id="ordersContainer"></div>
      </div>

      <!-- 1:1 문의 -->
      <div class="profile-card">
        <h2>1:1 문의</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="문의 내용을 입력하세요" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:120px;">문의 등록</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">관리자 답변이 등록되면 여기에서 확인할 수 있습니다.</p>
      </div>
    </div>
  </main>

  <!-- 주문 패널 -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">닫기</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">상품 주문 선택</h2>

        <!-- 돈수 버튼 -->
        <div class="pill-wrap" id="productBtns"></div>

        <!-- 총 돈수 -->
        <div class="kpi row">
          <span class="lab">총 돈수</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">리셋</button>
          </div>
        </div>

        <!-- 공급가/총금액 -->
        <div class="kpi">
          <div class="row"><span class="lab">공급가(원)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">총금액(공급가×돈수)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <!-- 현재가/차액/입금금액(50%) -->
        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">현재가(원)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">현재가×돈수</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">차액(현재가×돈수 - 공급가×돈수)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">입금 금액 (총금액의 50%)</span><strong id="depositAmount" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="addr-help">(나머지 50%는 배송 시작 전 입금)</div>
        </div>

        <!-- 배송지 입력 -->
        <h3 class="sheet-h" style="font-size:1.15em;margin-top:14px;">배송지 정보</h3>
        <div class="addr-grid">
          <label>수령인
            <input id="recvName" placeholder="이름" autocomplete="name">
          </label>
          <label>연락처
            <input id="recvPhone" placeholder="010-1234-5678" autocomplete="tel">
          </label>

          <label style="grid-column:1 / span 2;">우편번호
            <div class="addr-row">
              <input id="postCode" placeholder="우편번호" autocomplete="postal-code">
              <button class="btn" id="btnFindPostcode">우편번호 찾기</button>
              <button class="btn" id="btnManualPostcode">직접 입력</button>
            </div>
            <div class="addr-help" id="postcodeHelp" style="display:none;"></div>
          </label>

          <label style="grid-column:1 / span 2;">주소(도로명/지번)
            <input id="addr1" placeholder="도로명 또는 지번 주소" autocomplete="address-line1">
          </label>
          <label style="grid-column:1 / span 2;">상세 주소
            <input id="addr2" placeholder="동/호수 등 상세" autocomplete="address-line2">
          </label>

          <label style="grid-column:1 / span 2;">요청사항
            <textarea id="memo" rows="3" placeholder="요청사항이 있으면 적어주세요"></textarea>
          </label>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">주문 요청</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    // 로그인 세션 (AdminAuth)
    const SESSION_KEY = 'admin_session_v1';
    function getSession(){
      try {
        // localStorage 세션이 있으면 우선 사용
        const local = JSON.parse(localStorage.getItem(SESSION_KEY)||'null');
        if(local && local.username) return local;
        // AdminAuth.currentSession()이 있으면 사용
        const auth = AdminAuth?.currentSession?.();
        if(auth && auth.username) return auth;
        return null;
      } catch(_) { return null; }
    }
    let SESSION = getSession();
    if(!SESSION || !SESSION.username){
      alert('로그인 세션이 없습니다. 다시 로그인해 주세요.');
      location.href='login.html';
      return;
    }

    // 홈 클릭 시 세션 유지 & 메인에서 "내정보" 버튼 노출 트리거용 마커
    $('#homeLogo')?.addEventListener('click', e=>{ e.preventDefault(); localStorage.setItem('gs_logged_in','1'); location.href='index.html'; });
    document.querySelector('.home-icon')?.addEventListener('click', ()=>{ localStorage.setItem('gs_logged_in','1'); });

    // util
    const fmt = n => Number(n||0).toLocaleString('ko-KR');

    async function safeDecrypt(payload){
      try{
        if(!payload) return [];
        const r = window.decrypt ? window.decrypt(payload) : payload;
        return (r && typeof r.then==='function') ? await r : r;
      }catch(e){ return []; }
    }
    async function safeEncrypt(arr){
      const r = window.encrypt ? window.encrypt(arr) : arr;
      return (r && typeof r.then==='function') ? await r : r;
    }

    // 현재 로그인한 사용자 로드 (USERS KV)
    let CURRENT_USER = null;
    async function loadCurrentUser(){
      const res = await fetch('/api/users');
      let users = [];
      try{
        const json = await res.json();
        // 관리자 모듈(users.js)와 동일: plain array 구조
        users = Array.isArray(json) ? json : Array.isArray(json?.data) ? json.data : [];
      }catch{ users = []; }
      CURRENT_USER = users.find(u=>u.username===SESSION.username) || null;

      if(!CURRENT_USER){
        alert('회원 기본정보를 찾을 수 없습니다. 다시 로그인해 주세요.');
        return;
      }
      renderProfileSummary(CURRENT_USER);
      renderProfileGrid(CURRENT_USER);
    }

    function renderProfileSummary(u){
      const sum = $('#summaryLine'); // 숨김 상태 유지(요청사항)
      if (sum) sum.textContent = `${u.name||''} (${u.username})`;
    }
    function renderProfileGrid(u){
      const grid = $('#profileGrid'), card = $('#profileCard');
      card.hidden = false; grid.innerHTML = '';
      const fields = [
        ['이름', u.name||'-'],
        ['아이디', u.username||'-'],
        ['연락처', u.phone||'-'],
        ['이메일', u.email||'-'],
        ['은행', u.bank||'-'],
        ['계좌번호', u.account||'-'],
        ['가입일', u.created ? new Date(u.created).toLocaleString('ko-KR') : '-'],
        ['상태', u.status||'-']
      ];
      for(const [l,v] of fields){
        const div = document.createElement('div');
        div.className='field';
        div.innerHTML = `<label>${l}</label><span>${v}</span>`;
        grid.appendChild(div);
      }
    }

    // 금시세: index 섹션1과 동일 값을 쓰도록 /api/security?type=goldprice 우선
    let supplyPrice = 520000; // 고정 공급가
    let currentPrice = 0;
    async function loadGoldPrice(){
      try{
        const r = await fetch('/api/security?type=goldprice', {cache:'no-store'});
        const j = await r.json();
        const manual = j?.manualGoldPrice ? Number(j.manualGoldPrice) : 0;
        if(manual>0){ currentPrice = manual; return; }
      }catch(_){}
      // 폴백(자동 크롤링 프록시)
      try{
        const d = await fetch('https://gold-price-proxy.hanoiosaka1.workers.dev/price').then(r=>r.json());
        if(d?.price) currentPrice = Number(d.price);
      }catch(_){}
    }

    // 주문/문의 로드 & 렌더
    async function fetchOrdersAll(){
      try{
        const res = await fetch('/api/orders', {cache:'no-store'});
        const json = await res.json();
        return await safeDecrypt(json.data);
      }catch(_){ return []; }
    }
    async function fetchInquiriesAll(){
      try{
        const res = await fetch('/api/inquiries', {cache:'no-store'});
        const json = await res.json();
        return await safeDecrypt(json.data);
      }catch(_){ return []; }
    }

    async function saveOrdersAll(list){
      const encrypted = await safeEncrypt(list);
      await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data: encrypted}) });
    }
    async function saveInquiriesAll(list){
      const encrypted = await safeEncrypt(list);
      await fetch('/api/inquiries', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data: encrypted}) });
    }

    async function renderOrders(){
      const all = await fetchOrdersAll();
      const mine = all.filter(o=>{
        const u = SESSION.username;
        return (o.user===u) || (o.username===u) || (o.email && o.email===CURRENT_USER?.email);
      });
      const el = $('#ordersContainer');
      if(!mine.length){
        el.innerHTML = '<div class="orders-empty">없음</div>';
        return;
      }
      // 표: 공급가, 총금액(공급가×돈수), 입금금액(50%)
      el.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>주문번호</th><th>상품</th><th>돈수</th><th>공급가(원)</th><th>총금액(원)</th><th>입금금액(50%)</th><th>상태</th><th>일시</th>' +
        '</tr></thead><tbody>' +
        mine.map(o=>{
          const don = Number(o.don||o.qty||0);
          const sup = Number(o.supplyPrice||supplyPrice||0);
          const total = Number(o.totalPrice || (don*sup));
          const deposit = Math.round(total*0.5);
          return `<tr>
            <td>${o.id||'-'}</td>
            <td>골드바</td>
            <td style="text-align:right;">${don}</td>
            <td style="text-align:right;">${fmt(sup)}</td>
            <td style="text-align:right;">${fmt(total)}</td>
            <td style="text-align:right;">${fmt(deposit)}</td>
            <td>${o.status||'-'}</td>
            <td>${o.date?o.date:new Date(o.ts||Date.now()).toLocaleString('ko-KR')}</td>
          </tr>`;
        }).join('') +
        '</tbody></table>';
    }

    async function renderInquiries(){
      const all = await fetchInquiriesAll();
      const mine = all.filter(q=> (q.user===SESSION.username) || (q.email && q.email===CURRENT_USER?.email));
      const wrap = $('#messagesWrap');
      if(!mine.length){
        wrap.innerHTML = '<div class="orders-empty">문의가 없습니다.</div>';
        return;
      }
      wrap.innerHTML = mine.slice().reverse().map(m=>{
        const status = m.status||'미답변';
        const ans = m.answer ? `<div style="margin-top:6px;padding:8px 10px;background:#08221f;border:1px solid #1e4d47;border-radius:8px;"><strong style="color:#FFD700;">[답변]</strong> ${m.answer}</div>` : '';
        return `
        <div class="msg-item" style="background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:600;">${m.title||'1:1 문의'}</div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${status==='답변완료'?'#2e7d32':(status==='미답변'?'#b71c1c':'#455a64')};color:#fff;white-space:nowrap;">${status}</span>
          </div>
          <div style="margin-top:6px;">${m.content||m.message||''}</div>
          ${ans}
          <div style="font-size:11px;color:#888;margin-top:6px;">${m.date?m.date:new Date(m.ts||Date.now()).toLocaleString('ko-KR')}</div>
        </div>`;
      }).join('');
    }

    // 주문 패널 로직
    const productList = [0.5,1,2,3,5,10];
    let totalDon = 0;

    function openOrderPanel(){
      $('#orderPanel').classList.add('show');
      totalDon = 0;
      // 기본값 세팅 및 금시세 로드
      updateOrderCalc();
      loadGoldPrice().then(updateOrderCalc);
    }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }

    function updateOrderCalc(){
      $('#totalDon').textContent = totalDon;
      $('#supplyPrice').textContent = fmt(supplyPrice);
      $('#currentPrice').textContent = fmt(currentPrice||0);
      const totalPrice   = totalDon * supplyPrice;
      const currentTotal = totalDon * (currentPrice||0);
      $('#totalPrice').textContent   = fmt(totalPrice);
      $('#currentTotal').textContent = fmt(currentTotal);
      $('#priceDiff').textContent    = fmt(currentTotal - totalPrice);
      $('#depositAmount').textContent= fmt(Math.round(totalPrice*0.5));
      // 버튼 활성/비활성
      const requiredAddr = ($('#postCode').value.trim() && $('#addr1').value.trim());
      $('#orderSubmit').disabled = !(totalDon>0 && requiredAddr);
    }

    // 돈수 버튼
    const btnWrap = $('#productBtns'); btnWrap.innerHTML='';
    productList.forEach(don=>{
      const b=document.createElement('button');
      b.className='pill';
      b.textContent = `${don}돈`;
      b.addEventListener('click', ()=>{ totalDon += don; updateOrderCalc(); });
      btnWrap.appendChild(b);
    });

    // 주소 입력/우편번호
    let postcodeManual = false;
    async function ensureDaumPostcodeScript(){
      if(window.daum && window.daum.Postcode) return true;
      return new Promise((resolve)=>{
        const s = document.createElement('script');
        s.src = "https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        s.onload = ()=>resolve(true);
        s.onerror = ()=>resolve(false);
        document.head.appendChild(s);
      });
    }
    async function openPostcode(){
      $('#postcodeHelp').style.display='none';
      if(postcodeManual){ alert('현재 직접 입력 모드입니다. 우편번호를 직접 입력하세요.'); return; }

      const ok = await ensureDaumPostcodeScript();
      if(!ok){
        $('#postcodeHelp').style.display='block';
        $('#postcodeHelp').textContent = '우편번호 서비스에 연결되지 않았습니다. 네트워크/VPN 환경을 확인하시고, 필요 시 "직접 입력"으로 전환하세요.';
        return;
      }
      try{
        new daum.Postcode({
          oncomplete: function(data){
            // data.zonecode, data.roadAddress, data.jibunAddress
            $('#postCode').value = data.zonecode||'';
            $('#addr1').value = data.roadAddress || data.jibunAddress || '';
            updateOrderCalc();
          },
          onresize: function(){},
          width: '100%',
          height: '100%'
        }).open();
      }catch(e){
        $('#postcodeHelp').style.display='block';
        $('#postcodeHelp').textContent = '우편번호 서비스에 접속을 시도했으나 연결되지 않았습니다. 해외/VPN 환경일 수 있습니다. 필요 시 "직접 입력"을 사용해 주세요.';
      }
    }
    $('#btnFindPostcode').addEventListener('click', openPostcode);
    $('#btnManualPostcode').addEventListener('click', ()=>{
      postcodeManual = !postcodeManual;
      $('#btnManualPostcode').textContent = postcodeManual ? '자동검색 사용' : '직접 입력';
      $('#postcodeHelp').style.display='block';
      $('#postcodeHelp').textContent = postcodeManual ? '직접 입력 모드입니다. 우편번호와 주소를 직접 작성하세요.' : '우편번호 검색 모드입니다.';
    });
    ['postCode','addr1','addr2','recvName','recvPhone','memo'].forEach(id=>{
      $('#'+id).addEventListener('input', updateOrderCalc);
    });

    // 이벤트 바인딩
    $('#addOrderBtn')?.addEventListener('click', openOrderPanel);
    $('#closeOrderPanel')?.addEventListener('click', closeOrderPanel);
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    // 주문 요청
    $('#orderSubmit')?.addEventListener('click', async ()=>{
      if(!CURRENT_USER){ alert('로그인 세션 오류'); return; }
      if(totalDon<=0){ alert('상품을 선택하세요.'); return; }
      if(!$('#postCode').value.trim() || !$('#addr1').value.trim()){
        alert('배송지(우편번호/주소)를 입력해 주세요.');
        return;
      }
      const order = {
        id:'O'+Date.now(),
        date:new Date().toISOString(),
        user: SESSION.username,
        name: CURRENT_USER.name,
        email: CURRENT_USER.email,
        phone: CURRENT_USER.phone,
        don: totalDon,
        supplyPrice, currentPrice,
        totalPrice: totalDon*supplyPrice,
        depositAmount: Math.round(totalDon*supplyPrice*0.5),
        address: {
          postCode: $('#postCode').value.trim(),
          addr1: $('#addr1').value.trim(),
          addr2: $('#addr2').value.trim(),
          recvName: $('#recvName').value.trim(),
          recvPhone: $('#recvPhone').value.trim(),
        },
        memo: $('#memo').value.trim(),
        status: '결제대기'  // 관리자가 승인/계좌 안내/입금확인 진행
      };
      // 기존 목록 불러와 append → 다시 저장 (관리자 모듈과 동일 저장형식)
      const all = await fetchOrdersAll();
      all.push(order);
      await saveOrdersAll(all);

      alert('주문이 등록되었습니다.');
      closeOrderPanel();
      await renderOrders(); // 즉시 새로고침
    });

    // 1:1 문의 등록
    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      if(!CURRENT_USER){ alert('로그인 세션 오류'); return; }
      const txt = $('#msgInput').value.trim();
      if(!txt) return;
      const all = await fetchInquiriesAll();
      all.push({
        id:'Q'+Date.now(),
        user: SESSION.username,
        email: CURRENT_USER.email,
        title:'1:1 문의',
        content: txt,
        date: new Date().toISOString(),
        status:'미답변'
      });
      await saveInquiriesAll(all);
      $('#msgInput').value = '';
      await renderInquiries(); // 즉시 반영
    });

    // 로그아웃
    $('#logoutBtn')?.addEventListener('click', ()=>{
      if(!confirm('로그아웃 하시겠습니까?')) return;
      try{ AdminAuth?.logout?.(); }catch(_){}
      location.href='index.html';
    });

    // 초기 렌더
    (async function init(){
      await loadCurrentUser();
      await loadGoldPrice();
      await renderOrders();
      await renderInquiries();
      // 폴링(관리자 변경 즉시 반영 체감): 6초
      setInterval(()=>{ renderOrders(); renderInquiries(); }, 6000);
    })();

  });
  </script>
</body>
</html>

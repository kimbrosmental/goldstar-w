<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>내 정보</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:860px;margin:0 auto;color:#fff;padding:10px 20px 60px;}
    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}
    .actions{display:flex;gap:10px;margin-top:14px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.3s;}
    .btn:hover{background:#00897B;}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}

    /* 상품 선택 패널 (옆으로 나오는 시트) */
    #orderPanel{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.65);align-items:stretch;justify-content:flex-end;}
    #orderPanel.show{display:flex;}
    #orderSheet{width:min(560px,96vw);background:linear-gradient(135deg,#102522 80%,#1d4d46 100%);height:100%;overflow:auto;box-shadow:0 0 32px #000;border-left:1px solid #1d4d46;transform:translateX(100%);transition:transform .28s ease;}
    #orderPanel.show #orderSheet{transform:translateX(0);}
    .sheet-body{padding:28px 22px 24px 22px;color:#fff;}
    .sheet-h{color:#FFD700;font-size:1.4em;margin:6px 0 14px;text-align:left;letter-spacing:.5px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .kpi{background:#0c1a18;border-radius:10px;padding:12px 16px;margin:10px 0;}
    .kpi .lab{color:#FFD700;font-weight:600;}
    .kpi .val{font-size:1.15em;}
    .pill{background:#004d40;color:#FFD700;border:2px solid #FFD700;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;}
    .pill-wrap{display:flex;gap:10px;flex-wrap:wrap;}
    .sheet-actions .btn{width:100%;margin-top:10px;font-size:1.08em;}
    .sheet-close{position:sticky;top:0;display:flex;justify-content:flex-end;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,0));}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><img src="img/logo.png" alt="logo"/></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">소개</a></li>
          <li><a href="index.html#section2">진행</a></li>
          <li><a href="index.html#section3">영상</a></li>
          <li><a href="index.html#section4">이력</a></li>
          <li><a href="index.html#section5">문의</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <div id="userArea" class="user-area"></div>
        <a href="index.html" class="home-icon" aria-label="홈" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;">
          <span style="font-size:30px;color:#FFD700;">🏠</span>
        </a>
        <span id="navProfileBtn" style="display:none;margin-left:12px;"><a href="profile.html" style="color:#FFD700;font-weight:bold;font-size:16px;text-decoration:none;">내정보</a></span>
        <div class="menu-btn" aria-label="메뉴" role="button" tabindex="0"><span></span><span></span><span></span></div>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" id="summaryHeader" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">내 정보</h1>
        <div id="summaryLine" style="font-size:15px;color:#eee;font-weight:500;line-height:1.4;"></div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn">주문 추가</button>
          <button class="btn" id="mockOrderBtn" style="display:none;">모의 주문 추가</button>
          <button class="btn danger" id="logoutBtn">로그아웃</button>
        </div>
      </div>

      <div class="profile-card" id="profileCard" hidden>
        <h2>회원 기본 정보</h2>
        <div class="profile-grid" id="profileGrid"></div>
      </div>

      <div class="profile-card">
        <h2>주문 내역</h2>
        <div id="ordersContainer"></div>
      </div>

      <div class="profile-card">
        <h2>1:1 문의</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="문의 내용을 입력하세요" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:90px;">보내기</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">관리자만 답변을 남길 수 있습니다.</p>
      </div>
    </div>
  </main>

  <!-- 주문 시트 -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">닫기</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">상품 주문 선택</h2>

        <div class="pill-wrap" id="productBtns"></div>

        <div class="kpi row">
          <span class="lab">총 돈수</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">리셋</button>
          </div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">공급가(원)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">총금액(공급가×돈수)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">현재가(원)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">현재가×돈수</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">차액(현재가×돈수 - 공급가×돈수)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">주문 요청</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자/유저 통합 인증 모듈(세션 확인용) -->
  <script src="/admin/auth.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    /* ---------------- 공용 UI ---------------- */
    $('.menu-btn')?.addEventListener('click', ()=>{ $('.menu-btn').classList.toggle('active'); $('.nav-links')?.classList.toggle('active'); });
    $('.home-icon')?.addEventListener('click', ()=>{ /* 세션 유지: 아무 것도 하지 않음 */ });

    /* ---------------- 세션 & 사용자 로드 ---------------- */
    let CURRENT_USER = null;    // USERS KV 기준의 정식 사용자 객체
    let SESSION      = null;    // AdminAuth.currentSession()

    async function getSessionUser() {
      // 1) AdminAuth(공용 세션) 우선
      try { SESSION = window.AdminAuth?.currentSession?.() || null; } catch(_) {}
      // 2) 세션 없고, 예전 GSApp 세션이 있으면 폴백
      if (!SESSION && window.GSApp?.currentUser) {
        const u = window.GSApp.currentUser();
        if (u?.username) SESSION = { username: u.username, role: u.role||'user' };
      }
      return SESSION;
    }

    // 관리자 users.js와 동일한 API에서 회원 목록을 받아 필터링(간단/안전)  :contentReference[oaicite:5]{index=5}
    async function fetchKVUser(username){
      try{
        const res = await fetch('/api/users', { method:'GET', cache:'no-store' });
        const json = await res.json().catch(()=>[]);
        if (Array.isArray(json)) {
          return json.find(u=>u.username===username) || null;
        }
      }catch(e){}
      return null;
    }

    function renderProfileSummary(user){
      const sum = $('#summaryLine');
      if (sum && user) sum.innerHTML = `<strong>${user.username}</strong> | ${user.name||'-'} | ${user.phone||'-'} | ${user.email||'-'}`;
    }

    function renderBaseInfo(user){
      const grid = $('#profileGrid'), card = $('#profileCard');
      if (!user) return;
      card.hidden = false; grid.innerHTML = '';
      [
        ['이름', user.name], ['아이디', user.username], ['연락처', user.phone], ['이메일', user.email],
        ['은행', user.bank||'-'], ['계좌번호', user.account||'-'],
        ['가입일', user.created ? new Date(user.created).toLocaleString('ko-KR') : '-'],
        ['권한', user.role || 'user']
      ].forEach(([l,v])=>{
        const div = document.createElement('div');
        div.className='field';
        div.innerHTML = `<label>${l}</label><span>${v||'-'}</span>`;
        grid.appendChild(div);
      });
    }

    /* ---------------- 금 시세(섹션1과 동일 소스) ---------------- */
    // security.js가 저장하는 manualGoldPrice(localStorage) 우선, 없으면 KV에서 조회  :contentReference[oaicite:6]{index=6}
    async function getCurrentGoldPrice(){
      const manual = Number(localStorage.getItem('manualGoldPrice')||'0');
      if (manual>0) return manual;
      try{
        const r = await fetch('/api/security?type=goldprice', {cache:'no-store'});
        const j = await r.json();
        const m = Number(j?.manualGoldPrice||0);
        if (m>0) return m;
        const p = Number(j?.price||0);
        if (p>0) return p;
      }catch(_){}
      return 0;
    }

    /* ---------------- 주문/문의 표시 ---------------- */
    function renderOrders(list){
      const container = $('#ordersContainer');
      if(!container) return;
      if(!Array.isArray(list) || !list.length){
        container.innerHTML = '<div class="orders-empty">없음</div>';
        return;
      }
      container.innerHTML =
        '<table class="orders-table"><thead><tr>' +
        '<th>주문번호</th><th>상품</th><th>돈수</th><th>공급가</th><th>현재가</th><th>총금액</th><th>차액</th><th>상태</th><th>일시</th>' +
        '</tr></thead><tbody>' +
        list.map(o=>`
          <tr>
            <td>${o.id||o.orderId||'-'}</td>
            <td>${o.item||'골드바'}</td>
            <td style="text-align:right;">${o.don ?? (o.qty ?? '-')}</td>
            <td style="text-align:right;">${Number(o.supplyPrice||o.supply||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.currentPrice||o.price||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.totalPrice||o.amount||0).toLocaleString('ko-KR')}</td>
            <td style="text-align:right;">${Number(o.priceDiff||0).toLocaleString('ko-KR')}</td>
            <td>${o.status||'-'}</td>
            <td>${new Date(o.ts||o.date||Date.now()).toLocaleString('ko-KR')}</td>
          </tr>`).join('') +
        '</tbody></table>';
    }

    function renderMessages(list){
      const wrap = $('#messagesWrap');
      if(!wrap) return;
      if(!Array.isArray(list) || !list.length){
        wrap.innerHTML = '<div class="orders-empty">문의가 없습니다.</div>';
        return;
      }
      wrap.innerHTML = list.slice().reverse().map(m=>`
        <div class="msg-item" style="background:#0c1a18;padding:10px 12px;border:1px solid #1e4d47;border-radius:8px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="flex:1;">${m.fromAdmin?'<strong style="color:#FFD700;">[관리자]</strong> ':''}${m.title?`<strong>${m.title}</strong> — `:''}${m.content||m.message||''}${m.answer?`<div style="margin-top:6px;color:#b2dfdb;">↳ 관리자 답변: ${m.answer}</div>`:''}</div>
            <span class="msg-status" style="font-size:11px;padding:2px 6px;border-radius:10px;background:${m.answer?'#2e7d32':(m.read?'#455a64':'#b71c1c')};color:#fff;white-space:nowrap;">${m.answer?'답변완료':(m.read?'읽음':'미읽음')}</span>
          </div>
          <div style="font-size:11px;color:#888;margin-top:4px;">${new Date(m.ts||m.date||Date.now()).toLocaleString('ko-KR')}</div>
        </div>
      `).join('');
    }

    /* ---------------- 서버 데이터 로드 ---------------- */
    async function loadOrdersForUser(username, email){
      // admin/orders.js 구조 호환: /api/orders → {data: encrypted}   :contentReference[oaicite:7]{index=7}
      try{
        const r = await fetch('/api/orders', {cache:'no-store'});
        const j = await r.json();
        let arr = [];
        if (j?.data && window.decrypt) {
          try { arr = await window.decrypt(j.data) || []; } catch(_) { arr = []; }
        } else if (Array.isArray(j)) { arr = j; }
        // 다양한 키로 사용자 매칭
        return arr.filter(o => (o.username===username) || (o.user===username) || (o.email && o.email===email));
      }catch(_){ return []; }
    }
    async function loadInquiriesForUser(username, email){
      // admin/inquiries.js 구조 호환: /api/inquiries → {data: encrypted}   :contentReference[oaicite:8]{index=8}
      try{
        const r = await fetch('/api/inquiries', {cache:'no-store'});
        const j = await r.json();
        let arr = [];
        if (j?.data && window.decrypt) {
          try { arr = await window.decrypt(j.data) || []; } catch(_) { arr = []; }
        } else if (Array.isArray(j)) { arr = j; }
        return arr
          .filter(q => (q.user===username || q.user===email))
          .map(q => ({ id:q.id, content:q.content, title:q.title, answer:q.answer, read:!!q.answer, fromAdmin:false, ts:q.date }));
      }catch(_){ return []; }
    }

    async function boot(){
      const sess = await getSessionUser();
      if (!sess || !sess.username) {
        // 로그인 안된 경우에만 안내
        if (confirm('로그인이 필요합니다. 로그인 페이지로 이동할까요?')) location.href='login.html';
        return;
      }
      // 관리자면 프로필 대신 관리자 페이지로
      if (sess.role==='admin') { location.href='admin/index.html'; return; }

      const kvUser = await fetchKVUser(sess.username);
      CURRENT_USER = kvUser || { username: sess.username, role:'user' }; // 최소 보장
      // 네비 버튼
      $('#navProfileBtn').style.display = 'inline-block';

      // 기본 정보 & 요약
      renderBaseInfo(CURRENT_USER);
      renderProfileSummary(CURRENT_USER);

      // 주문/문의 불러오기 (서버 + 로컬 폴백 병합)
      const ordersFromServer = await loadOrdersForUser(CURRENT_USER.username, CURRENT_USER.email);
      const localOrders = Array.isArray(CURRENT_USER.orders)? CURRENT_USER.orders : [];
      renderOrders([...(ordersFromServer||[]), ...(localOrders||[])]);

      const inqFromServer = await loadInquiriesForUser(CURRENT_USER.username, CURRENT_USER.email);
      const localMsgs = Array.isArray(CURRENT_USER.messages)? CURRENT_USER.messages : [];
      renderMessages([...(inqFromServer||[]), ...(localMsgs||[])]);

      // 언어 적용(있으면)
      try{ window.GSApp?.applyLang?.(); }catch(_){}
    }

    /* ---------------- 주문 시트 로직 ---------------- */
    const productList = [0.5,1,2,3,5,10];
    let totalDon = 0;
    let supplyPrice = 520000;
    let currentPrice = 0; // index.html과 동일 소스에서 로드

    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }

    function updateOrderCalc(){
      $('#totalDon').textContent      = totalDon;
      $('#supplyPrice').textContent   = Number(supplyPrice).toLocaleString('ko-KR');
      $('#currentPrice').textContent  = Number(currentPrice).toLocaleString('ko-KR');
      const totalPrice   = totalDon * supplyPrice;
      const currentTotal = totalDon * currentPrice;
      $('#totalPrice').textContent   = totalPrice.toLocaleString('ko-KR');
      $('#currentTotal').textContent = currentTotal.toLocaleString('ko-KR');
      $('#priceDiff').textContent    = (currentTotal - totalPrice).toLocaleString('ko-KR');
    }

    // 시트 버튼들
    $('#addOrderBtn')?.addEventListener('click', async ()=>{
      // 현재가 동기화: index 섹션1과 같은 소스에서 가져옴
      currentPrice = await getCurrentGoldPrice();
      openOrderPanel();
      updateOrderCalc();
    });
    $('#closeOrderPanel')?.addEventListener('click', closeOrderPanel);
    $('#resetDon')?.addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    // 상품 버튼 렌더
    const btnWrap = $('#productBtns');
    btnWrap.innerHTML = '';
    productList.forEach(don=>{
      const b = document.createElement('button');
      b.className = 'pill';
      b.textContent = `${don}돈`;
      b.addEventListener('click', ()=>{ totalDon += don; updateOrderCalc(); });
      btnWrap.appendChild(b);
    });

    // 주문 저장(단건 POST 지원 → 그대로 / 미지원 → admin 구조로 폴백 저장)  :contentReference[oaicite:9]{index=9}
    async function saveOrderForUser(order){
      // 1) 단건 시도
      try{
        const r = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userOrder: order }) });
        if (r.ok) return true;
      }catch(_){}
      // 2) admin 구조 폴백(전체 배열 암호화 저장)
      try{
        const r1 = await fetch('/api/orders'); const j1 = await r1.json();
        let arr = [];
        if (j1?.data && window.decrypt) { try{ arr = await window.decrypt(j1.data)||[]; }catch(_){ arr=[]; } }
        else if (Array.isArray(j1)) { arr = j1; }
        // admin 구조 최소 필드도 같이 넣어 호환
        arr.push({ id: order.id, date: new Date(order.ts).toISOString(), user: CURRENT_USER.username, amount: order.totalPrice, status: '결제대기', memo: 'user-order', ...order });
        const enc = window.encrypt ? await window.encrypt(arr) : null;
        if (enc){
          const r2 = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ data: enc }) });
          return r2.ok;
        }
      }catch(_){}
      return false;
    }

    $('#orderSubmit')?.addEventListener('click', async ()=>{
      if (totalDon <= 0) return alert('상품을 선택하세요.');
      if (!CURRENT_USER) return alert('로그인이 필요합니다.');

      const order = {
        id:'O'+Date.now(),
        username:CURRENT_USER.username, name:CURRENT_USER.name, phone:CURRENT_USER.phone, email:CURRENT_USER.email,
        don: totalDon,
        supplyPrice, currentPrice,
        totalPrice: totalDon * supplyPrice,
        currentTotal: totalDon * currentPrice,
        priceDiff: (totalDon * currentPrice) - (totalDon * supplyPrice),
        status: '주문 승인 대기',
        ts: Date.now()
      };

      const ok = await saveOrderForUser(order);
      if (!ok) { alert('주문 저장에 실패했습니다. 잠시 후 다시 시도해주세요.'); return; }

      alert('주문이 등록되었습니다.');
      closeOrderPanel();
      // 최신 내역 재로드
      const ordersFromServer = await loadOrdersForUser(CURRENT_USER.username, CURRENT_USER.email);
      renderOrders(ordersFromServer);
    });

    /* ---------------- 1:1 문의 저장 ---------------- */
    async function saveInquiryForUser(record){
      // 1) 단건 시도
      try{
        const r = await fetch('/api/inquiries', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userInquiry: record }) });
        if (r.ok) return true;
      }catch(_){}
      // 2) admin 구조 폴백(전체 배열 암호화 저장)  :contentReference[oaicite:10]{index=10}
      try{
        const r1 = await fetch('/api/inquiries'); const j1 = await r1.json();
        let arr = [];
        if (j1?.data && window.decrypt) { try{ arr = await window.decrypt(j1.data)||[]; }catch(_){ arr=[]; } }
        else if (Array.isArray(j1)) { arr = j1; }
        arr.push(record);
        const enc = window.encrypt ? await window.encrypt(arr) : null;
        if (enc){
          const r2 = await fetch('/api/inquiries', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ data: enc }) });
          return r2.ok;
        }
      }catch(_){}
      return false;
    }

    $('#sendMsgBtn')?.addEventListener('click', async ()=>{
      if (!CURRENT_USER) return alert('로그인이 필요합니다.');
      const txt = $('#msgInput').value.trim();
      if (!txt) return;
      const rec = {
        id:'Q'+Date.now(),
        user: CURRENT_USER.username || CURRENT_USER.email,
        title:'사용자 문의',
        content: txt,
        date: new Date().toISOString(),
        status:'미답변'
      };
      const ok = await saveInquiryForUser(rec);
      if (!ok) { alert('문의 저장에 실패했습니다.'); return; }
      $('#msgInput').value = '';
      const list = await loadInquiriesForUser(CURRENT_USER.username, CURRENT_USER.email);
      renderMessages(list);
    });

    /* ---------------- 로그아웃 ---------------- */
    $('#logoutBtn')?.addEventListener('click', ()=>{
      if (!confirm('로그아웃 하시겠습니까?')) return;
      try{ window.AdminAuth?.logout?.(); }catch(_){}
      try{ window.GSApp?.logout?.(); }catch(_){}
      try{ localStorage.removeItem('gs_user'); }catch(_){}
      location.href='index.html';
    });

    /* ---------------- 시작 ---------------- */
    boot();
  });
  </script>
</body>
</html>

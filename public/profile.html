<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/api-rewrite.js" defer></script>
  <script src="/config.js" defer></script>
  <script src="/admin/auth.js" defer></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë‚´ ì •ë³´</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{padding-top:100px;}
    .profile-wrapper{max-width:1600px;margin:0 auto;color:#fff;padding:10px 20px 80px;}

    .profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .profile-card{background:#102522;border:1px solid #1d4d46;padding:28px 30px;border-radius:18px;margin-bottom:40px;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .profile-card h2{font-size:22px;margin-bottom:16px;color:#FFD700;}

    /* íšŒì› ê¸°ë³¸ ì •ë³´: ë°˜ì‘í˜• */
    .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
    .field{background:#0c1a18;padding:14px 16px;border-radius:10px;min-width:0;}
    .field label{display:block;font-size:12px;color:#90a4ae;letter-spacing:.5px;margin-bottom:4px;}
    .field span{font-weight:600;font-size:15px;word-break:break-word;overflow-wrap:anywhere;}

    @media (max-width:1024px){ .profile-wrapper{padding:10px 16px 64px;} }
    @media (max-width:720px){ .profile-card{padding:22px;} .actions{flex-wrap:wrap;} }
    @media (max-width:480px){ .profile-card{padding:18px;} }

    /* ì£¼ë¬¸ ë‚´ì—­: ë°˜ì‘í˜• í…Œì´ë¸” */
    .table-responsive{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .orders-table{width:100%;border-collapse:collapse;margin-top:10px;min-width:720px;}
    .orders-table th,.orders-table td{border:1px solid #1e4d47;padding:10px 12px;font-size:14px;}
    .orders-table th{background:#004d40;color:#FFD700;}
    .orders-empty{color:#bbb;font-size:14px;margin-top:8px;}

    @media (max-width:760px){
      .orders-table{min-width:0;border:0;}
      .orders-table thead{display:none;}
      .orders-table, .orders-table tbody, .orders-table tr, .orders-table td{display:block;width:100%;}
      .orders-table tr{
        margin:0 0 12px;border:1px solid #1e4d47;border-radius:12px;overflow:hidden;background:#0c1a18;cursor:pointer;
      }
      .orders-table td{border:none;border-bottom:1px solid #113a35;position:relative;padding-left:44%;min-height:44px;}
      .orders-table td:last-child{border-bottom:none;}
      .orders-table td::before{
        content:attr(data-label);position:absolute;left:12px;top:10px;width:40%;
        white-space:nowrap;font-size:12px;color:#90a4ae;font-weight:600;
      }
    }

    .actions{display:flex;gap:10px;margin-top:14px;}
    .btn{background:#00695C;color:#fff;padding:10px 16px;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:.25s;will-change:transform,box-shadow;}
    .btn:hover{background:#00897B;transform:translateY(-2px) scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25);}
    .danger{background:#b71c1c;}
    .danger:hover{background:#d32f2f;}
    .pill{ background:#004d40; color:#FFD700; border:2px solid #FFD700; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.25s; }
    .pill:hover{ transform:translateY(-2px) scale(1.04); box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 2px rgba(255,215,0,.25); }

    /* íŒ¨ë„ */
    #orderPanel, #orderDetailPanel{ position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,0.65); align-items:stretch; justify-content:flex-end; }
    #orderPanel.show, #orderDetailPanel.show{ display:flex; }
    #orderSheet, #orderDetailSheet{ width:min(720px, 96vw); background:linear-gradient(135deg,#102522 80%,#1d4d46 100%); height:100%; overflow:auto; box-shadow:0 0 32px #000; border-left:1px solid #1d4d46; transform:translateX(100%); transition:transform .28s ease; }
    #orderPanel.show #orderSheet, #orderDetailPanel.show #orderDetailSheet{ transform:translateX(0); }
    .sheet-close{ position:sticky; top:0; display:flex; justify-content:flex-end; padding:12px; background:linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,0)); }
    .sheet-body{ padding:8px 22px 24px 22px; color:#fff; }
    .sheet-h{ color:#FFD700; font-size:1.4em; margin:8px 0 14px; text-align:left; letter-spacing:.5px; }

    .kpi{ background:#0c1a18; border-radius:10px; padding:12px 16px; margin:10px 0; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .lab{ color:#FFD700; font-weight:600; }
    .val{ font-size:1.15em; }

    .pill-wrap{ display:flex; gap:10px; flex-wrap:wrap; }

    /* ì£¼ì†Œ í¼ */
    .addr-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px 14px; margin-top:12px; align-items:start; }
    .addr-grid label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:#FFD700; font-weight:700; background:#0c1a18; padding:12px 14px; border-radius:10px; }
    .addr-grid input, .addr-grid textarea{ width:100%; font-size:14px; padding:10px 12px; border-radius:8px; border:1px solid #1e4d47; background:#071412; color:#fff; box-sizing:border-box; }
    .addr-row{ display:flex; gap:8px; align-items:center; }
    .addr-row input{ flex:1; }
    .addr-help{ font-size:12px; color:#9bd3ff; margin-top:4px; }

    .sheet-actions .btn{ width:100%; margin-top:12px; font-size:1.08em; }

    .home-icon{display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;}
    .home-icon span{font-size:30px;color:#FFD700;}

    .mini-hint{font-size:12px;color:#9bd3ff;margin:8px 0 0;display:none;}
    .mini-err{font-size:12px;color:#ff9b9b;margin:8px 0 0;display:none;}

    /* ë¬¸ì˜ ì¹´ë“œ */
    .msg-item{background:#0c1a18;border:1px solid #1e4d47;border-radius:8px;margin-bottom:10px;cursor:pointer;}
    .msg-hd{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;}
    .msg-text{padding:0 12px 10px 12px;}
    .msg-answer{display:none;padding:0 12px 12px;}
    .msg-item.open .msg-answer{display:block;}
    .msg-status{font-size:11px;padding:2px 6px;border-radius:10px;color:#fff;white-space:nowrap;}
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="container">
      <div class="logo"><a href="index.html" id="homeLogo"><img src="img/logo.png" alt="ê³¨ë“œìŠ¤íƒ€ ë¡œê³ " style="height:52px;"></a></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li><a href="index.html#section1">ì†Œê°œ</a></li>
          <li><a href="index.html#section2">ì§„í–‰</a></li>
          <li><a href="index.html#section3">ì˜ìƒ</a></li>
          <li><a href="index.html#section4">ì´ë ¥</a></li>
          <li><a href="index.html#section5">ë¬¸ì˜</a></li>
        </ul>
      </div>
      <div class="nav-right">
        <a href="index.html" class="home-icon" aria-label="í™ˆ"><span>ğŸ </span></a>
      </div>
    </div>
  </nav>

  <main>
    <div class="profile-wrapper">
      <div class="profile-header" style="flex-direction:column;align-items:flex-start;gap:8px;">
        <h1 style="font-size:30px;color:#4fc3f7;">ë‚´ ì •ë³´</h1>
        <div id="sessionHint" class="mini-hint">ì„¸ì…˜ í™•ì¸ ì¤‘â€¦</div>
        <div class="actions" style="margin-top:4px;">
          <button class="btn" id="addOrderBtn">ì£¼ë¬¸ ì¶”ê°€</button>
          <button class="btn danger" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- íšŒì› ê¸°ë³¸ ì •ë³´ -->
      <div class="profile-card" id="profileCard">
        <h2>íšŒì› ê¸°ë³¸ ì •ë³´</h2>
        <div class="profile-grid" id="profileGrid">
          <div class="field"><label>ì´ë¦„</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ì•„ì´ë””</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ì—°ë½ì²˜</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ì´ë©”ì¼</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ì€í–‰</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ê³„ì¢Œë²ˆí˜¸</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ê°€ì…ì¼</label><span>ë¡œë”© ì¤‘â€¦</span></div>
          <div class="field"><label>ìƒíƒœ</label><span>ë¡œë”© ì¤‘â€¦</span></div>
        </div>
      </div>

      <!-- ì£¼ë¬¸ ë‚´ì—­ -->
      <div class="profile-card">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <div class="table-responsive">
          <table class="orders-table">
            <thead>
              <tr>
                <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                <th>ìƒí’ˆ</th>
                <th>ëˆìˆ˜</th>
                <th>ê³µê¸‰ê°€(ì›)</th>
                <th>ì´ê¸ˆì•¡(ì›)</th>
                <th>ì…ê¸ˆê¸ˆì•¡(50%)</th>
                <th>ìƒíƒœ</th>
                <th>ì¼ì‹œ</th>
              </tr>
            </thead>
            <tbody id="ordersContainer">
              <tr><td colspan="8" style="text-align:center">ë¡œë”© ì¤‘â€¦</td></tr>
            </tbody>
          </table>
        </div>
        <div id="ordersHint" class="mini-err"></div>
      </div>

      <!-- 1:1 ë¬¸ì˜ -->
      <div class="profile-card">
        <h2>1:1 ë¬¸ì˜</h2>
        <div id="messagesWrap" style="margin-bottom:16px;"></div>
        <div id="inqHint" class="mini-err"></div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="msgInput" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-height:70px;background:#0c1a18;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:10px;font-size:14px;resize:vertical;"></textarea>
          <button class="btn" id="sendMsgBtn" style="height:70px;min-width:120px;">ë¬¸ì˜ ë“±ë¡</button>
        </div>
        <p style="margin-top:10px;font-size:12px;color:#888;">ë¬¸ì˜ ì¹´ë“œë¥¼ ëˆ„ë¥´ë©´ ê´€ë¦¬ì ë‹µë³€ì´ í¼ì³ì§‘ë‹ˆë‹¤.</p>
      </div>
    </div>
  </main>

  <!-- ì£¼ë¬¸ ìƒì„± íŒ¨ë„ -->
  <div id="orderPanel" aria-hidden="true">
    <div id="orderSheet">
      <div class="sheet-close"><button id="closeOrderPanel" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ìƒí’ˆ ì£¼ë¬¸ ì„ íƒ</h2>

        <div class="pill-wrap" id="productBtns"></div>

        <div class="kpi row">
          <span class="lab">ì´ ëˆìˆ˜</span>
          <div class="row" style="gap:10px;">
            <strong id="totalDon" class="val" style="color:#4fc3f7;">0</strong>
            <button id="resetDon" class="btn danger">ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ê³µê¸‰ê°€(ì›)</span><strong id="supplyPrice" class="val" style="color:#FFD700;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab">ì´ê¸ˆì•¡(ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="totalPrice" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€(ì›)</span><strong id="currentPrice" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="row" style="margin-top:8px;"><span class="lab" style="color:#4fc3f7;">í˜„ì¬ê°€Ã—ëˆìˆ˜</span><strong id="currentTotal" class="val" style="color:#4fc3f7;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì°¨ì•¡(í˜„ì¬ê°€Ã—ëˆìˆ˜ - ê³µê¸‰ê°€Ã—ëˆìˆ˜)</span><strong id="priceDiff" class="val" style="color:#FFD700;">-</strong></div>
        </div>

        <div class="kpi">
          <div class="row"><span class="lab">ì…ê¸ˆ ê¸ˆì•¡ (ì´ê¸ˆì•¡ì˜ 50%)</span><strong id="depositAmount" class="val" style="color:#4fc3f7;">-</strong></div>
          <div class="addr-help">(ë‚˜ë¨¸ì§€ 50%ëŠ” ë°°ì†¡ ì‹œì‘ ì „ ì…ê¸ˆ)</div>
        </div>

        <h3 class="sheet-h" style="font-size:1.15em;margin-top:14px;">ë°°ì†¡ì§€ ì •ë³´</h3>
        <div class="addr-grid">
          <label>ìˆ˜ë ¹ì¸ <input id="recvName" placeholder="ì´ë¦„" autocomplete="name"></label>
          <label>ì—°ë½ì²˜ <input id="recvPhone" placeholder="010-1234-5678" autocomplete="tel"></label>

          <label style="grid-column:1 / span 2;">ìš°í¸ë²ˆí˜¸
            <div class="addr-row">
              <input id="postCode" placeholder="ìš°í¸ë²ˆí˜¸" autocomplete="postal-code">
              <button class="btn" id="btnFindPostcode">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
              <button class="btn" id="btnManualPostcode">ì§ì ‘ ì…ë ¥</button>
            </div>
            <div class="addr-help" id="postcodeHelp" style="display:none;"></div>
          </label>

          <label style="grid-column:1 / span 2;">ì£¼ì†Œ(ë„ë¡œëª…/ì§€ë²ˆ) <input id="addr1" placeholder="ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œ" autocomplete="address-line1"></label>
          <label style="grid-column:1 / span 2;">ìƒì„¸ ì£¼ì†Œ <input id="addr2" placeholder="ë™/í˜¸ìˆ˜ ë“± ìƒì„¸" autocomplete="address-line2"></label>
          <label style="grid-column:1 / span 2;">ìš”ì²­ì‚¬í•­ <textarea id="memo" rows="3" placeholder="ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì ì–´ì£¼ì„¸ìš”"></textarea></label>
        </div>

        <div class="sheet-actions">
          <button id="orderSubmit" class="btn" style="background:#FFD700;color:#222;font-weight:700;">ì£¼ë¬¸ ìš”ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì£¼ë¬¸ ìƒì„¸ íŒ¨ë„ -->
  <div id="orderDetailPanel" aria-hidden="true">
    <div id="orderDetailSheet">
      <div class="sheet-close"><button id="closeOrderDetail" class="btn danger">ë‹«ê¸°</button></div>
      <div class="sheet-body">
        <h2 class="sheet-h">ì£¼ë¬¸ ìƒì„¸</h2>
        <div id="orderDetailBody"></div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
    const fmt = n => Number(n||0).toLocaleString('ko-KR');

    /* ===== ì„¸ì…˜ (ë¡œì»¬ ì¦‰ì‹œ + ë¹„ì°¨ë‹¨ ë³´ê°•) ===== */
    function readLS(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(_){ return null; } }
    function getSessionFast(){
      try{ if (window.AdminAuth?.currentSession) return AdminAuth.currentSession(); }catch(_){}
      try{ if (window.GSApp?.currentUser) return GSApp.currentUser(); }catch(_){}
      return readLS('admin_session_v1') || readLS('gs_user') || readLS('gs_user_backup') || null;
    }
    function deriveIdentity(s){
      const email=(s?.email||'').trim();
      const username=(s?.username||s?.user||(email?email.split('@')[0]:'')||'').trim();
      const name=(s?.name||s?.displayName||'').trim();
      const phone=(s?.phone||'').trim();
      return {username,email,name,phone};
    }
    let SESSION = getSessionFast();
    let ID = deriveIdentity(SESSION);
    const sessionHint = $('#sessionHint');
    if (ID.username) sessionHint.style.display='none';

    /* ===== ê³µí†µ fetch & íŒŒì„œ ===== */
    async function fetchJSON(url, init){
      try{
        const r = await fetch(url,{cache:'no-store', ...init});
        const ct=r.headers.get('Content-Type')||'';
        if(!r.ok) throw new Error('HTTP '+r.status);
        if(/json/i.test(ct)) return await r.json();
        const t=await r.text(); try{ return JSON.parse(t); }catch{ return t; }
      }catch(e){ return null; }
    }
    async function safeDecrypt(x){
      try{
        if (!x) return null;
        if (Array.isArray(x) || typeof x==='object') return x;
        if (typeof x==='string'){
          try{ return JSON.parse(x); }catch{}
          if (window.decrypt){
            const dec = await window.decrypt(x);
            try{ return JSON.parse(dec); }catch{ return dec; }
          }
        }
        return x;
      }catch(_){ return null; }
    }
    function unwrap(x){
      if (x==null) return null;
      if (Array.isArray(x)) return x;
      if (typeof x==='object'){
        if ('data' in x) return unwrap(x.data);
        if ('value' in x) return unwrap(x.value);
        if ('list' in x) return unwrap(x.list);
        if ('items' in x) return unwrap(x.items);
        return x;
      }
      return x;
    }
    async function getList(url){
      const j = await fetchJSON(url);
      const dec = await safeDecrypt(j);
      const u = unwrap(dec);
      return Array.isArray(u) ? u : (Array.isArray(u?.data)?u.data:[]);
    }
    async function kvGet(ns,key){
      const a = await fetchJSON(`/api/kv?ns=${encodeURIComponent(ns)}&key=${encodeURIComponent(key)}`);
      if (a!=null) return a;
      const b = await fetchJSON(`/api/kv/${encodeURIComponent(ns)}?key=${encodeURIComponent(key)}`);
      return b;
    }
    async function kvSet(ns,key,val){
      const body = JSON.stringify(val);
      const a = await fetchJSON(`/api/kv?ns=${encodeURIComponent(ns)}&key=${encodeURIComponent(key)}`, {method:'POST', headers:{'Content-Type':'application/json'}, body});
      if (a!=null) return true;
      const b = await fetchJSON(`/api/kv/${encodeURIComponent(ns)}?key=${encodeURIComponent(key)}`, {method:'POST', headers:{'Content-Type':'application/json'}, body});
      return b!=null;
    }
    function ownerKeyOf(id){ return ((id.username||'')+'|'+(id.email||'')).toLowerCase(); }

    /* ===== USERS: ìš°ì„  ì „ì—­ ë¦¬ìŠ¤íŠ¸ â†’ ì‹¤íŒ¨ ì‹œ KV ë‹¨ì¼í‚¤ ===== */
    async function loadUser(){
      // 1) /api/users (ì „ì—­ ë¦¬ìŠ¤íŠ¸)
      let users = await getList('/api/users');
      if (Array.isArray(users) && users.length){
        const uname = ID.username;
        const mail = (ID.email||'').toLowerCase();
        const found =
          users.find(u=> (u.username||'').trim()===uname) ||
          users.find(u=> mail && (u.email||'').trim().toLowerCase()===mail);
        if (found){
          applyUser(found);
          return;
        }
      }
      // 2) KV USERS (ì—¬ëŸ¬ í‚¤ í›„ë³´)
      const keys = Array.from(new Set([ID.username, ID.email, (ID.email||'').split('@')[0]].filter(Boolean)));
      for (const k of keys){
        const raw = await kvGet('USERS', k);
        const dec = await safeDecrypt(raw);
        const u = unwrap(dec);
        if (u && (u.username || u.email)){
          applyUser(u);
          return;
        }
      }
      // 3) ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì„¸ì…˜ ì •ë³´ë¡œ í‘œê¸°
      applyUser({
        username: ID.username||'-', name: ID.name||'-', email: ID.email||'-', phone: ID.phone||'-',
        bank:'', account:'', status:'-', created: Date.now()
      });
    }
    function applyUser(u){
      const norm = {
        username: (u.username || (u.email?u.email.split('@')[0]:'') || ID.username || '').trim(),
        name: (u.name || u.displayName || ID.name || '').trim(),
        email: (u.email || ID.email || '').trim(),
        phone: (u.phone || '').trim(),
        bank: u.bank || '',
        account: u.account || '',
        status: u.status || 'ì •ìƒ',
        created: u.created || u.createdAt || Date.now()
      };
      ID = { ...ID, ...norm };
      const grid = $('#profileGrid');
      const rows = [
        ['ì´ë¦„', norm.name||'-'],
        ['ì•„ì´ë””', norm.username||'-'],
        ['ì—°ë½ì²˜', norm.phone||'-'],
        ['ì´ë©”ì¼', norm.email||'-'],
        ['ì€í–‰', norm.bank||'-'],
        ['ê³„ì¢Œë²ˆí˜¸', norm.account||'-'],
        ['ê°€ì…ì¼', norm.created ? new Date(norm.created).toLocaleString('ko-KR') : '-'],
        ['ìƒíƒœ', norm.status||'-']
      ];
      grid.innerHTML = rows.map(([l,v])=> `<div class="field"><label>${l}</label><span>${v}</span></div>`).join('');
      sessionHint.style.display='none';
    }

    /* ===== ê¸ˆ ì‹œì„¸ ===== */
    const SUPPLY_PRICE = 520000;
    let marketPrice = 0;
    async function loadGoldPrice(){
      try{
        const j = await fetchJSON('/api/security?type=goldprice');
        const manual = Number(j?.manualGoldPrice||0); if (manual>0){ marketPrice = manual; return; }
      }catch(_){}
      try{
        const d = await fetchJSON('https://gold-price-proxy.hanoiosaka1.workers.dev/price');
        if (d?.price) marketPrice = Number(d.price);
      }catch(_){}
    }

    /* ===== ì£¼ë¬¸ (ì „ì—­ ë¦¬ìŠ¤íŠ¸ / KV ë‹¨ì¼í‚¤ ë‘˜ ë‹¤ ì§€ì›) ===== */
    let ORDER_MAP = Object.create(null);
    function timeString(v){
      if (v?.ts) return new Date(Number(v.ts)).toLocaleString('ko-KR');
      const c = v?.date || v?.createdAt || v?.created || v?.time || v?.timestamp;
      if (c){ const d=new Date(c); if(!isNaN(d)) return d.toLocaleString('ko-KR'); }
      return '-';
    }
    function matchMe(o){
      const uname = ID.username;
      const mail = (ID.email||'').toLowerCase();
      const ufields = [o.user,o.username,o.member,o.uid,o.userId,o.userid];
      const mfields = [o.email,o.userEmail];
      const hitUser = ufields.some(v => (v||'').toString().trim()===uname);
      const hitMail = mfields.some(v => (v||'').toString().trim().toLowerCase()===mail);
      return hitUser || (mail && hitMail);
    }
    async function loadOrders(){
      const key = ownerKeyOf(ID);
      let list = null;

      // 1) KV per-user
      const kv = await kvGet('ORDERS', key);
      const kvd = await safeDecrypt(kv);
      const kvu = unwrap(kvd);
      if (Array.isArray(kvu)) list = kvu;

      // 2) fallback: /api/orders (ì „ì—­ ë¦¬ìŠ¤íŠ¸)
      if (!Array.isArray(list) || !list.length){
        const all = await getList('/api/orders');
        if (Array.isArray(all)) list = all.filter(matchMe);
      }
      if (!Array.isArray(list)) list = [];

      const tbody = $('#ordersContainer');
      ORDER_MAP = Object.create(null);
      if (!list.length){
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">ì—†ìŒ</td></tr>';
        return;
      }
      tbody.innerHTML = list.map((o, i)=>{
        const don = Number(o.don||o.qty||0);
        const sup = Number(o.supplyPrice||SUPPLY_PRICE||0);
        const total = Number(o.totalPrice || (don*sup));
        const deposit = Math.round(total*0.5);
        const oid = o.id || o.orderId || ('row-'+i);
        ORDER_MAP[oid] = o;
        return `
          <tr data-oid="${oid}" style="cursor:pointer;">
            <td data-label="ì£¼ë¬¸ë²ˆí˜¸">${oid}</td>
            <td data-label="ìƒí’ˆ">ê³¨ë“œë°”</td>
            <td data-label="ëˆìˆ˜" style="text-align:right;">${don}</td>
            <td data-label="ê³µê¸‰ê°€(ì›)" style="text-align:right;">${fmt(sup)}</td>
            <td data-label="ì´ê¸ˆì•¡(ì›)" style="text-align:right;">${fmt(total)}</td>
            <td data-label="ì…ê¸ˆê¸ˆì•¡(50%)" style="text-align:right;">${fmt(deposit)}</td>
            <td data-label="ìƒíƒœ">${o.status||'-'}</td>
            <td data-label="ì¼ì‹œ">${timeString(o)}</td>
          </tr>
        `;
      }).join('');
    }
    function openOrderDetail(order){
      const body = $('#orderDetailBody');
      const don = Number(order.don||order.qty||0);
      const sup = Number(order.supplyPrice||SUPPLY_PRICE||0);
      const total = Number(order.totalPrice || (don*sup));
      const deposit = Math.round(total*0.5);
      const addr = order.address || {};
      body.innerHTML = `
        <div class="kpi">
          <div class="row"><span class="lab">ì£¼ë¬¸ë²ˆí˜¸</span><span class="val">${order.id||order.orderId||'-'}</span></div>
          <div class="row"><span class="lab">ì¼ì‹œ</span><span class="val">${timeString(order)}</span></div>
          <div class="row"><span class="lab">ìƒíƒœ</span><span class="val">${order.status||'-'}</span></div>
        </div>
        <div class="kpi">
          <div class="row"><span class="lab">ìƒí’ˆ</span><span class="val">ê³¨ë“œë°”</span></div>
          <div class="row"><span class="lab">ëˆìˆ˜</span><span class="val">${don}</span></div>
          <div class="row"><span class="lab">ê³µê¸‰ê°€</span><span class="val">${fmt(sup)} ì›</span></div>
          <div class="row"><span class="lab">ì´ê¸ˆì•¡</span><span class="val">${fmt(total)} ì›</span></div>
          <div class="row"><span class="lab">ì…ê¸ˆ(50%)</span><span class="val">${fmt(deposit)} ì›</span></div>
        </div>
        <h3 class="sheet-h" style="font-size:1.15em;margin-top:10px;">ìˆ˜ë ¹/ë°°ì†¡ ì •ë³´</h3>
        <div class="kpi">
          <div class="row"><span class="lab">ìˆ˜ë ¹ì¸</span><span class="val">${addr.recvName||order.recvName||'-'}</span></div>
          <div class="row"><span class="lab">ì—°ë½ì²˜</span><span class="val">${addr.recvPhone||order.recvPhone||'-'}</span></div>
          <div class="row"><span class="lab">ìš°í¸ë²ˆí˜¸</span><span class="val">${addr.postCode||addr.zip||'-'}</span></div>
          <div class="row"><span class="lab">ì£¼ì†Œ</span><span class="val">${addr.addr1||addr.address1||'-'}</span></div>
          <div class="row"><span class="lab">ìƒì„¸ì£¼ì†Œ</span><span class="val">${addr.addr2||addr.address2||'-'}</span></div>
          <div class="row"><span class="lab">ìš”ì²­ì‚¬í•­</span><span class="val">${order.memo||'-'}</span></div>
        </div>
      `;
      $('#orderDetailPanel').classList.add('show');
    }

    /* ===== 1:1 ë¬¸ì˜ (ì „ì—­ ë¦¬ìŠ¤íŠ¸ / KV ë‹¨ì¼í‚¤) ===== */
    function msgText(m){ return (m.content||m.message||m.text||m.body||m.msg||m.description||'').toString(); }
    function firstAnswer(m){
      if (m.answer || m.adminAnswer || m.reply || m.adminReply || m.response) return (m.answer || m.adminAnswer || m.reply || m.adminReply || m.response);
      if (Array.isArray(m.replies) && m.replies.length) return (m.replies[0]?.content || m.replies[0]?.text || m.replies[0]?.body || '');
      return '';
    }
    async function loadInquiries(){
      const key = ownerKeyOf(ID);
      let list = null;

      // 1) KV per-user
      const kv = await kvGet('INQUIRIES', key);
      const kvd = await safeDecrypt(kv);
      const kvu = unwrap(kvd);
      if (Array.isArray(kvu)) list = kvu;

      // 2) fallback: /api/inquiries (ì „ì—­ ë¦¬ìŠ¤íŠ¸)
      if (!Array.isArray(list) || !list.length){
        const all = await getList('/api/inquiries');
        if (Array.isArray(all)) list = all.filter(matchMe);
      }
      if (!Array.isArray(list)) list = [];

      const wrap = $('#messagesWrap');
      if (!list.length){ wrap.innerHTML = '<div class="orders-empty">ë‚´ 1:1 ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      wrap.innerHTML = list.slice().reverse().map(m=>{
        const ans = firstAnswer(m);
        const hasAnswer = !!ans;
        const status = hasAnswer ? 'ë‹µë³€ì™„ë£Œ' : (m.status || 'ë¯¸ë‹µë³€');
        return `
          <div class="msg-item" data-qid="${m.id||m.qid||m.ts||''}">
            <div class="msg-hd">
              <div style="font-weight:600;display:flex;gap:8px;align-items:center;">
                <span>${m.title||'1:1 ë¬¸ì˜'}</span>
                <small style="color:#9ab;opacity:.9">${timeString(m)}</small>
              </div>
              <span class="msg-status" style="background:${status==='ë‹µë³€ì™„ë£Œ'?'#2e7d32':(status==='ë¯¸ë‹µë³€'?'#b71c1c':'#455a64')}">${status}</span>
            </div>
            <div class="msg-text">${msgText(m).replace(/\n/g,'<br>')}</div>
            <div class="msg-answer">
              ${ hasAnswer ? `<div style="margin-top:0;padding:8px 10px;background:#08221f;border:1px solid #1e4d47;border-radius:8px;"><strong style="color:#FFD700;">[ë‹µë³€]</strong> ${ans}</div>` : '' }
            </div>
          </div>
        `;
      }).join('');
    }

    /* ===== ì£¼ë¬¸ ìƒì„± íŒ¨ë„ ===== */
    const SUP = SUPPLY_PRICE;
    let market = 0;
    async function loadPrice(){ await loadGoldPrice(); market = marketPrice; }

    const productList=[0.5,1,2,3,5,10];
    let totalDon=0;
    function updateOrderCalc(){
      $('#totalDon').textContent = totalDon;
      $('#supplyPrice').textContent = fmt(SUP);
      $('#currentPrice').textContent = fmt(market||0);
      const totalPrice   = totalDon * SUP;
      const currentTotal = totalDon * (market||0);
      $('#totalPrice').textContent   = fmt(totalPrice);
      $('#currentTotal').textContent = fmt(currentTotal);
      $('#priceDiff').textContent    = fmt(currentTotal - totalPrice);
      const okAddr = ($('#postCode').value.trim() && $('#addr1').value.trim());
      $('#orderSubmit').disabled = !(totalDon>0 && okAddr);
    }
    function openOrderPanel(){ $('#orderPanel').classList.add('show'); totalDon=0; updateOrderCalc(); loadPrice().then(updateOrderCalc); }
    function closeOrderPanel(){ $('#orderPanel').classList.remove('show'); }
    (function makeDonButtons(){
      const wrap=$('#productBtns'); wrap.innerHTML='';
      productList.forEach(d=>{
        const b=document.createElement('button'); b.className='pill'; b.textContent=`${d}ëˆ`;
        b.addEventListener('click', ()=>{ totalDon+=d; updateOrderCalc(); });
        wrap.appendChild(b);
      });
    })();

    let postcodeManual=false;
    async function ensureDaumPostcodeScript(){
      if(window.daum && window.daum.Postcode) return true;
      return new Promise(res=>{
        const s=document.createElement('script'); s.src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
      });
    }
    async function openPostcode(){
      $('#postcodeHelp').style.display='none';
      if(postcodeManual){ alert('ì§ì ‘ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤.'); return; }
      const ok = await ensureDaumPostcodeScript();
      if(!ok){ $('#postcodeHelp').style.display='block'; $('#postcodeHelp').textContent='ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨. í•„ìš” ì‹œ ì§ì ‘ ì…ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.'; return; }
      new daum.Postcode({
        oncomplete: function(data){
          $('#postCode').value = data.zonecode||''; $('#addr1').value = data.roadAddress || data.jibunAddress || ''; updateOrderCalc();
        }
      }).open();
    }
    $('#btnFindPostcode').addEventListener('click', openPostcode);
    $('#btnManualPostcode').addEventListener('click', ()=>{ postcodeManual=!postcodeManual; $('#btnManualPostcode').textContent = postcodeManual?'ìë™ê²€ìƒ‰ ì‚¬ìš©':'ì§ì ‘ ì…ë ¥'; });

    ['postCode','addr1','addr2','recvName','recvPhone','memo'].forEach(id=> $('#'+id).addEventListener('input', updateOrderCalc));

    /* ===== ì´ë²¤íŠ¸ ===== */
    $('#addOrderBtn').addEventListener('click', openOrderPanel);
    $('#closeOrderPanel').addEventListener('click', closeOrderPanel);
    $('#resetDon').addEventListener('click', ()=>{ totalDon=0; updateOrderCalc(); });

    $('#orderSubmit').addEventListener('click', async ()=>{
      if (!ID.username){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='login.html'; return; }
      const order = {
        id:'O'+Date.now(),
        user: ID.username, username: ID.username, email: ID.email, phone: ID.phone,
        ts: Date.now(), date: new Date().toISOString(),
        don: totalDon, supplyPrice: SUP, currentPrice: market,
        totalPrice: totalDon*SUP, depositAmount: Math.round(totalDon*SUP*0.5),
        address:{
          postCode: $('#postCode').value.trim(),
          addr1: $('#addr1').value.trim(),
          addr2: $('#addr2').value.trim(),
          recvName: $('#recvName').value.trim(),
          recvPhone: $('#recvPhone').value.trim()
        },
        memo: $('#memo').value.trim(),
        status:'ê²°ì œëŒ€ê¸°'
      };
      const key = ownerKeyOf(ID);
      // 1) KV per-userì— ì €ì¥ ì‹œë„
      let ok = await (async ()=>{ 
        const cur = await kvGet('ORDERS', key); 
        let list = unwrap(await safeDecrypt(cur));
        if (!Array.isArray(list)) list = [];
        list.push(order);
        return await kvSet('ORDERS', key, list);
      })();
      // 2) ì‹¤íŒ¨ ì‹œ /api/orders ì „ì—­ ë¦¬ìŠ¤íŠ¸ë¡œ ë°±ì—… ì €ì¥
      if (!ok){
        try{
          const all = await getList('/api/orders');
          const list = Array.isArray(all) ? all : [];
          const enc = window.encrypt ? await window.encrypt(list.concat(order)) : list.concat(order);
          await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:enc})});
          ok = true;
        }catch(_){}
      }
      if (!ok){ alert('ì£¼ë¬¸ ì €ì¥ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); return; }
      alert('ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeOrderPanel();
      await loadOrders();
    });

    $('#ordersContainer').addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const oid = tr.dataset.oid; const o = ORDER_MAP[oid]; if (o) openOrderDetail(o);
    });
    $('#closeOrderDetail').addEventListener('click', ()=> $('#orderDetailPanel').classList.remove('show'));
    $('#orderDetailPanel').addEventListener('click', (e)=>{ if(e.target.id==='orderDetailPanel') $('#orderDetailPanel').classList.remove('show'); });

    $('#sendMsgBtn').addEventListener('click', async ()=>{
      if (!ID.username){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='login.html'; return; }
      const txt = $('#msgInput').value.trim(); if(!txt) return;
      const key = ownerKeyOf(ID);

      // 1) KV per-user append
      let ok = await (async ()=>{
        const cur = await kvGet('INQUIRIES', key);
        let list = unwrap(await safeDecrypt(cur));
        if (!Array.isArray(list)) list = [];
        list.push({ id:'Q'+Date.now(), user:ID.username, username:ID.username, email:ID.email, phone:ID.phone,
          ts: Date.now(), date: new Date().toISOString(), title:'1:1 ë¬¸ì˜', content: txt, status:'ë¯¸ë‹µë³€', replies:[] });
        return await kvSet('INQUIRIES', key, list);
      })();

      // 2) ì‹¤íŒ¨ ì‹œ ì „ì—­ ë¦¬ìŠ¤íŠ¸ ë°±ì—… ì €ì¥
      if (!ok){
        try{
          const all = await getList('/api/inquiries');
          const list = Array.isArray(all)?all:[];
          const item={ id:'Q'+Date.now(), user:ID.username, username:ID.username, email:ID.email, phone:ID.phone,
            ts: Date.now(), date: new Date().toISOString(), title:'1:1 ë¬¸ì˜', content: txt, status:'ë¯¸ë‹µë³€', replies:[] };
          const enc = window.encrypt ? await window.encrypt(list.concat(item)) : list.concat(item);
          await fetch('/api/inquiries',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:enc})});
          ok = true;
        }catch(_){}
      }
      if (!ok){ alert('ë¬¸ì˜ ì €ì¥ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); return; }
      $('#msgInput').value = '';
      await loadInquiries();
      alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    $('#messagesWrap').addEventListener('click', (e)=>{
      const item = e.target.closest('.msg-item'); if(!item) return;
      item.classList.toggle('open'); // ê¸°ë³¸ ë³¸ë¬¸ì€ í•­ìƒ ë³´ì´ê³ , ë‹µë³€ë§Œ í† ê¸€
    });

    $('#logoutBtn').addEventListener('click', ()=>{
      if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{ AdminAuth?.logout?.(); }catch(_){}
      try{
        localStorage.removeItem('admin_session_v1');
        localStorage.removeItem('gs_user');
        localStorage.removeItem('gs_user_backup');
        localStorage.removeItem('gs_logged_in');
        localStorage.setItem('gs_logout', String(Date.now()));
      }catch(_){}
      location.href='index.html';
    });

    $('#homeLogo')?.addEventListener('click', e=>{
      e.preventDefault();
      try{
        const snap = SESSION || readLS('admin_session_v1') || readLS('gs_user') || {};
        localStorage.setItem('gs_user_backup', JSON.stringify(snap));
        localStorage.setItem('gs_logged_in','1');
      }catch(_){}
      location.href='index.html';
    });

    /* ===== ì´ˆê¸° ë¶€íŒ… ===== */
    (async function init(){
      await loadUser();   // USERS
      await loadGoldPrice();
      await Promise.all([loadOrders(), loadInquiries()]); // ORDERS / INQUIRIES

      // ë¹„ì°¨ë‹¨ ì„¸ì…˜ ë³´ê°•: ì„œë²„ê°€ ë”°ë¡œ ì„¸ì…˜ APIë¥¼ ì œê³µí•˜ë©´ ê°±ì‹ 
      (async ()=>{
        const candidates=['/api/me','/api/session','/api/auth/me','/api/user','/auth/me','/users/me','/api/profile'];
        for (const u of candidates){
          const j = await fetchJSON(u);
          if (j && (j.username || j.email)){
            const newId = deriveIdentity(j);
            if (newId.username && newId.username !== ID.username){
              ID = newId;
              await loadUser();
              await loadOrders();
              await loadInquiries();
            }
            break;
          }
        }
      })();
    })();
  });
  </script>
</body>
</html>

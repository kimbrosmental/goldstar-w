<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>관리자 페이지</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body{padding-top:100px;}
    .admin-wrap{max-width:none;width:100%;margin:0 auto;color:#fff;padding:20px 30px 80px;}
    h1{font-size:34px;margin-bottom:24px;color:#FFD700;}
    .btn{background:#00695C;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:14px;cursor:pointer;}
    .btn:hover{background:#00897B;}
    .btn.active{background:#00897B;box-shadow:0 0 0 2px rgba(255,215,0,.3) inset;}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px;}
    .right-tools{display:flex;gap:8px;align-items:center;margin-left:auto;}
    .headbar{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin:6px 0 14px;}
    #adminContent{border:1px solid #1e4d47;border-radius:12px;overflow:auto;background:#0c1a18;max-height:75vh;padding:16px;}
    .hint{color:#9ec9c3;font-size:12px;margin:8px 0 0;}
    .pill{display:inline-block;padding:2px 6px;border-radius:12px;background:#1e4d47;font-size:11px;margin-left:4px;}
    .flex{display:flex;gap:16px;flex-wrap:wrap;}
    .detail-box{background:#0c1a18;border:1px solid #1e4d47;border-radius:10px;padding:14px;}
  </style>
</head>
<body>
<nav id="navbar">
  <div class="container">
    <div class="logo"><img src="img/logo.png" alt="logo"/></div>
    <div class="nav-center">
      <ul class="nav-links">
        <li><a href="index.html#section1">소개</a></li>
        <li><a href="index.html#section2">진행</a></li>
        <li><a href="index.html#section3">영상</a></li>
        <li><a href="index.html#section4">이력</a></li>
        <li><a href="index.html#section5">문의</a></li>
      </ul>
    </div>
    <div class="nav-right">
      <div id="userArea" class="user-area"></div>
      <a href="index.html" class="home-icon" aria-label="홈" style="display:flex;align-items:center;justify-content:center;width:56px;height:56px;background:#004d40;border-radius:16px;border:2px solid #00695C;transition:.3s;text-decoration:none;"><span style="font-size:30px;color:#FFD700;">🏠</span></a>
      <div class="menu-btn" aria-label="메뉴" role="button" tabindex="0"><span></span><span></span><span></span></div>
    </div>
  </div>
</nav>
<main>
  <div class="admin-wrap">
    <h1>관리자 페이지</h1>
    <div class="headbar">
      <div class="tabs" role="tablist" aria-label="Admin Tabs">
        <button class="btn active" id="tabUsers" type="button" role="tab" aria-selected="true" style="min-width:140px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
          <span>👤</span><span data-i18n="tab_users_admin">회원 관리</span>
        </button>
        <button class="btn" id="tabOrders" type="button" role="tab" aria-selected="false" style="min-width:140px;display:inline-flex;align-items:center;justify-content:center;gap:8px;">
          <span>🧾</span><span data-i18n="section_orders_admin">주문 관리</span>
        </button>
        <button class="btn" id="tabInquiries" type="button" role="tab" aria-selected="false" style="min-width:160px;display:inline-flex;align-items:center;justify-content:center;gap:8px;position:relative;">
          <span>💬</span><span data-i18n="section_messages_admin">1:1 문의</span>
          <span id="newBadge" class="pill" style="display:none;position:absolute;top:-8px;right:-8px;background:#b71c1c;color:#fff;">NEW</span>
        </button>
      </div>
      <div class="right-tools">
        <button class="btn" id="btnChangePw" data-i18n="btn_change_admin_password">관리자 비밀번호 변경</button>
        <button class="btn danger" id="btnLogout" type="button">로그아웃</button>
        <span id="pwChangeMsg" class="hint"></span>
      </div>
    </div>
    <div id="adminContent"></div>
  </div>
</main>
<script>
// 각 영역별 HTML 템플릿
const usersHTML = `
  <h2 style=\"margin:0 0 10px;\">회원 관리</h2>
  <div id=\"adminInfo\" class=\"detail-box\" style=\"margin-bottom:14px;\"></div>
  <div class=\"flex\" style=\"align-items:flex-start;\"> ...회원관리 영역... </div>
`;
const ordersHTML = `
  <h2 style=\"margin:0 0 10px;\">주문 관리</h2>
  <div id=\"adminInfo\" class=\"detail-box\" style=\"margin-bottom:14px;\"></div>
  <div class=\"flex\" style=\"align-items:flex-start;\"> ...주문관리 영역... </div>
`;
const inquiriesHTML = `
  <h2 style=\"margin:0 0 10px;\">1:1 문의 관리</h2>
  <div id=\"adminInfo\" class=\"detail-box\" style=\"margin-bottom:14px;\"></div>
  <div class=\"flex\" style=\"align-items:flex-start;\"> ...문의관리 영역... </div>
`;
const adminContent = document.getElementById('adminContent');
function setActiveTab(tab) {
  [tabUsers, tabOrders, tabInquiries].forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
}
function showUsers() {
  setActiveTab(tabUsers);
  adminContent.innerHTML = usersHTML;
}
function showOrders() {
  setActiveTab(tabOrders);
  adminContent.innerHTML = ordersHTML;
}
function showInquiries() {
  setActiveTab(tabInquiries);
  adminContent.innerHTML = inquiriesHTML;
}
const tabUsers = document.getElementById('tabUsers');
const tabOrders = document.getElementById('tabOrders');
const tabInquiries = document.getElementById('tabInquiries');
tabUsers.addEventListener('click', showUsers);
tabOrders.addEventListener('click', showOrders);
tabInquiries.addEventListener('click', showInquiries);
showUsers();
</script>

    function setActiveTab(tab) {
      [tabUsers, tabOrders, tabInquiries].forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    }

    // 회원관리 탭
    function showUsers() {
      setActiveTab(tabUsers);
      adminContent.innerHTML = `
        <h2 style="margin:0 0 10px;">회원 관리</h2>
        <div id="adminInfo" class="detail-box" style="margin-bottom:14px;"></div>
        <div class="flex" style="align-items:flex-start;">
          <div style="flex:1;min-width:420px;">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
              <h2 style="margin:0;">회원 목록</h2>
              <button id="btnUsersRefresh" class="btn small" style="padding:6px 10px;">새로고침</button>
              <button id="btnExportCsv" class="btn small" style="padding:6px 10px;">CSV 내보내기</button>
            </div>
            <div id="usersTable" class="scroll"></div>
          </div>
          <div style="flex:1;min-width:420px;">
            <h2>상세/관리</h2>
            <div id="detail" class="detail-box" style="min-height:280px;"></div>
            <div class="toolbar">
              <button class="btn" id="btnCreateUser">회원 추가</button>
              <button class="btn" id="btnEditUser">수정</button>
              <button class="btn" id="btnSaveUser" style="display:none;">저장</button>
              <button class="btn danger" id="btnDeleteUser">삭제</button>
            </div>
            <div id="msgUser" class="subtle" style="margin-top:6px;"></div>
          </div>
        </div>
      `;
      renderAdminInfo();
      renderUsers();
      renderDetail();
      bindUserEvents();
    }

    // 회원관리 기능 변수 및 함수 복구
    let selectedEmail = null;
    let editMode = false;
    let createMode = false;

    function renderAdminInfo() {
      const box = document.getElementById('adminInfo');
      if (!box) return;
      const admin = GSApp.currentUser();
      if (!admin) { box.innerHTML = ''; return; }
      const online = admin.lastSeenAt && (Date.now() - admin.lastSeenAt < 5 * 60 * 1000);
      box.innerHTML = `
        <h3 style='margin:0 0 8px;'>관리자 정보</h3>
        <div class='detail-grid'>
          <div>아이디</div><div>${admin.username || ''}</div>
          <div>이메일</div><div>${admin.email}</div>
          <div>접속상태</div><div>${online ? '<span class="pill" style="background:#2e7d32;color:#fff;">온라인</span>' : '<span class="pill">오프라인</span>'}</div>
          <div>마지막 접속</div><div>${admin.lastLoginAt ? new Date(admin.lastLoginAt).toLocaleString('ko-KR') : '-'}</div>
          <div>최근 활동</div><div>${admin.lastSeenAt ? new Date(admin.lastSeenAt).toLocaleString('ko-KR') : '-'}</div>
          <div>접속 IP</div><div>${admin.lastLoginIP || '-'}</div>
          <div>브라우저</div><div style='white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>${admin.lastLoginUA || '-'}</div>
        </div>
      `;
    }

    function renderUsers() {
      const db = GSApp.getDB();
      const rows = Object.values(db.users).map(u => `
        <tr class='row-user ${selectedEmail === u.email ? 'selected' : ''}' data-email='${u.email}'>
          <td>${u.username || ''}</td>
          <td>${u.email}${u.role === 'admin' ? '<span class="pill">admin</span>' : ''}</td>
          <td>${u.name || ''}</td>
          <td>${u.phone || ''}</td>
          <td>${(u.orders || []).length}</td>
        </tr>
      `).join('');
      document.getElementById('usersTable').innerHTML = `<table><thead><tr><th>아이디</th><th>이메일</th><th>이름</th><th>연락처</th><th>주문수</th></tr></thead><tbody>${rows}</tbody></table>`;
      document.querySelectorAll('.row-user').forEach(tr => tr.addEventListener('click', () => {
        selectedEmail = tr.dataset.email;
        createMode = false;
        editMode = false;
        renderDetail();
        renderUsers();
        // updateDeleteVisibility();
      }));
      if (window.GSApp) GSApp.applyLang();
    }

    function renderDetail() {
      const box = document.getElementById('detail');
      if (createMode) {
        box.innerHTML = `
          <h3 style='margin:0 0 10px;'>신규 회원 추가</h3>
          <div class='detail-grid'>
            <label>아이디</label><input id='f_username' placeholder='아이디'/>
            <label>이름</label><input id='f_name' placeholder='이름'/>
            <label>이메일</label><input id='f_email' placeholder='이메일'/>
            <label>연락처</label><input id='f_phone' placeholder='연락처'/>
            <label>생년월일</label><input id='f_birth' type='date'/>
            <label>은행</label><input id='f_bank' placeholder='은행'/>
            <label>계좌</label><input id='f_account' placeholder='계좌번호'/>
            <label>비밀번호</label><input id='f_password' type='password' placeholder='비밀번호'/>
          </div>
          <button class='btn' id='btnSaveUser'>저장</button>
        `;
        document.getElementById('btnSaveUser').addEventListener('click', async () => {
          const username = document.getElementById('f_username').value.trim();
          const name = document.getElementById('f_name').value.trim();
          const email = document.getElementById('f_email').value.trim().toLowerCase();
          const phone = document.getElementById('f_phone').value.trim();
          const birth = document.getElementById('f_birth').value;
          const bank = document.getElementById('f_bank').value.trim();
          const account = document.getElementById('f_account').value.trim();
          const password = document.getElementById('f_password').value || 'temp1234';
          if (!username || !name || !email || !phone || !birth) { alert('필수 항목을 입력하세요.'); return; }
          try {
            await GSApp.signupUser({ username, name, birth, phone, email, bank, account, password });
            await GSApp.loadDB();
            createMode = false;
            selectedEmail = email;
            renderUsers();
            renderDetail();
          } catch(e) { alert(e.message || '오류'); }
        });
        return;
      }
      if (!selectedEmail) {
        box.innerHTML = `<div class='muted'>좌측에서 회원을 선택하세요.</div>`;
        return;
      }
      const db = GSApp.getDB();
      const user = db.users[selectedEmail];
      if (!user) { box.innerHTML = `<div class='muted'>회원 정보 없음</div>`; return; }
      box.innerHTML = `
        <h3 style='margin:0 0 10px;'>회원 상세</h3>
        <div class='detail-grid'>
          <label>아이디</label><div>${user.username || ''}</div>
          <label>이름</label><div>${user.name || ''}</div>
          <label>이메일</label><div>${user.email}</div>
          <label>연락처</label><div>${user.phone || ''}</div>
          <label>주문수</label><div>${(user.orders || []).length}</div>
        </div>
        <button class='btn' id='btnEditUser'>수정</button>
        <button class='btn danger' id='btnDeleteUser'>삭제</button>
      `;
      document.getElementById('btnEditUser').addEventListener('click', () => {
        editMode = true;
        renderDetail();
      });
      document.getElementById('btnDeleteUser').addEventListener('click', async () => {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        await GSApp.deleteUser(selectedEmail);
        await GSApp.saveDB();
        await GSApp.loadDB();
        selectedEmail = null;
        renderUsers();
        renderDetail();
      });
      if (editMode) {
        box.innerHTML = `
          <h3 style='margin:0 0 10px;'>회원 정보 수정</h3>
          <div class='detail-grid'>
            <label>아이디</label><input id='f_username' value='${user.username || ''}' disabled/>
            <label>이름</label><input id='f_name' value='${user.name || ''}'/>
            <label>이메일</label><input id='f_email' value='${user.email}' disabled/>
            <label>연락처</label><input id='f_phone' value='${user.phone || ''}'/>
            <label>생년월일</label><input id='f_birth' type='date' value='${user.birth || ''}'/>
            <label>은행</label><input id='f_bank' value='${user.bank || ''}'/>
            <label>계좌</label><input id='f_account' value='${user.account || ''}'/>
            <label>새 비밀번호</label><input id='f_newpw' type='password' placeholder='변경 시에만 입력'/>
          </div>
          <button class='btn' id='btnSaveUser'>저장</button>
          <button class='btn' id='btnCancelEdit'>취소</button>
        `;
        document.getElementById('btnSaveUser').addEventListener('click', async () => {
          const name = document.getElementById('f_name').value.trim();
          const phone = document.getElementById('f_phone').value.trim();
          const birth = document.getElementById('f_birth').value;
          const bank = document.getElementById('f_bank').value.trim();
          const account = document.getElementById('f_account').value.trim();
          const newPw = document.getElementById('f_newpw').value.trim();
          try {
            await GSApp.updateUser(selectedEmail, { name, phone, birth, bank, account });
            if (newPw) { await GSApp.changePassword(selectedEmail, newPw); }
            await GSApp.loadDB();
            editMode = false;
            renderUsers();
            renderDetail();
          } catch(e) { alert('수정 실패: ' + (e.message || '오류')); }
        });
        document.getElementById('btnCancelEdit').addEventListener('click', () => {
          editMode = false;
          renderDetail();
        });
      }
    }

    function bindUserEvents() {
      document.getElementById('btnUsersRefresh').addEventListener('click', async () => {
        await GSApp.loadDB();
        renderAdminInfo();
        renderUsers();
        renderDetail();
      });
      document.getElementById('btnCreateUser').addEventListener('click', () => {
        createMode = true;
        editMode = false;
        renderDetail();
      });
      document.getElementById('btnDeleteUser').addEventListener('click', async () => {
        if (!selectedEmail) return;
        const db = GSApp.getDB();
        const u = db.users[selectedEmail];
        if (u && u.role === 'admin') { alert('관리자 계정은 삭제할 수 없습니다.'); return; }
        if (!confirm('삭제하시겠습니까?')) return;
        delete db.users[selectedEmail];
        await GSApp.saveDB();
        selectedEmail = null;
        createMode = false;
        editMode = false;
        await GSApp.loadDB();
        renderUsers();
        renderDetail();
      });
      document.getElementById('btnExportCsv').addEventListener('click', () => {
        const db = GSApp.getDB();
        const rows = [['아이디','이메일','이름','연락처','생년월일','은행','계좌','권한','주문수']];
        Object.values(db.users).forEach(u => {
          rows.push([u.username||'',u.email,u.name||'',u.phone||'',u.birth||'',u.bank||'',u.account||'',u.role||'',(u.orders||[]).length]);
        });
        const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'users.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      });
    }

    // 주문관리 탭
    function showOrders() {
      setActiveTab(tabOrders);
      adminContent.innerHTML = `
        <h2 style="margin:0 0 10px;">주문 관리</h2>
        <div id="adminInfo" class="detail-box" style="margin-bottom:14px;"></div>
        <div class="flex" style="align-items:flex-start;">
          <div style="flex:1;min-width:420px;">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
              <h2 style="margin:0;">주문 목록</h2>
              <button id="btnOrdersRefresh" class="btn small" style="padding:6px 10px;">새로고침</button>
            </div>
            <div id="ordersList" class="scroll"></div>
          </div>
          <div style="flex:1;min-width:420px;">
            <h2>상세/관리</h2>
            <div id="detailOrder" class="detail-box" style="min-height:280px;"></div>
            <div class="toolbar">
              <button class="btn" id="btnCreateOrder">주문 추가</button>
              <button class="btn" id="btnEditOrder">수정</button>
              <button class="btn" id="btnSaveOrder" style="display:none;">저장</button>
              <button class="btn danger" id="btnDeleteOrder">삭제</button>
            </div>
            <div id="msgOrder" class="subtle" style="margin-top:6px;"></div>
          </div>
        </div>
      `;
      renderAdminInfo();
      renderOrders();
      renderOrderDetail();
      bindOrderEvents();
    }

    // 1:1 문의관리 탭
    function showInquiries() {
      setActiveTab(tabInquiries);
      adminContent.innerHTML = `
        <h2 style="margin:0 0 10px;">1:1 문의 관리</h2>
        <div id="adminInfo" class="panel" style="margin:0 0 12px;"></div>
        <div class="controls">
          <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="onlyUnread"> 새 문의만</label>
          <button id="btnInqRefresh" class="btn small" style="margin-left:8px;">새로고침</button>
          <span id="newCount" class="badge" style="display:none;">0</span>
        </div>
        <div class="row">
          <div class="panel list" id="userList"></div>
          <div class="panel detail">
            <div id="thread" class="thread"></div>
            <div style="margin-top:10px;display:flex;gap:8px;">
              <input id="replyEmail" type="hidden" />
              <input id="replyTo" type="hidden" />
              <textarea id="replyContent" placeholder="답변 내용" style="flex:1;min-height:72px;background:#0b1917;color:#fff;border:1px solid #1e4d47;border-radius:8px;padding:8px;"></textarea>
              <button id="markReadBtn" class="btn" style="min-width:120px;">읽음으로 표시</button>
              <button id="sendReplyBtn" class="btn">답변</button>
            </div>
          </div>
        </div>
      `;
      renderAdminInfo();
      renderList();
      bindInquiryEvents();
    }

    // 이벤트 바인딩 함수들 (각 탭별)
    function bindUserEvents() {
      document.getElementById('btnUsersRefresh').addEventListener('click', async ()=>{ await GSApp.loadDB(); renderAdminInfo(); renderUsers(); });
      document.getElementById('btnCreateUser').addEventListener('click', ()=>{ createMode=true; editMode=false; renderDetail(); });
      document.getElementById('btnEditUser').addEventListener('click', ()=>{ editMode=true; createMode=false; renderDetail(); });
      document.getElementById('btnSaveUser').addEventListener('click', async ()=>{ /* 저장 로직 */ });
      document.getElementById('btnDeleteUser').addEventListener('click', async ()=>{ /* 삭제 로직 */ });
    }
    function bindOrderEvents() {
      document.getElementById('btnOrdersRefresh').addEventListener('click', async ()=>{ await GSApp.loadDB(); renderAdminInfo(); renderOrders(); });
      document.getElementById('btnCreateOrder').addEventListener('click', ()=>{ createMode=true; editMode=false; renderOrderDetail(); });
      document.getElementById('btnEditOrder').addEventListener('click', ()=>{ editMode=true; createMode=false; renderOrderDetail(); });
      document.getElementById('btnSaveOrder').addEventListener('click', async ()=>{ /* 저장 로직 */ });
      document.getElementById('btnDeleteOrder').addEventListener('click', async ()=>{ /* 삭제 로직 */ });
    }
    function bindInquiryEvents() {
      document.getElementById('onlyUnread').addEventListener('change', renderList);
      document.getElementById('btnInqRefresh').addEventListener('click', async ()=>{ await GSApp.loadDB(); renderAdminInfo(); renderList(); });
      document.getElementById('markReadBtn').addEventListener('click', async ()=>{ /* 읽음 처리 로직 */ });
      document.getElementById('sendReplyBtn').addEventListener('click', async ()=>{ /* 답변 전송 로직 */ });
    }

    // 탭 클릭 이벤트
    tabUsers.addEventListener('click', showUsers);
    tabOrders.addEventListener('click', showOrders);
    tabInquiries.addEventListener('click', showInquiries);

    // 초기 로딩
    showUsers();

    // 관리자 비밀번호 변경/로그아웃 버튼 기능 복구
    document.getElementById('btnChangePw').addEventListener('click', async ()=>{
      const newPw = prompt('새 비밀번호를 입력하세요');
      if(!newPw) return;
      const ok = await GSApp.changeAdminPassword(newPw);
      document.getElementById('pwChangeMsg').textContent = ok ? '비밀번호가 변경되었습니다.' : '비밀번호 변경 실패';
    });
    document.getElementById('btnLogout').addEventListener('click', (e)=>{
      e.preventDefault();
      GSApp.logout();
      location.href='index.html';
    });
</script>
</body>
</html>
